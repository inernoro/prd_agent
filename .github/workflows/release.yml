name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.2.3)"
        required: true
        type: string
      ref:
        description: "Git ref to build from (branch/sha). Default: main"
        required: false
        default: "main"
        type: string
      push_latest:
        description: "Also push prdagent-server:latest (recommended only for real releases)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.ref_type == 'tag' && github.ref_name || inputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable corepack (pnpm)
        run: corepack enable

      - name: Install deps (prd-admin)
        run: |
          cd prd-admin
          pnpm install --frozen-lockfile

      - name: Build admin dist (same-origin /api)
        env:
          VITE_API_BASE_URL: ""
        run: |
          cd prd-admin
          pnpm build

      - name: Pack admin dist
        run: |
          sudo apt-get update
          sudo apt-get install -y zip
          TAG="${RELEASE_TAG}"
          (cd prd-admin/dist && zip -r "../../prd-admin-dist-${TAG}.zip" .)
          sha256sum "prd-admin-dist-${TAG}.zip" > "prd-admin-dist-${TAG}.zip.sha256"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push API image
        uses: docker/build-push-action@v6
        with:
          context: ./prd-api
          file: ./prd-api/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}/prdagent-server:${{ env.RELEASE_TAG }}

      - name: Tag latest (optional)
        if: ${{ github.event_name == 'push' || inputs.push_latest }}
        run: |
          echo "Will also push :latest in a separate build step"

      - name: Build & push API image (:latest)
        if: ${{ github.event_name == 'push' || inputs.push_latest }}
        uses: docker/build-push-action@v6
        with:
          context: ./prd-api
          file: ./prd-api/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}/prdagent-server:latest

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.RELEASE_TAG }}
          tag_name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.sha }}
          generate_release_notes: true
          files: |
            prd-admin-dist-${{ env.RELEASE_TAG }}.zip
            prd-admin-dist-${{ env.RELEASE_TAG }}.zip.sha256
            docker-compose.yml
            deploy.sh
            deploy/nginx/nginx.conf


