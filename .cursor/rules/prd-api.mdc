---
description: prd-api（.NET 后端）约束与自检
globs: prd-api/**
---

# prd-api（.NET 后端）规则

## 技术栈
- .NET 8.0 / ASP.NET Core / C# 12
- MongoDB.Driver 2.29
- StackExchange.Redis 2.8
- Serilog（日志）
- JWT Bearer Authentication
- Swashbuckle/Swagger（API 文档）
- SixLabors.ImageSharp（图片/水印处理）
- PdfPig（PDF 解析）
- Polly（重试/熔断）
- Markdig（Markdown 解析）
- Tencent QCloud COS SDK（云存储）

## 命名约定
- 类/方法: PascalCase
- 变量: camelCase
- MongoDB 集合: 全小写（users, groups, messages）
- MongoDB 字段: camelCase
- API 路径: kebab-case

## API 路由规范（强制）

### 路由分类

| 类型 | 路由前缀 | Controller 位置 | 权限控制 |
|------|----------|-----------------|----------|
| **后台管理** | `/api/{module}` | `Controllers/Api/` | 需要 `[AdminController]` 注解 |
| **前台客户端** | `/{module}` | `Controllers/` (根目录) | 普通 JWT 认证 |

### 禁止事项

- **禁止使用版本化路由**：不得使用 `/v1/`、`/v2/` 等版本号路径段
- **禁止混用风格**：新增接口必须严格遵循上述分类，不得出现 `/api/v1/xxx`

### 迁移说明

历史遗留的 `/api/v1/xxx` 接口暂时保留，但：
- 新增接口**必须**使用新规范
- 逐步将老接口迁移到正确路径

## 目录约定
- 后端分层: Api -> Core -> Infrastructure
- Prompt 模板: `Infrastructure/Prompts/Templates/`

## LLM 调度与日志（强制）

- **所有 LLM 请求必须走三级调度**：专属模型池 → 默认模型池 → 直连单模型（`ISmartModelScheduler`）。
- **唯一例外：模型实验室（ModelLab）**：允许直接选择模型用于测试，不走调度；但仍需写入 `LlmRequestContext`，且 `ModelResolutionType` 固定为 `DirectModel`。
- **禁止直接 new LLMClient**（ClaudeClient/OpenAIClient）用于业务请求；仅允许在调度器或明确的底层基础设施中创建。
- **必须写入 LlmRequestContext**：`RequestType`、`RequestPurpose`、`ModelResolutionType`、`ModelGroupId`、`ModelGroupName` 不得为空。
- **默认策略**：业务调用点先获取 `scheduledResult`，再基于其信息开启 `BeginScope`，确保日志与调度一致。

## MongoDB 约束（强制）

### ID 规范（必须遵守）
- **禁止使用 MongoDB 原生类型**（尤其是 `ObjectId`）作为任何字段的存储类型
- **禁止使用** `BsonType.ObjectId` / `StringObjectIdGenerator` / 任何会把 `_id` 写成 `ObjectId` 的序列化配置
- **禁止使用** `[BsonId]` 把业务字段（如 `Code`、`Username`）当作 `_id`
- **统一要求**：集合主键 `_id` 必须映射到 `public string Id { get; set; }`，写入值为 **Guid 字符串**（推荐 `Guid.NewGuid().ToString("N")`）
- 若业务需要唯一字段（如邀请码 `Code`），请通过 **唯一索引** 实现，而不是把它当 `_id`

## 局部前置自检（避免 CI 才爆）

当你改动了 `prd-api/**` 时，必须执行：
- `dotnet build prd-api`
