---
alwaysApply: true
description: API 协议/错误码/角色等全局契约
---

# API 全局契约

## API 路由规范（重要）

### 路由设计原则

1. **禁止版本化路由**
   - **禁止** `/v1/`、`/v2/` 等版本号路径段（规避与 OpenAI 等第三方 API 风格冲突）
   - 版本迭代通过字段扩展或新端点实现，不在路径中体现

2. **前后台路由分离**

   | 场景 | 路由前缀 | 示例 | 权限要求 |
   |------|----------|------|----------|
   | **后台管理** | `/api/{module}` | `/api/users`、`/api/mds`、`/api/authz` | 需要 `AdminController` 注解，受 RBAC 控制 |
   | **前台/客户端** | `/{module}` | `/sessions`、`/groups`、`/documents` | 普通 JWT 认证，按业务逻辑鉴权 |

3. **路由命名规范**
   - 使用 `kebab-case`（如 `/api/visual-agent/image-gen`）
   - 模块名清晰表达功能域（如 `mds`=模型管理、`authz`=权限、`dashboard`=仪表盘）

### 现有路由迁移说明

> **历史遗留**：部分老接口仍使用 `/api/v1/` 前缀，新增接口必须遵循上述规范。
> 迁移计划：逐步将 `/api/v1/xxx` 迁移为 `/api/xxx`（后台）或 `/xxx`（前台）。

## API 协议规范

- RESTful + SSE 流式响应
- 认证: Bearer JWT
- 成功响应:
  - `{ "success": true, "data": {}, "error": null }`
- 失败响应:
  - `{ "success": false, "data": null, "error": { "code": "ERROR_CODE", "message": "描述" } }`
- 写接口支持 `Idempotency-Key`

## 错误码

| 码 | HTTP | 说明 |
|---|---|---|
| INVALID_FORMAT | 400 | 格式不支持 |
| CONTENT_EMPTY | 400 | 内容为空 |
| DOCUMENT_TOO_LARGE | 413 | 文档超10MB |
| DOCUMENT_NOT_FOUND | 404 | 文档不存在（或无权/已过期的统一提示） |
| SESSION_NOT_FOUND | 404 | 会话不存在 |
| SESSION_EXPIRED | 410 | 会话已过期 |
| RATE_LIMITED | 429 | 限流 |
| UNAUTHORIZED | 401 | 未授权（未登录/Token无效/过期） |
| PERMISSION_DENIED | 403 | 无权限 |
| LLM_ERROR | 502 | LLM调用失败 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |

> 说明：
> - 以上为“全局常用码”。具体业务域（群组/附件/评论/生图等）可在对应模块文档中扩展，但应复用同一响应结构。
> - 代码侧存在更细粒度错误码（例如账号锁定、邀请码无效、附件过大、PRD评论不存在、生图 run 不存在等），需要时再下沉到 SRS 的模块章节维护。

## 角色枚举

| 角色 | 说明 |
|------|------|
| `PM` | 产品经理（可创建群组、上传PRD） |
| `DEV` | 开发（技术视角） |
| `QA` | 测试（验证视角） |
| `ADMIN` | 超管（Web后台管理） |

## 性能指标

| 指标 | 要求 |
|------|------|
| 问答首字延迟 | < 2s |
| 文档上传响应 | < 3s（10万字内） |
| 会话超时 | 30分钟 |
| LLM调用超时 | 60s，重试 <=3 次（指数退避） |
