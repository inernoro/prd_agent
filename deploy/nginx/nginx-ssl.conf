# HTTPS 配置 —— 解决 Safari 自动 HTTPS 升级导致无法访问的问题
#
# 使用方法：
#   1. 获取 SSL 证书（推荐 Let's Encrypt / certbot）
#   2. 将证书文件挂载到容器内（见 docker-compose.ssl.yml）
#   3. 替换下方 ssl_certificate / ssl_certificate_key 路径
#   4. 使用此配置替换 nginx.conf 或作为附加 conf

# HTTP → HTTPS 301 重定向
server {
  listen 80;
  server_name _;
  return 301 https://$host$request_uri;
}

# HTTPS 主配置
server {
  listen 443 ssl;
  http2 on;
  server_name _;

  # === SSL 证书路径（需替换为实际路径） ===
  ssl_certificate     /etc/nginx/ssl/fullchain.pem;
  ssl_certificate_key /etc/nginx/ssl/privkey.pem;

  # TLS 版本：Safari 要求 TLS 1.2+，推荐仅启用 1.2 和 1.3
  ssl_protocols TLSv1.2 TLSv1.3;

  # 密码套件：兼容 Safari（iOS 15+/macOS Monterey+）的现代套件
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;

  # SSL 会话缓存：减少 TLS 握手开销
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 1d;
  ssl_session_tickets off;

  # OCSP Stapling：加速证书验证（Safari 受益明显）
  ssl_stapling on;
  ssl_stapling_verify on;
  resolver 8.8.8.8 1.1.1.1 valid=300s;
  resolver_timeout 5s;

  # 安全头
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;

  # ---- 以下与 nginx.conf 相同 ----

  client_max_body_size 30m;
  absolute_redirect off;
  port_in_redirect off;

  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_min_length 256;
  gzip_comp_level 4;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    image/svg+xml
    text/event-stream;

  root /usr/share/nginx/html;
  index index.html;

  location ^~ /api/ {
    proxy_pass http://api:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    proxy_connect_timeout 3s;
    proxy_send_timeout 60s;
    proxy_buffering off;
    proxy_cache off;
    proxy_read_timeout 3600s;
    chunked_transfer_encoding on;
  }

  location ^~ /assets/ {
    try_files $uri =404;
    expires 7d;
    add_header Cache-Control "public, max-age=604800" always;
  }

  location ~* \.(?:js|css|map|png|jpg|jpeg|gif|webp|svg|ico|woff2?|json|txt)$ {
    try_files $uri =404;
    expires 7d;
    add_header Cache-Control "public, max-age=604800" always;
  }

  location / {
    try_files $uri /index.html;
  }
}
