## Doc vs Code 差异清单（生成于 2026-01-07）

> 目的：把 `doc/2.srs.md`、`doc/3.prd.md` 与当前实现的偏差“可审阅化”，并把需要你决策的冲突点单独列出。
>
> 约束：本清单仅基于仓库代码（只读抽取），不包含运行态数据；不会修改业务代码。

---

## 1) 结论摘要（高优先级）

- **产品交互主线已迁移**：从“引导讲解（guide）”迁移到 **提示词阶段（promptKey）+ Run/Worker 服务端闭环**（对话可断线恢复/可取消）。
- **管理后台能力扩展**：不再只有“用户/模型/日志/统计”，而是包含 **AI 对话、提示词管理、视觉创作 Agent、文学创作 Agent、资源管理、数据管理、实验室** 等。
- **模型配置体系升级**：演进为“平台（platform）+ 模型（model）”管理，并引入“用途模型”（主/意图/识图/生图）与 Prompt Cache 开关。
- **文档留存与日志策略存在待决策冲突**：PRD 原文落库、API 请求日志写入部分 request body（可能包含 PRD 原文片段）等，需要明确最终策略。

---

## 2) Admin（prd-admin）模块/路由（代码事实）

来源：`prd-admin/src/layouts/AppShell.tsx`（菜单）、`prd-admin/src/app/App.tsx`（路由）。

### 2.1 顶级菜单（当前实现）

- 仪表盘：`/`
- 用户管理：`/users`
- 群组管理：`/groups`
- 模型管理：`/model-manage`
- 提示词管理：`/prompts`
- AI 对话：`/ai-chat`
- 视觉创作 Agent：`/visual-agent`
- 文学创作 Agent：`/literary-agent`（文章配图，已落地状态机）
- 资源管理：`/assets`
- 请求日志：`/llm-logs`
- 数据管理：`/data`
- 实验室：`/lab`

### 2.2 与旧文档的差异

- **新增（文档缺失）**：AI 对话、提示词管理（含提示词优化）、视觉/文学创作 Agent、资源管理、数据管理、实验室。
- **变化**：模型配置不再是简单"Claude/OpenAI 二选一 + model"，而是 platform+model，多用途模型与统计面板。
- **文学创作 Agent 已落地**：包含文章配图工作流状态机（upload/editing/markersGenerated/imagesGenerating/imagesGenerated），支持提交型修改清后续、禁止跳未来阶段、历史快照（debug-only）。详见 `doc/3.prd.md` 第 4.8 节与 `doc/2.srs.md` 第 5.3 节。

---

## 3) API（prd-api）路由清单（代码事实）

以下为 Controller 的顶层 Route（便于对齐文档的“核心接口表”）。

### 3.1 用户侧 API（/api/v1/*，非 admin）

- 认证：`/api/v1/auth/*`
- 文档：`/api/v1/documents/*`
- 会话：`/api/v1/sessions/*`
- 消息（SSE）：`/api/v1/sessions/{sessionId}/messages`
- 对话 Run（闭环）：`/api/v1/sessions/{sessionId}/messages/run`、`/api/v1/chat-runs/{runId}/*`
- 群组：`/api/v1/groups/*`（含群消息 SSE：`/api/v1/groups/{groupId}/messages/stream`）
- 缺失点：`/api/v1/groups/{groupId}/gaps/*`
- 提示词下发：`/api/v1/prompts`
- 章节预览提问：`/api/v1/sessions/{sessionId}/preview-ask`
- PRD 评论：`/api/v1/prd-comments`
- 意图：`/api/v1/intent/*`
- 桌面在线：`/api/v1/desktop/presence/*`
- 桌面品牌：`/api/v1/desktop/branding`
- 资源：`/api/v1/assets/*`
- Stub（兼容/测试）：`/api/v1/stub/*`

### 3.2 管理侧 API（/api/v1/admin/* 与少量非 admin 前缀）

- Admin 用户：`/api/v1/admin/users/*`（含头像上传/解锁/角色/密码/邀请码等）
- Admin 系统提示词：`/api/v1/admin/system-prompts/*`
- Admin 提示词阶段：`/api/v1/admin/prompts/*`
- Admin 提示词优化：`/api/v1/admin/prompts/optimize/stream`
- Admin 群组：`/api/v1/admin/groups/*`
- Admin 系统 API 日志：`/api/v1/admin/api-logs/*`
- Admin LLM 日志：`/api/v1/admin/llm-logs/*`
- Admin 设置：`/api/v1/admin/settings/*`（含 desktop settings：`/api/v1/admin/settings/desktop`）
- Admin LLMConfig（旧体系仍在）：`/api/v1/admin/llm-configs/*`
- 平台（注意：当前实现 route 前缀不是 /admin）：`/api/v1/platforms/*`
- 模型（注意：当前实现 route 前缀是 /config）：`/api/v1/config/models/*`、`/api/v1/config/main-model|intent-model|vision-model|image-gen-model`
- Admin Desktop 资产：`/api/v1/admin/assets/desktop/*`
- Admin Avatar 资产：`/api/v1/admin/assets/avatars/*`
- Admin 数据：`/api/v1/admin/data/*`
- Admin 实验室：`/api/v1/admin/lab/*`、`/api/v1/admin/model-lab/*`
- Admin 生图：`/api/v1/admin/image-gen/*`
- Admin ImageMaster（视觉创作）：`/api/v1/admin/image-master/*`
- Admin 文档原文：`/api/v1/admin/documents/{documentId}/content`
- Admin 上传制品：`/api/v1/admin/upload-artifacts/*`
- Admin desktop presence：`/api/v1/admin/desktop/presence/*`

---

## 4) Desktop（prd-desktop）关键能力（代码事实）

来源：`prd-desktop/src-tauri/src/commands/session.rs`、`prd-desktop/src/components/Chat/ChatInput.tsx`、`prd-desktop/src/components/Document/PrdPreviewPage.tsx` 等。

### 4.1 对话链路（两套并存）

- 直接 SSE：`POST /api/v1/sessions/{sessionId}/messages`（invoke `send_message`）
- Run/Worker：创建 run `POST /api/v1/sessions/{sessionId}/messages/run`（invoke `create_chat_run`）+ 订阅 `GET /api/v1/chat-runs/{runId}/stream`（invoke `subscribe_chat_run`）+ 取消 `POST /api/v1/chat-runs/{runId}/cancel`

### 4.2 “提示词阶段（promptKey）”已落地

- Desktop ChatInput 顶部有“提示词”按钮条，点击后以 `promptKey` 发起“讲解式问答”。
- Admin 提示词管理支持按 PM/DEV/QA 配置阶段提示词与 system prompt，并有“优化（流式）”能力。

### 4.3 PRD 预览能力显著增强（文档缺失）

`PrdPreviewPage` 包含：目录、评论面板、引用跳转与高亮、划词问 AI、章节提问（preview-ask）、可拖拽三栏布局等。

---

## 5) 错误码与全局响应格式（代码事实）

来源：`PrdAgent.Core/Models/ApiResponse.cs`

- **统一响应**：`{ success, data, error }`（与现有规则契约一致）
- **错误码集合**：在文档已有基础上，新增/细化：
  - `DOCUMENT_NOT_FOUND`、`UNAUTHORIZED`、`ACCOUNT_LOCKED`、`WEAK_PASSWORD`、`PRD_COMMENT_NOT_FOUND`、`IMAGE_GEN_RUN_NOT_FOUND` 等

> 建议后续将 `doc/2.srs.md` 的错误码表更新为“以代码为准”的列表，并标注 HTTP 映射策略（当前部分接口会用 401/403/404/413/429/5xx）。

---

## 6) 待决策冲突点（需要你拍板）

### C1. 是否保留“引导讲解（guide）”作为产品能力？

- 文档：有 guide 模式与 guide 控制接口。
- 代码：更偏“提示词阶段 + Run/Worker”，且后端注释写明“引导讲解体系已删除”。

**你需要决定**：PRD/SRS 是否改写为“提示词阶段”作为标准能力（推荐），还是要求恢复 guide 体系。

### C2. PRD 原文是否允许落库？

- 文档：强调不落盘。
- 代码：`ParsedPrd.RawContent` 会落 MongoDB，并提供按群组绑定校验后的原文读取接口（用户侧与 admin 侧）。

**你需要决定**：最终策略是“严格不落库”还是“允许落库（权限/TTL/审计）”。

### C3. 系统 API 请求日志是否允许写入 request body？

- 代码：`ApiRequestLogs` 记录 request body（上限 256KB），仅对 `prompt/messages/systemPrompt` 字段做 `<omitted>`，不保证 `documents.content` 这类字段被剔除。

**你需要决定**：日志策略是否要做到“完全不存用户内容/PRD 原文”，以及允许留存的最小集合（仅元数据/哈希/长度/截断预览等）。

---

## 7) 建议你如何使用本清单

1. 先对 C1/C2/C3 给出决策方向（每项选一个策略）。
2. 我再把 `doc/2.srs.md` 与 `doc/3.prd.md` 做一次“收敛式更新”：
   - 把已废弃的内容移到“历史附录”或删除；
   - 把新主线（promptKey + run + admin 模块）写成新的基线；
   - 把日志/留存策略按你的决策固化成强约束（并同步规则文件）。

