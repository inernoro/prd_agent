# 可复用组件规格 (Reusable Component Specifications)

> 标准化的第三方工具型组件，可直接集成到任意模块。

---

## 组件一：软删除 (SoftDelete)

### 接口定义

```typescript
// 实体扩展字段
interface SoftDeletable {
  isDeleted: boolean;      // 默认 false
  deletedAt?: string;      // ISO 时间戳
  deletedBy?: string;      // 操作人 userId
}

// API 契约
type DeleteContract = (id: string) => Promise<{ deleted: boolean }>;
type ListTrashContract = (pagination?: Pagination) => Promise<{ items: T[]; total: number }>;
type RestoreContract = (id: string) => Promise<{ item: T }>;
type PermanentDeleteContract = (id: string) => Promise<{ deleted: boolean }>;
```

### 端点规范

| 方法 | 路径 | 说明 |
|------|------|------|
| DELETE | `/{resource}/{id}` | 软删除 → 设置 isDeleted=true |
| GET | `/{resource}/trash` | 回收站列表 |
| POST | `/{resource}/{id}/restore` | 恢复 |
| DELETE | `/{resource}/{id}/permanent` | 永久删除 |

### 集成要求

1. 列表查询默认添加 `filter: isDeleted = false`
2. 回收站列表按 `deletedAt DESC` 排序
3. 永久删除前校验 `isDeleted = true`

---

## 组件二：文件夹 (Folder)

### 接口定义

```typescript
interface Folder {
  id: string;
  name: string;
  color?: string;          // HEX 颜色 #RRGGBB
  icon?: string;           // 图标标识
  sortOrder: number;       // 排序权重，DESC
  spaceId?: string;        // 空间隔离键
}

interface Folderable {
  folderId?: string;       // null = 根目录
}

// API 契约
type ListFoldersContract = () => Promise<{ items: Folder[] }>;
type CreateFolderContract = (input: Omit<Folder, 'id'>) => Promise<{ folder: Folder }>;
type UpdateFolderContract = (id: string, input: Partial<Folder>) => Promise<{ folder: Folder }>;
type DeleteFolderContract = (id: string) => Promise<{ deleted: boolean }>;
type MoveToFolderContract = (id: string, folderId?: string) => Promise<{ item: T }>;
type BatchMoveContract = (ids: string[], folderId?: string) => Promise<{ movedCount: number }>;
```

### 端点规范

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/folders` | 文件夹列表 |
| POST | `/folders` | 创建 |
| PUT | `/folders/{id}` | 更新 |
| DELETE | `/folders/{id}` | 删除（内容移至根目录） |
| POST | `/{resource}/{id}/move` | 移动单个 |
| POST | `/{resource}/batch-move` | 批量移动 |

### 列表筛选

```
GET /{resource}?folderId=xxx    → 指定文件夹
GET /{resource}?folderId=root   → 仅根目录
GET /{resource}                 → 全部（不筛选）
```

---

## 组件三：空间隔离 (SpaceIsolation)

### 接口定义

```typescript
interface SpaceScoped {
  spaceId?: string;  // null | "default" = 共享空间
}

// 访问控制函数
function canAccess(userSpaceId: string | null, resourceSpaceId: string | null): boolean {
  const userDefault = !userSpaceId || userSpaceId === 'default';
  const resourceDefault = !resourceSpaceId || resourceSpaceId === 'default';
  return userSpaceId === resourceSpaceId || (userDefault && resourceDefault);
}
```

### 隔离策略

| 阶段 | SpaceId 值 | 行为 |
|------|-----------|------|
| 当前 | `null` / `"default"` | 所有用户共享 |
| 未来 | `"team-xxx"` | 按团队隔离 |

### 查询过滤

```javascript
// 当前阶段
filter: { $or: [{ spaceId: null }, { spaceId: "default" }] }

// 未来扩展
filter: { spaceId: userSpaceId }
```

---

## 组合示例

缺陷管理模块组合使用三个组件：

```
DefectReport
├── 基础字段: id, title, content, status...
├── + SoftDeletable: isDeleted, deletedAt, deletedBy
└── + Folderable: folderId → DefectFolder

DefectFolder
├── 基础字段: id, name, color, icon, sortOrder
└── + SpaceScoped: spaceId
```

---

## 测试检查点

### 软删除
- [ ] 删除后 isDeleted=true，原数据保留
- [ ] 列表默认不返回已删除项
- [ ] 回收站仅返回已删除项
- [ ] 恢复后字段清空，数据可用
- [ ] 永久删除校验必须在回收站中

### 文件夹
- [ ] 删除文件夹时内容移至根目录
- [ ] folderId=root 仅返回未分类项
- [ ] 移动到不存在的文件夹返回错误

### 空间隔离
- [ ] 不同 spaceId 数据完全隔离
- [ ] null 与 "default" 等效处理
- [ ] 跨空间操作被拒绝

---

*版本: 1.0 | 提取自: 缺陷管理 Agent*
