# 海鲜市场（Configuration Marketplace）用户故事

> 文档版本：1.0
> 最后更新：2026-02-02
> 关联 PRD：[prd.marketplace.md](./prd.marketplace.md)

---

## 1. 功能概述

海鲜市场是文学创作 Agent 的配置共享平台，用户可以将自己的提示词、风格图、水印配置发布到市场，其他用户可以免费下载使用。

---

## 2. 用户角色

| 角色 | 描述 |
|------|------|
| 配置创建者 | 创建并管理自己的配置，可选择发布到市场 |
| 配置消费者 | 浏览市场，下载他人分享的配置 |

---

## 3. 用户故事

### US-001：发布提示词到海鲜市场

**作为** 配置创建者
**我想要** 将我精心编写的提示词发布到海鲜市场
**以便** 其他用户可以使用我的配置

#### 前置条件
- 用户已登录
- 用户已创建至少一个提示词配置

#### 操作流程
```
1. 进入「文学创作」页面
2. 点击「配置管理」按钮，打开配置管理弹窗
3. 确保当前在「我的」标签页
4. 找到要发布的提示词卡片
5. 点击卡片底部的「发布」按钮
6. 系统提示「发布成功，配置已发布到海鲜市场」
7. 卡片上出现「已公开」徽章
8. 显示「0 次下载」计数
```

#### 验收标准
- [ ] 发布后卡片显示「已公开」蓝色徽章
- [ ] 发布后显示 Fork 次数（初始为 0）
- [ ] 发布按钮变为「取消发布」按钮
- [ ] 配置出现在海鲜市场列表中

#### 界面示意
```
┌────────────────────────────────────────┐
│ 我的提示词模板                          │
├────────────────────────────────────────┤
│ 📝 古风意境生成                 [已公开] │
│ ────────────────────────────────────── │
│ 你是一位精通古典文学的AI...              │
│ ────────────────────────────────────── │
│ 🔀 12 次下载                            │
│ [取消发布]              [选择] [编辑] [删除] │
└────────────────────────────────────────┘
```

---

### US-002：取消发布配置

**作为** 配置创建者
**我想要** 取消已发布的配置
**以便** 不再让其他用户看到和下载

#### 前置条件
- 配置已发布到海鲜市场

#### 操作流程
```
1. 在「我的」标签页找到已发布的配置
2. 点击「取消发布」按钮
3. 系统弹出确认对话框：「确定要取消发布吗？取消后其他用户将无法看到此配置。」
4. 点击「确定」
5. 系统提示「已取消发布」
6. 「已公开」徽章消失
7. Fork 次数保留（历史数据）
```

#### 验收标准
- [ ] 取消发布需要二次确认
- [ ] 取消后「已公开」徽章消失
- [ ] 取消后配置从海鲜市场列表中移除
- [ ] Fork 次数数据保留

---

### US-003：浏览海鲜市场

**作为** 配置消费者
**我想要** 浏览海鲜市场中的公开配置
**以便** 找到适合我需求的配置

#### 前置条件
- 用户已登录

#### 操作流程
```
1. 进入「文学创作」页面
2. 点击「配置管理」按钮
3. 点击标题栏右侧的「海鲜市场」标签
4. 看到混合展示的配置列表
5. 使用分类筛选：全部 / 提示词 / 风格图 / 水印
6. 使用排序：热门（按下载次数）/ 最新（按发布时间）
7. 使用搜索框搜索配置名称
```

#### 验收标准
- [ ] 默认显示所有类型的配置（混合展示）
- [ ] 每个卡片显示类型标签（📝提示词 / 🎨风格图 / 💧水印）
- [ ] 显示作者头像、昵称、发布日期
- [ ] 显示下载次数
- [ ] 分类筛选正常工作
- [ ] 排序正常工作
- [ ] 搜索正常工作

#### 界面示意
```
┌─────────────────────────────────────────────────────────────┐
│ 配置管理                                    [我的] [海鲜市场] │
│ 发现优质配置，一键免费下载                                    │
├─────────────────────────────────────────────────────────────┤
│ [🔍 搜索配置名称...]  [全部|提示词|风格图|水印]  [热门|最新]  │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │ [📝提示词] 古风  │ │ [🎨风格图] 水墨  │ │ [💧水印] 极简   │ │
│ │ 🔀 156          │ │ 🔀 89           │ │ 🔀 45           │ │
│ │ 👤 张三 · 1/15  │ │ 👤 李四 · 1/20  │ │ 👤 王五 · 1/25  │ │
│ │ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │ │
│ │ │ 预览内容... │ │ │ │   [图片]    │ │ │ │  水印预览   │ │ │
│ │ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │ │
│ │    [免费下载]   │ │    [免费下载]   │ │    [免费下载]   │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

### US-004：免费下载（Fork）配置

**作为** 配置消费者
**我想要** 下载海鲜市场中的配置
**以便** 在自己的创作中使用

#### 前置条件
- 用户已登录
- 目标配置已发布到海鲜市场

#### 操作流程
```
1. 在海鲜市场找到想要的配置
2. 点击「免费下载」按钮
3. 系统提示「下载成功，已添加到「我的」」
4. 切换到「我的」标签页
5. 看到新增的配置（带有来源标记）
```

#### 验收标准
- [ ] 下载后配置出现在「我的」列表
- [ ] 原配置的下载次数 +1
- [ ] 下载的配置属于当前用户（可编辑/删除）
- [ ] 下载的配置初始为私有状态

#### 数据隔离验证
```
原配置（用户A）:
  OwnerUserId: "user-A"
  IsPublic: true
  ForkCount: 10 → 11

Fork后的配置（用户B）:
  OwnerUserId: "user-B"        ← 新所有者
  IsPublic: false              ← 默认私有
  ForkedFromId: "原配置ID"     ← 来源追溯
  ForkedFromUserId: "user-A"
  ForkedFromUserName: "张三"
  ForkCount: 0
```

---

### US-005：修改 Fork 的配置

**作为** 配置消费者
**我想要** 修改下载的配置
**以便** 根据自己的需求调整

#### 前置条件
- 用户已 Fork 一个配置

#### 操作流程
```
1. 在「我的」列表找到 Fork 的配置
2. 点击「编辑」按钮
3. 修改配置内容
4. 保存修改
5. 来源标记被清除（表示已修改）
```

#### 验收标准
- [ ] 修改后 `ForkedFromId` 被清除
- [ ] 修改后 `IsModifiedAfterFork` 设为 true
- [ ] 用户可以将修改后的配置再次发布

---

## 4. 数据隔离规则

### 4.1 私有配置隔离

```sql
-- 用户只能看到自己的私有配置
SELECT * FROM literary_prompts
WHERE OwnerUserId = :currentUserId
```

### 4.2 海鲜市场列表

```sql
-- 海鲜市场只显示公开配置
SELECT * FROM literary_prompts
WHERE IsPublic = true
ORDER BY ForkCount DESC  -- 热门排序
```

### 4.3 发布权限验证

```csharp
// 只有所有者才能发布/取消发布
if (prompt.OwnerUserId != currentUserId)
    return 403 Forbidden;
```

### 4.4 Fork 数据变更

| 字段 | 原配置变更 | 新配置值 |
|------|-----------|---------|
| OwnerUserId | 不变 | 当前用户 ID |
| ForkCount | +1 | 0 |
| IsPublic | 不变 | false |
| ForkedFromId | 不变 | 原配置 ID |
| ForkedFromUserId | 不变 | 原配置所有者 ID |

---

## 5. API 端点清单

### 5.1 提示词

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/literary-agent/prompts` | 获取我的提示词 |
| GET | `/api/literary-agent/prompts/marketplace` | 获取海鲜市场列表 |
| POST | `/api/literary-agent/prompts/{id}/publish` | 发布到市场 |
| POST | `/api/literary-agent/prompts/{id}/unpublish` | 取消发布 |
| POST | `/api/literary-agent/prompts/{id}/fork` | 免费下载 |

### 5.2 风格图

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/literary-agent/config/reference-images` | 获取我的风格图 |
| GET | `/api/literary-agent/config/reference-images/marketplace` | 获取海鲜市场列表 |
| POST | `/api/literary-agent/config/reference-images/{id}/publish` | 发布到市场 |
| POST | `/api/literary-agent/config/reference-images/{id}/unpublish` | 取消发布 |
| POST | `/api/literary-agent/config/reference-images/{id}/fork` | 免费下载 |

### 5.3 水印

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/watermarks` | 获取我的水印 |
| GET | `/api/watermarks/marketplace` | 获取海鲜市场列表 |
| POST | `/api/watermarks/{id}/publish` | 发布到市场 |
| POST | `/api/watermarks/{id}/unpublish` | 取消发布 |
| POST | `/api/watermarks/{id}/fork` | 免费下载 |

---

## 6. 测试检查清单

### 6.1 功能测试

- [ ] 创建提示词 → 发布 → 出现在市场
- [ ] 创建风格图 → 发布 → 出现在市场
- [ ] 创建水印 → 发布 → 出现在市场
- [ ] 取消发布 → 从市场消失
- [ ] Fork 提示词 → 出现在我的列表
- [ ] Fork 风格图 → 出现在我的列表
- [ ] Fork 水印 → 出现在我的列表
- [ ] 修改 Fork 的配置 → 来源标记清除

### 6.2 隔离测试

- [ ] 用户A的私有配置，用户B看不到
- [ ] 用户A发布后，用户B能看到
- [ ] 用户B Fork 后，配置属于用户B
- [ ] 用户A取消发布后，用户B看不到（但已 Fork 的保留）
- [ ] 用户B无法修改用户A的配置
- [ ] 用户B无法取消发布用户A的配置

### 6.3 边界测试

- [ ] 搜索空关键词 → 显示全部
- [ ] 搜索不存在的关键词 → 显示空
- [ ] 切换排序 → 列表重新排序
- [ ] 切换分类 → 列表正确过滤

---

## 7. E2E 测试脚本

```bash
# 执行完整的海鲜市场功能测试
AI_ACCESS_KEY=your-api-key ./e2e-tests/marketplace-test.sh
```

测试脚本位置：`/e2e-tests/marketplace-test.sh`

---

## 8. 相关文件

| 文件 | 用途 |
|------|------|
| `doc/prd.marketplace.md` | 产品需求文档 |
| `doc/user-story.marketplace.md` | 本文档 |
| `e2e-tests/marketplace-test.sh` | E2E 测试脚本 |
| `prd-admin/src/pages/literary-agent/ArticleIllustrationEditorPage.tsx` | 前端主页面 |
| `prd-admin/src/components/watermark/WatermarkSettingsPanel.tsx` | 水印面板组件 |
| `prd-api/src/PrdAgent.Api/Controllers/Api/LiteraryPromptsController.cs` | 提示词 API |
| `prd-api/src/PrdAgent.Api/Controllers/Api/LiteraryAgentConfigController.cs` | 风格图 API |
| `prd-api/src/PrdAgent.Api/Controllers/WatermarkController.cs` | 水印 API |

---

## 9. 变更历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-02 | 1.0 | 初始版本 | Claude |
