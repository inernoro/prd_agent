## 文档维护说明（针对“doc 过时”治理）

> 本文件用于解决：`doc/` 下 SRS/PRD 与当前代码实现出现显著偏差、且偏差持续扩大导致“文档不可用”的问题。
> 
> 约束：**只更新文档与规则文件，不修改业务代码**。若发现“代码实现 vs 既有文档/安全要求”存在重大冲突，将**先列出差异与冲突点**，由维护者决策后再统一修订。

---

## 1. 现状：为什么 doc 容易过时

当前 `doc/2.srs.md` 与 `doc/3.prd.md` 版本停留在 2024-12，且假设了若干已变化的事实，例如：
- 交互上仍以“引导讲解（guide）”为核心模式之一，但代码已转向“提示词阶段 + Run/Worker 服务端闭环”。
- 管理后台菜单/模块显著扩展（AI 对话/视觉创作 Agent/资源管理/数据管理/实验室/提示词管理等）。
- 模型配置从“单一 Provider/Model”演进为“平台（platform）+ 模型（model）”体系，并引入 `(platformId, modelId)` 业务唯一语义。
- 日志与存储策略出现变化（例如：PRD 原文是否落盘、API 请求日志是否存 request body 等）。

上述变化导致：文档不再是“基线”，而变成“历史描述”，对开发/测试/运维产生误导。

---

## 2. 目标：把 doc 从“说明书”升级为“可维护的契约”

建议将文档分层，明确每一层的“事实来源”（source of truth）：

- **A. 稳定契约层（必须长期有效）**
  - API 统一响应结构、错误码、角色枚举、幂等键、SSE/Run 语义、权限边界
  - 模型标识语义（`platformId + modelId`）
  - 安全红线（密钥/Token/个人信息/PRD 原文的留存与日志策略）

- **B. 业务流程层（允许演进，但必须可追溯）**
  - Desktop/Group/Chat 的关键流程图与状态机（强调“有哪些状态与边界”，避免写死 UI 细节）
  - Prompt 阶段体系（管理后台配置、客户端触发方式、服务端注入方式）

- **C. 产品功能层（允许更快变化）**
  - Admin 页面与功能清单（以“模块/能力”描述，避免写死 UI 布局像素）
  - Desktop 功能清单（PRD 预览/引用/评论/划词问 AI/资源加载/在线状态）

将“变化频率不同的内容”拆开，能显著降低每次迭代需要重写整份文档的成本。

---

## 3. 维护机制：如何让文档不再过时

### 3.1 文档的“改动触发器”

只要发生以下任一变更，就必须同步更新 doc（最小更新即可）：
- **新增/删除/重命名** 顶级路由（admin/desktop 任一端）
- **新增/删除/变更** 后端 controller 路由、请求/响应字段、鉴权方式
- **数据模型语义变化**（例如：唯一键从 `modelName` 变成 `(platformId, modelId)`）
- **存储/日志/脱敏策略变化**（尤其涉及 PRD 原文、用户内容、密钥类字段）
- **Run/任务化**链路变化（runId、断线续传、幂等语义）

### 3.2 “反向更新”建议流程（从代码推回文档）

1. **抽取事实**（只读扫描代码）：
   - Admin：路由表/侧边栏菜单、核心页面职责
   - API：Controller 路由、关键 DTO、鉴权/角色
   - Desktop：关键 invoke 命令、SSE/Run 订阅点、核心页面能力
   - 日志/存储：哪些内容落库、哪些内容写日志、脱敏/截断策略

2. **生成差异清单（文档 vs 代码）**：
   - 新增：文档缺失但代码存在
   - 变更：同名能力但语义/接口/流程不同
   - 删除：文档仍描述但代码已移除
   - 冲突：涉及安全/合规/产品取舍的重大不一致（需决策）

3. **先修“稳定契约层”**：
   - 把 API 响应结构/错误码/鉴权/幂等/Run/SSE 写正确
   - 把模型标识 `(platformId, modelId)` 写正确
   - 把脱敏/留存策略写成“可执行规则”（并标注现实现状）

4. **再修“业务流程层”和“功能层”**：
   - 仅更新发生变化的模块；不追求一次性重写全部

### 3.3 自动化校验点（建议，非强制）

在不改业务代码的前提下，也可以引入“轻量校验”来防止再次过时：
- **API 清单校验**：从 Swagger/OpenAPI 导出路由列表，与文档中的“核心接口表”做对比。
- **Admin 路由校验**：从 `prd-admin/src/app/App.tsx` 提取路由 key，与文档模块表对比。
- **Desktop 命令校验**：从 `src-tauri/src/commands/**` 抽取 command 名称，与文档的“IPC/调用点”对比。

这些校验只需要维护“列表/索引”层面的匹配，不要求把每个字段都自动对齐。

---

## 4. 脱敏与留存：统一策略（建议基线）

### 4.1 绝对禁止（红线）
- 任何密钥类字段（API Key/Token/Secret/Password/证书内容）**不得落盘**，日志与接口响应必须脱敏。
- 明确的个人身份信息（手机号/身份证/邮箱等）**不得写入日志**。

### 4.2 PRD 原文与用户内容

这里必须先由维护者做一个“产品/合规决策”：
- **策略 A（严格）**：PRD 原文不落库，仅缓存；日志不记录 PRD 内容；需要排障时使用短预览 + hash 对照。
- **策略 B（折中）**：PRD 原文可落库但受访问控制/TTL/加密；日志不记录原文；管理后台可按授权查看。
- **策略 C（宽松）**：允许部分日志/排障保留用户问题与模型回答（截断），但必须有明确 TTL 与权限隔离。

文档应同时包含：
- **现实现状**（代码实际在做什么）
- **目标策略**（你希望系统最终遵循哪一种）

---

## 5. 与规则文件的关系（.cursor/rules）

建议新增/更新规则文件，将“文档与安全策略”固化成协作约束：
- 增加 `docs.mdc`：规定文档更新触发器、冲突处理流程、脱敏红线、以及“文档优先级/裁决方式”。
- 在 `sys.mdc` 中加入 docs 规则入口，便于 agent/协作者统一遵循。

---

## 6. 差异清单入口（持续更新）

为了避免在 SRS/PRD 正文中反复堆叠"实现变更细节"，建议把"代码事实对照表/冲突点"单独维护为增量文档：

- 差异清单：[`doc/8.doc-code-diff.md`](8.doc-code-diff.md)

该清单应作为后续每次文档维护的"第一落点"：先更新差异清单，再决定是否把变化吸收进 SRS/PRD 基线。

---

## 7. 最近一次文档更新记录（2026-01-08）

### 7.1 更新内容

**新增模块：文学创作 Agent（文章配图）**

- 在 `doc/3.prd.md` 新增第 4.8 节"文学创作 Agent（文章配图）"，描述功能概述、工作流阶段、状态机规则、交互流程、验收标准。
- 在 `doc/2.srs.md` 新增第 5.3 节"文学创作 Agent 接口"，描述生成配图标记/上传配图资产/导出文章接口的规格与服务端行为。
- 在 `doc/2.srs.md` 新增第 7.2.10-7.2.11 节数据模型，描述 `ImageMasterWorkspace`/`ArticleWorkflow`/`ImageAsset` 的字段定义与约束。
- 在 `doc/8.doc-code-diff.md` 更新第 2.2 节，标注"文学创作 Agent 已落地"。
- 新增 `doc/9.literary-agent-article-illustration.md`，完整描述文章配图功能的设计理念、工作流、数据模型、接口设计、前后端实现、验收标准、未来优化方向。

### 7.2 核心设计要点

**状态机规则**：

1. **单项可随时查看已生成过的任意阶段**：服务端 `ArticleIllustrationWorkflow` 记录当前 phase/version/markers/images 进度，前端刷新后以服务端 workflow.phase 为准恢复阶段。
2. **提交型修改后清空并重置后续阶段**：文章更新/标记生成成功都会触发 version++，清空后续阶段数据，删除旧配图资产，快照当前 workflow 到历史（debug-only，最多保留 10 条）。
3. **只切换阶段不修改：不重算、不丢后续数据**：用户点击阶段按钮切换时，只同步本地展示，不触发后端写入。
4. **禁止跳转到未来阶段（未生成过的）**：前端 `jumpToPhase` 基于服务端 workflow.phase 判断目标阶段是否"未来"，若是则弹窗提示并禁止跳转。

**关键技术实现**：

- 前端修复：`updateImageMasterWorkspaceReal` 不传 `articleContent` 的 bug（导致文章内容不落库）
- 后端新增：`ArticleIllustrationWorkflow` 数据模型，`ImageAsset` 扩展 `ArticleInsertionIndex/OriginalMarkerText` 字段
- 后端逻辑：`UpdateWorkspace`/`GenerateArticleMarkers` 实现"提交型修改清后续"，`UploadWorkspaceAsset` 推进 workflow 进度
- BSON 映射：注册 workflow 的 camelCase 映射，确保 MongoDB 字段名一致

### 7.3 文档维护原则

- 遵循"先对齐事实（只读扫描代码），再标注冲突点（涉及安全/合规/产品取舍的项由维护者裁决）"原则。
- 新增功能优先更新差异清单（`doc/8.doc-code-diff.md`），再决定是否吸收进 SRS/PRD 基线。
- 对于已落地的功能，创建独立的设计文档（如 `doc/9.literary-agent-article-illustration.md`），避免在 SRS/PRD 中堆叠过多实现细节。

