# 周报 Agent (Report Agent) — 产品需求文档

> **版本**：v1.0 | **创建日期**：2026-02-24 | **appKey**：`report-agent`
>
> **一句话定位**：通过自动采集工作痕迹 + 模板化输出 + AI 润色，将周报从"回忆式写作"变为"确认式提交"。

---

## 一、背景与问题

### 1.1 当前周报现状

| 痛点 | 表现 | 根因 |
|------|------|------|
| **写多了是废话** | 员工花 30-60 分钟堆砌文字，领导花更多时间阅读 | 无结构约束，自由发挥 |
| **写少了遗漏** | 重要工作忘记写，尤其是跨天的小任务 | 人脑回忆不可靠，缺乏过程留痕 |
| **埋没实干者** | 表达能力强的人周报亮眼，闷头干活的人被忽视 | 周报质量 ≠ 工作质量，依赖写作能力 |
| **格式不统一** | 每个人写法不同，领导要花时间理解不同格式 | 缺乏模板约束 |
| **汇总成本高** | 领导手动整理 10+ 份周报为团队周报 | 无自动聚合能力 |

### 1.2 核心设计理念

> **让数据替人说话，让 AI 帮人表达，让模板保证一致。**

三个关键转变：
1. **回忆 → 采集**：系统自动采集代码提交、系统操作、文档编辑等痕迹，员工不需要"回忆"
2. **写作 → 确认**：AI 基于采集数据生成草稿，员工只需审核确认或微调
3. **自由 → 模板**：领导定义模板结构，所有周报格式统一，内容聚焦

---

## 二、用户角色

| 角色 | 身份 | 核心诉求 |
|------|------|----------|
| **员工** | 团队成员 | 最少操作完成周报，不遗漏重要工作 |
| **团队负责人** | 直接管理者 | 快速掌握团队每个人的工作产出，一键生成团队周报 |
| **部门负责人** | 高级管理者 | 跨团队汇总，发现瓶颈和风险 |
| **系统管理员** | IT/平台管理 | 配置数据源、管理模板、维护系统 |

---

## 三、前置功能：团队与组织模型

> **这是周报闭环的基础**。没有团队结构，"我的团队周报""团队汇总"都无法实现。

### 3.1 为什么现有 Group 不够用

当前系统的 `groups` 是围绕 PRD 文档的协作组，成员按"产品/开发/测试"等标签归类。而周报需要的是**组织架构层级**：谁向谁汇报、谁管理谁。

### 3.2 团队模型设计

```
组织架构
├── 产品部
│   ├── 产品一组 (负责人: 张三)
│   │   ├── 李四 (PM)
│   │   └── 王五 (PM)
│   └── 产品二组 (负责人: 赵六)
│       └── ...
├── 研发部
│   ├── 前端组 (负责人: ...)
│   └── 后端组 (负责人: ...)
└── 测试部
    └── ...
```

#### 数据模型：`Team`

| 字段 | 类型 | 说明 |
|------|------|------|
| `Id` | string | 主键 |
| `Name` | string | 团队名称 |
| `ParentTeamId` | string? | 上级团队（null 为顶级部门） |
| `LeaderUserId` | string | 团队负责人 |
| `Description` | string? | 团队描述 |
| `CreatedAt` / `UpdatedAt` | DateTime | 时间戳 |

#### 数据模型：`TeamMember`

| 字段 | 类型 | 说明 |
|------|------|------|
| `Id` | string | 主键 |
| `TeamId` | string | 所属团队 |
| `UserId` | string | 用户 ID |
| `Role` | enum | `Member` / `Leader` / `Deputy` |
| `JobTitle` | string? | 岗位（产品经理/前端开发/测试工程师...） |
| `JoinedAt` | DateTime | 加入时间 |

#### 可见性规则

| 角色 | 可见范围 |
|------|----------|
| 员工 | 自己的周报 + 同团队成员已提交的周报 |
| 团队负责人 | 本团队所有成员周报 + 团队聚合视图 |
| 部门负责人 | 本部门下所有团队的周报 + 部门聚合视图 |
| 系统管理员 | 全部周报 |

### 3.3 团队管理界面

位置：管理后台 → 组织管理（新增顶级菜单）

功能：
- 创建/编辑/删除团队
- 拖拽调整层级关系
- 添加/移除成员
- 设置团队负责人
- 查看团队成员列表

> **MVP 策略**：团队模型在 report-agent 内部实现，未来可提升为平台级模块供其他 Agent 复用。

---

## 四、核心功能

### 4.1 模板管理（领导侧）

> **解决问题**：格式不统一，内容不聚焦

#### 4.1.1 模板结构

一个模板由**有序的板块（Section）列表**构成，每个板块定义：

| 字段 | 类型 | 说明 |
|------|------|------|
| `Title` | string | 板块标题（如"本周完成""下周计划""需要协助"） |
| `Description` | string? | 填写指引（如"请列出本周完成的主要工作项，每项一行"） |
| `InputType` | enum | `BulletList`（条目列表） / `RichText`（富文本） / `KeyValue`（键值对） / `ProgressTable`（进度表） |
| `IsRequired` | bool | 是否必填 |
| `SortOrder` | int | 排列顺序 |
| `DataSourceHint` | string? | AI 采集提示（如"git_commits""system_activity"），用于自动填充 |
| `MaxItems` | int? | 最大条目数（避免写成流水账） |

#### 4.1.2 模板示例

**研发团队周报模板**：

```
┌─────────────────────────────────────────────┐
│  研发团队周报模板                              │
├─────────────────────────────────────────────┤
│                                             │
│  § 1. 本周完成 [必填] [条目列表]               │
│     提示：列出本周完成的功能/修复/优化            │
│     数据源：git_commits + system_activity     │
│     最多 10 条                               │
│                                             │
│  § 2. 代码统计 [自动] [键值对]                 │
│     提示：自动采集，无需手动填写                 │
│     数据源：git_stats                        │
│                                             │
│  § 3. 进行中任务 [必填] [进度表]               │
│     提示：列出正在进行但未完成的任务和进度         │
│     最多 5 条                                │
│                                             │
│  § 4. 下周计划 [必填] [条目列表]               │
│     提示：列出下周重点工作项                    │
│     最多 5 条                                │
│                                             │
│  § 5. 风险与阻塞 [选填] [富文本]              │
│     提示：需要上级协助解决的问题                 │
│                                             │
│  § 6. 自由备注 [选填] [富文本]                │
│     提示：其他想说的                           │
│                                             │
└─────────────────────────────────────────────┘
```

**产品经理周报模板**：

```
§ 1. 本周推进需求 [必填] — 数据源：prd_agent_activity
§ 2. 评审与沟通 [必填]  — 数据源：system_activity
§ 3. 需求排期变更 [选填]
§ 4. 下周计划 [必填]
§ 5. 待决策事项 [选填]
```

#### 4.1.3 模板绑定规则

| 绑定维度 | 说明 | 优先级 |
|----------|------|--------|
| 团队绑定 | 负责人为本团队指定模板 | 最高 |
| 岗位绑定 | 同团队不同岗位可用不同模板 | 中 |
| 默认模板 | 系统预置的通用模板 | 兜底 |

查找顺序：**团队+岗位专属 → 团队通用 → 系统默认**

#### 4.1.4 模板管理权限

| 操作 | 系统管理员 | 部门负责人 | 团队负责人 |
|------|-----------|-----------|-----------|
| 创建系统模板 | ✅ | ❌ | ❌ |
| 创建团队模板 | ✅ | ✅（本部门） | ✅（本团队） |
| 编辑模板 | ✅ | 自己创建的 | 自己创建的 |
| 删除模板 | ✅ | 自己创建的 | 自己创建的 |
| 绑定模板到团队 | ✅ | ✅（本部门） | ✅（本团队） |

---

### 4.2 数据源采集引擎

> **解决问题**：人脑回忆不可靠，重要工作遗漏

#### 4.2.1 数据源类型

| 数据源 | 采集方式 | 采集内容 | 角色适用 |
|--------|----------|----------|----------|
| **Git** | Webhook / 定时轮询 | 提交记录、合并请求、代码审查 | 开发 |
| **SVN** | 定时轮询 | 提交记录、变更文件列表 | 开发 |
| **MAP 系统活动** | 内部 API | PRD 评审记录、缺陷提交、对话历史、技能使用 | 全员 |
| **手动日志** | 用户输入 | 每日快速打点（30 秒完成），会议/沟通/协调等非系统操作 | 全员 |

#### 4.2.2 Git/SVN 连接器配置

由**系统管理员或团队负责人**配置：

| 配置项 | 说明 |
|--------|------|
| `SourceType` | Git / SVN |
| `RepoUrl` | 仓库地址 |
| `AccessToken` | 访问令牌（加密存储） |
| `BranchFilter` | 监听分支（如 `main,develop,release/*`） |
| `TeamId` | 关联团队 |
| `UserMapping` | 仓库用户名 → MAP 用户 ID 映射表 |
| `PollInterval` | 轮询间隔（默认 60 分钟） |

#### 4.2.3 MAP 系统内活动自动采集

| 系统模块 | 采集内容 | 采集方式 |
|----------|----------|----------|
| PRD Agent | 上传 PRD、评审参与、问答记录 | 查询 `sessions` + `messages` |
| Defect Agent | 缺陷提交数、严重程度分布 | 查询 `defect_reports` |
| Visual Agent | 生成图片数、创作会话 | 查询 `image_master_sessions` |
| Literary Agent | 创作次数、文章配图 | 查询 `literary_prompts` 使用记录 |
| 通用 | 登录天数、AI 调用次数 | 查询 `api_request_logs` + `llm_request_logs` |

#### 4.2.4 每日打点（Daily Log）

> **关键设计**：解决"非系统化工作"的留痕问题（会议、沟通、调研等）。

入口：MAP 首页/桌面端 → 快捷打点按钮

```
┌────────────────────────────────────────────┐
│  📝 今日打点            2026-02-24 (周一)    │
├────────────────────────────────────────────┤
│                                            │
│  + 添加工作项                               │
│                                            │
│  ● 参加 PRD 评审会（2h）        [会议]       │
│  ● 修复登录页 SSO 回调 Bug      [开发]       │
│  ● 和设计师对接首页改版方案       [沟通]       │
│                                            │
│  ─────────────────────────────────────      │
│  提示：每天花 30 秒记录，周五不用回忆          │
│                                            │
│                          [保存]             │
└────────────────────────────────────────────┘
```

**打点数据模型**：

| 字段 | 类型 | 说明 |
|------|------|------|
| `UserId` | string | 用户 ID |
| `Date` | DateOnly | 日期 |
| `Items[]` | array | 工作项列表 |
| `Items[].Content` | string | 工作内容描述 |
| `Items[].Category` | string | 分类标签（开发/会议/沟通/文档/测试/其他） |
| `Items[].Duration` | int? | 耗时（分钟，选填） |

---

### 4.3 AI 自动生成引擎

> **解决问题**：帮不善表达的人清晰呈现工作内容

#### 4.3.1 生成流程

```
┌──────────────────────────────────────────────────────────────┐
│                    周报自动生成流水线                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  触发条件：每周五 16:00 自动触发 / 员工手动触发                   │
│                                                              │
│  Step 1: 确定模板                                             │
│  ├─ 按绑定规则匹配用户的周报模板                                 │
│  └─ 无模板则使用系统默认                                        │
│                                                              │
│  Step 2: 采集数据                                             │
│  ├─ 遍历模板中每个 Section 的 DataSourceHint                   │
│  ├─ git_commits → 查询本周 Git 提交记录                        │
│  ├─ git_stats → 统计 commits / insertions / deletions         │
│  ├─ svn_commits → 查询本周 SVN 提交记录                        │
│  ├─ system_activity → 查询 MAP 内操作记录                      │
│  ├─ prd_agent_activity → 查询 PRD Agent 使用记录               │
│  ├─ daily_logs → 查询本周每日打点                               │
│  └─ 无 DataSourceHint 的 Section 留空等待手动填写               │
│                                                              │
│  Step 3: AI 生成                                              │
│  ├─ 将采集数据 + 模板结构 + 用户岗位信息注入 Prompt              │
│  ├─ LLM 将原始数据整理为结构化、可读的周报内容                    │
│  ├─ 对 Git commit message 做去噪和归类                         │
│  ├─ 合并同一功能的多次提交为一条总结                              │
│  └─ 输出符合模板结构的 JSON                                    │
│                                                              │
│  Step 4: 生成草稿                                             │
│  ├─ 保存为 Draft 状态                                         │
│  ├─ 标记每个 Section 的数据来源（自动/手动）                     │
│  └─ 推送通知："您的周报草稿已生成，请审核"                       │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 4.3.2 AI Prompt 策略

```
系统角色：
你是一位专业的周报撰写助手。你的任务是将原始工作数据整理为清晰、简洁的周报内容。

规则：
1. 将多个零散的 Git 提交归纳为有意义的功能/任务描述
2. 使用业务语言而非技术细节（"完成用户登录模块开发"而非"merge branch feat/login"）
3. 突出成果和影响，而非过程
4. 每条不超过 50 字
5. 对于代码统计数据，只展示关键数字，不做评判
6. 严格按照模板板块结构输出
7. 无数据的板块标记为"无数据，请手动补充"
```

#### 4.3.3 Skill 定义

| 技能名称 | appCallerCode | 说明 |
|----------|---------------|------|
| 周报草稿生成 | `report-agent.generate::chat` | 基于采集数据生成完整周报草稿 |
| 团队周报汇总 | `report-agent.aggregate::chat` | 汇总团队成员周报为管理视图 |
| 周报润色 | `report-agent.polish::chat` | 对手动编写内容做表达优化 |

---

### 4.4 周报编辑与提交（员工侧）

#### 4.4.1 编辑界面

```
┌──────────────────────────────────────────────────────────────┐
│  我的周报  2026-W08 (02-17 ~ 02-21)        [草稿] [提交周报]  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─ § 本周完成 ──────────────────────────── [自动采集] ──┐    │
│  │                                                      │    │
│  │  ● 完成用户登录模块 SSO 对接          [Git] [可编辑]   │    │
│  │  ● 修复周报页面分页 Bug               [Git] [可编辑]   │    │
│  │  ● 参加 PRD 评审会 ×2               [打点] [可编辑]   │    │
│  │  + 添加更多                                           │    │
│  │                                                      │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─ § 代码统计 ──────────────────────────── [自动] ─────┐    │
│  │  提交次数: 23  |  新增: 1,204 行  |  删除: 356 行     │    │
│  │  涉及仓库: prd-agent (18), prd-admin (5)              │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─ § 进行中任务 ────────────────────────── [手动] ─────┐    │
│  │  任务名称              进度     预计完成               │    │
│  │  ─────────────────────────────────────               │    │
│  │  邮件渠道适配器         70%     下周二                 │    │
│  │  + 添加任务                                           │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─ § 下周计划 ──────────────────────────── [手动] ─────┐    │
│  │  ● (请填写)                                           │    │
│  │  + 添加计划                                           │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─ § 风险与阻塞 ────────────────────────── [选填] ─────┐   │
│  │  (暂无风险项)                                         │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  AI 辅助：[一键润色全文]  [重新生成本周完成]                    │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 4.4.2 编辑规则

- 自动采集的内容可编辑、删除、补充，AI 不会拒绝人的修改
- 必填板块未填写时提交按钮置灰，并提示缺少内容
- 自动保存草稿（每 30 秒），避免丢失
- 每条工作项标记数据来源（Git / SVN / 打点 / 系统活动 / 手动），便于追溯

---

### 4.5 周报状态机

```
                     ┌──────────┐
                     │ NotStarted│  (周期开始，尚未生成)
                     └─────┬────┘
                           │ 自动生成触发 / 手动创建
                           ▼
                     ┌──────────┐
              ┌──────│  Draft    │◄────── 退回修改
              │      └─────┬────┘
              │            │ 员工点击"提交"
              │            ▼
              │      ┌──────────┐
              │      │ Submitted │  (已提交，等待查阅)
              │      └─────┬────┘
              │            │ 领导标记已读 / 退回
              │            ├─────────────────┐
              │            ▼                 ▼
              │      ┌──────────┐     ┌──────────┐
              │      │ Reviewed  │     │ Returned  │
              │      └──────────┘     └─────┬────┘
              │                             │ 员工修改后重新提交
              │                             ▼
              │                       (回到 Draft)
              │
              │  超过截止时间未提交
              ▼
        ┌──────────┐
        │ Overdue   │  (逾期状态，可继续编辑提交)
        └──────────┘
```

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| `NotStarted` | 周期已开始但未创建周报 | 手动创建 / 等待自动生成 |
| `Draft` | 草稿（自动生成或手动创建） | 编辑、提交 |
| `Submitted` | 已提交 | 领导查阅、退回 |
| `Reviewed` | 领导已查阅 | 终态 |
| `Returned` | 领导退回要求修改 | 员工修改后重新提交 |
| `Overdue` | 超过截止时间未提交 | 补交（自动标记为逾期） |

---

### 4.6 团队聚合与管理视图（领导侧）

> **解决问题**：领导手动整理成本高

#### 4.6.1 团队周报面板

```
┌──────────────────────────────────────────────────────────────┐
│  我的团队  2026-W08          [生成团队周报]  [导出]  [周期 ▼]  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  提交进度：4/6 人已提交                    ███████░░░ 67%     │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ 成员          状态      提交时间      操作             │    │
│  │ ─────────────────────────────────────────────        │    │
│  │ 张三          ✅ 已提交  周五 15:30   [查看] [已读]    │    │
│  │ 李四          ✅ 已提交  周五 16:02   [查看] [已读]    │    │
│  │ 王五          ✅ 已提交  周五 17:45   [查看]          │    │
│  │ 赵六          📝 草稿    —           [提醒]          │    │
│  │ 钱七          ⚠️ 逾期    —           [提醒]          │    │
│  │ 孙八          ✅ 已提交  周六 09:12   [查看] [逾期]    │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  ── 本周团队亮点 (AI 汇总) ──────────────────────────────      │
│                                                              │
│  1. SSO 登录模块完成对接，进入联调阶段                          │
│  2. 缺陷关闭率 85%，高于上周的 72%                             │
│  3. 邮件渠道适配器进入开发阶段（进度 70%）                       │
│                                                              │
│  ── 本周风险项 ─────────────────────────────────────────      │
│  ⚠ 王五：第三方 API 接口频繁超时，需协调供应商                    │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 4.6.2 团队周报自动汇总

当团队所有成员（或超过设定阈值）提交周报后，系统自动触发 AI 汇总：

**汇总内容**：
1. 本周团队完成的重要事项（去重合并）
2. 关键指标统计（代码提交量、缺陷解决量、PRD 评审数等）
3. 进行中任务的整体进度
4. 风险与阻塞事项聚合
5. 下周团队重点计划

**输出格式**：团队负责人可直接使用此汇总作为向上汇报的基础。

#### 4.6.3 反馈机制

领导查看周报后可以：
- **标记已读**：表示已查阅（员工可看到查阅状态）
- **评论**：针对具体板块留评论（复用现有 `prdcomments` 组件模式）
- **退回**：要求补充或修改，附退回原因

---

### 4.7 周期与截止时间管理

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `WeekStartDay` | 周一 | 统计周期起始日 |
| `AutoGenerateTime` | 周五 16:00 | 自动触发草稿生成 |
| `SubmitDeadline` | 周五 18:00 | 提交截止时间 |
| `ReminderTimes` | 周五 10:00, 15:00 | 提醒时间（未提交者收到通知） |
| `GracePeriod` | 24h | 宽限期（超过后标记逾期） |

> 以上配置由团队负责人设定，不同团队可以有不同周期。

---

### 4.8 通知系统

| 事件 | 接收人 | 通知方式 | 内容 |
|------|--------|----------|------|
| 草稿自动生成 | 员工本人 | 站内通知 | "您的周报草稿已生成，请审核提交" |
| 临近截止提醒 | 未提交员工 | 站内通知 | "周报将在 X 小时后截止" |
| 逾期未提交 | 员工 + 负责人 | 站内通知 | "XX 周报已逾期" |
| 员工提交周报 | 团队负责人 | 站内通知 | "XX 已提交周报" |
| 全员已提交 | 团队负责人 | 站内通知 | "团队周报已全部提交，AI 汇总已生成" |
| 领导退回周报 | 员工本人 | 站内通知 | "您的周报被退回：{原因}" |
| 领导查阅周报 | 员工本人 | 站内通知 | "XX 已查阅您的周报" |

> 通知复用现有 `admin_notifications` 集合 + 通知 Controller。

---

## 五、数据模型总览

### 5.1 MongoDB 集合规划

| 集合名 | 说明 | 关键字段 |
|--------|------|----------|
| `report_teams` | 团队 | name, parentTeamId, leaderUserId |
| `report_team_members` | 团队成员 | teamId, userId, role, jobTitle |
| `report_templates` | 周报模板 | name, sections[], teamId?, jobTitle? |
| `report_weekly_reports` | 周报主体 | userId, teamId, weekYear, weekNumber, status, sections[], submittedAt |
| `report_daily_logs` | 每日打点 | userId, date, items[] |
| `report_data_sources` | 数据源配置 | teamId, sourceType, repoUrl, accessToken(encrypted), userMapping |
| `report_commits` | 代码提交缓存 | sourceId, userId, commitHash, message, date, stats |
| `report_comments` | 周报评论 | reportId, sectionIndex, userId, content, createdAt |

### 5.2 核心模型

#### WeeklyReport（周报主体）

| 字段 | 类型 | 说明 |
|------|------|------|
| `Id` | string | 主键 |
| `UserId` | string | 作者 |
| `TeamId` | string | 所属团队 |
| `TemplateId` | string | 使用的模板 |
| `WeekYear` | int | 年份 (如 2026) |
| `WeekNumber` | int | ISO 周数 (如 8) |
| `PeriodStart` | DateTime | 周期开始 |
| `PeriodEnd` | DateTime | 周期结束 |
| `Status` | enum | NotStarted / Draft / Submitted / Reviewed / Returned / Overdue |
| `Sections[]` | array | 各板块内容 |
| `Sections[].TemplateSection` | object | 对应的模板板块定义 |
| `Sections[].Items[]` | array | 内容条目 |
| `Sections[].Items[].Content` | string | 文本内容 |
| `Sections[].Items[].Source` | enum | Git / SVN / SystemActivity / DailyLog / Manual / AI |
| `Sections[].Items[].SourceRef` | string? | 来源引用（如 commit hash） |
| `AutoGeneratedAt` | DateTime? | AI 生成时间 |
| `SubmittedAt` | DateTime? | 提交时间 |
| `ReviewedAt` | DateTime? | 查阅时间 |
| `ReviewedBy` | string? | 查阅人 |
| `ReturnReason` | string? | 退回原因 |
| `CreatedAt` / `UpdatedAt` | DateTime | 时间戳 |

---

## 六、与现有系统的联动

### 6.1 与 PRD Agent 联动

| 采集内容 | 数据来源 | 转化逻辑 |
|----------|----------|----------|
| 本周上传/更新的 PRD | `parsed_prds` (updatedAt in week) | "更新 PRD《XX》" |
| 参与的评审问答 | `sessions` + `messages` (PRD 对话) | "参与 PRD《XX》评审，提问 N 次" |
| 内容缺失检测 | `contentgaps` | "发现 XX 处需求缺失" |

### 6.2 与 Defect Agent 联动

| 采集内容 | 数据来源 | 转化逻辑 |
|----------|----------|----------|
| 提交的缺陷 | `defect_reports` (createdBy in week) | "提交缺陷 N 个（严重 X / 一般 Y）" |
| 处理的缺陷 | `defect_reports` (status changes) | "关闭缺陷 N 个" |

### 6.3 与 Visual Agent / Literary Agent 联动

| 采集内容 | 数据来源 |
|----------|----------|
| 创作图片数 | `image_master_sessions` |
| 文章配图次数 | Literary Agent 调用记录 |

### 6.4 与总裁面板联动

周报数据作为总裁面板的**数据供给**之一：
- 团队周报完成率 → 全局概览面板
- 个人活跃度数据 → 团队洞察面板
- 风险项聚合 → 管理预警

---

## 七、你没有考虑到的（补充设计）

在你的需求描述中，以下关键问题需要补齐才能形成闭环：

### 7.1 退回与反馈机制

你提到了"通过模板控制内容"，但没有提到**领导看了周报之后怎么办**。如果只是"看"，那周报就是单向的信息流，无法形成沟通闭环。

**补齐方案**：领导可以评论、退回、标记已读。员工能看到领导是否查阅了自己的周报（解决"写了没人看"的消极心理）。

### 7.2 周报与"计划"的闭环对比

你提到了自动化，但没提到**本周计划 vs 实际完成的比对**。这是管理的核心诉求之一。

**补齐方案**：系统自动拉取上周周报的"下周计划"板块，与本周实际完成进行比对，标注：
- ✅ 已完成
- 🔄 进行中（自动关联"进行中任务"板块）
- ❌ 未完成（需说明原因）

这让周报从"记录工具"升级为"计划执行追踪工具"。

### 7.3 数据安全与隐私

代码提交记录、工作产出数据属于敏感信息。需要明确：
- Git AccessToken 必须加密存储（AES-256），展示时脱敏
- 代码具体 diff 内容**不存储**，只存储 commit message 和统计数据
- 周报可见性严格按团队层级控制，禁止越级查看

### 7.4 入职/离职/调岗处理

如果员工月中调岗换了团队，他的周报归谁？

**补齐方案**：
- 周报按创建时的 `TeamId` 归属，调岗后历史周报仍在原团队
- 调岗当周由两个团队负责人共同可见
- 离职员工的历史周报保留，标记为"已离职"

### 7.5 补报与假期处理

员工请假一周，是否需要提交周报？

**补齐方案**：
- 团队负责人可为员工标记"本周请假"，跳过该周期
- 员工也可自行标记"本周无需提交"（需负责人审批）
- 补报允许在宽限期内提交，超过宽限期需负责人手动解锁

### 7.6 移动端快速打点

每日打点如果只能在 PC 端操作，使用率会很低。

**补齐方案**：
- 桌面端（Tauri）支持快捷打点（系统托盘 → 快速输入）
- 未来移动端 PWA 支持（参考 `plan.mobile-adaptation.md`）
- 日报打点必须极简：一个输入框 + 一个分类选择 + 回车确认

### 7.7 历史趋势与个人成长

周报不应该只是本周的快照，还应该能回答"我这个月/季度做了什么"。

**补齐方案**：
- 个人维度：月度/季度自动汇总报告（AI 基于历史周报生成）
- 团队维度：成员活跃度趋势图、代码产出趋势图
- 组织维度：部门间横向对比（可选，需管理层决策是否开启）

### 7.8 模板版本管理

如果领导修改了模板，已用旧模板提交的周报会不会乱？

**补齐方案**：
- 周报创建时**快照**当时的模板结构（存入 `TemplateSections` 副本）
- 模板修改不影响已创建的周报
- 模板修改后新周期的周报自动使用新模板

---

## 八、实现分期

### Phase 1：基础闭环（2 周）

**目标**：跑通"手动创建 → 编辑 → 提交 → 领导查看"全链路

| 功能点 | 说明 |
|--------|------|
| 团队模型 | Team + TeamMember CRUD |
| 模板管理 | 创建/编辑模板、绑定团队 |
| 周报 CRUD | 创建/编辑/提交/查看 |
| 状态机 | Draft → Submitted → Reviewed |
| 我的周报页 | 员工编辑器 |
| 团队面板 | 负责人查看成员周报列表 |

### Phase 2：自动采集（2 周）

**目标**：接入数据源，实现"确认式提交"

| 功能点 | 说明 |
|--------|------|
| Git 连接器 | 配置 Git 仓库、用户映射、定时拉取 |
| MAP 活动采集 | 查询 PRD/Defect/LLM 活动数据 |
| 每日打点 | Daily Log 快速记录 |
| AI 生成引擎 | 基于采集数据生成周报草稿 |
| 自动触发 | 定时任务周五自动生成 |

### Phase 3：管理增强（1 周）

**目标**：提升管理体验

| 功能点 | 说明 |
|--------|------|
| 团队汇总 | AI 自动汇总团队周报 |
| 评论系统 | 领导对周报评论 |
| 退回机制 | 退回 + 重新提交 |
| 通知系统 | 提醒/逾期/查阅通知 |
| 计划比对 | 上周计划 vs 本周实际 |

### Phase 4：体验优化（1 周）

**目标**：降低使用门槛

| 功能点 | 说明 |
|--------|------|
| SVN 连接器 | SVN 仓库接入 |
| 历史趋势 | 个人/团队趋势图表 |
| 导出功能 | PDF / Markdown 导出 |
| 桌面端打点 | Tauri 托盘快捷打点 |
| 假期/补报 | 请假标记、补报流程 |

---

## 九、技术实现要点

### 9.1 appKey 与路由

```
appKey: report-agent
路由前缀: api/report-agent/
前端路由: /report-agent
```

### 9.2 appCallerCode 注册

| Code | 说明 |
|------|------|
| `report-agent.generate::chat` | 周报草稿生成 |
| `report-agent.aggregate::chat` | 团队汇总生成 |
| `report-agent.polish::chat` | 内容润色 |

### 9.3 权限定义

| 权限点 | 说明 |
|--------|------|
| `report-agent.use` | 基础使用权限 |
| `report-agent.template.manage` | 模板管理 |
| `report-agent.team.manage` | 团队管理 |
| `report-agent.view.all` | 查看所有团队周报（管理员） |

### 9.4 定时任务

| 任务 | Cron | 说明 |
|------|------|------|
| Git 提交同步 | `0 */60 * * * *` | 每小时同步一次 |
| 周报自动生成 | 可配置（默认周五 16:00） | 按团队配置触发 |
| 提交提醒 | 可配置 | 按团队配置触发 |
| 逾期标记 | 每小时检查 | 超过截止+宽限期标记 Overdue |

---

## 十、验收标准

### 10.1 核心流程验收

- [ ] 管理员可创建团队并添加成员
- [ ] 团队负责人可创建模板并绑定团队
- [ ] 系统按时自动生成周报草稿
- [ ] 员工可编辑、补充、提交周报
- [ ] 领导可查看团队成员周报并标记已读
- [ ] 领导可退回周报并说明原因
- [ ] 逾期未提交者收到通知
- [ ] AI 汇总团队周报内容准确合理

### 10.2 数据准确性验收

- [ ] Git 提交记录与实际一致
- [ ] MAP 系统活动采集覆盖所有关联模块
- [ ] 每日打点数据完整保留
- [ ] 上周计划与本周实际比对正确

### 10.3 安全性验收

- [ ] 员工无法查看非本团队的周报
- [ ] Git AccessToken 加密存储且不在 API 响应中返回
- [ ] 代码 diff 内容不被存储
- [ ] 权限矩阵验证通过

---

## 附录 A：与竞品的差异

| 维度 | 传统周报工具 | MAP 周报 Agent |
|------|-------------|---------------|
| 数据来源 | 纯手动回忆 | 自动采集 + 手动补充 |
| 格式控制 | 无或弱 | 模板强约束 |
| 内容质量 | 取决于写作能力 | AI 保底表达质量 |
| 管理体验 | 逐份阅读 | AI 汇总 + 一键查阅 |
| 计划追踪 | 无 | 自动比对上周计划 |
| 组织洞察 | 无 | 趋势分析 + 总裁面板联动 |

---

## 附录 B：关联文档

| 文档 | 关系 |
|------|------|
| `doc/rule.agent-development.md` | Agent 开发交付流程（Phase 1-6） |
| `doc/rule.app-key-definition.md` | appKey 定义规范 |
| `doc/rule.app-feature-definition.md` | appCallerCode 命名规范 |
| `doc/weekly-report-2026-W06.md` | 现有周报样例（作为汇总输出的参考格式） |
| `doc/design.executive-dashboard.md` | 总裁面板（消费周报数据） |
