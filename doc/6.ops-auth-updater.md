# 桌面端更新与分布式登录/会话审计说明

## 1. 桌面端版本更新（Tauri Updater）

### 1.1 更新来源
- 更新源：GitHub Releases
- 客户端更新清单（manifest）：优先 `latest-{{target}}-{{arch}}.json`
  - `{{target}}`：`windows` / `darwin` / `linux`
  - `{{arch}}`：`x86_64` / `aarch64` / `i686` / `armv7`（取决于构建目标）
- 默认 endpoint：`https://github.com/inernoro/prd_agent/releases/latest/download/latest-{{target}}-{{arch}}.json`
  - 兼容兜底：
    - `latest-{{target}}.json`（旧命名）
    - `latest.json`（全平台聚合 manifest，要求 platforms 条目完整，否则会被客户端校验拒绝）

### 1.2 签名与校验
- GitHub Actions 使用 `TAURI_SIGNING_PRIVATE_KEY` / `TAURI_SIGNING_PRIVATE_KEY_PASSWORD` 对更新资产签名。
- 客户端需要内置 **public key** 进行验签：`prd-desktop/src-tauri/tauri.conf.json` 中的 `plugins.updater.pubkey`。

注意：仓库中不会存放任何私钥。`pubkey` 可以公开，但必须与 Actions 里使用的私钥配对，否则客户端会报“验签失败/无法安装更新”。  

### 1.3 Release 资产要求
Release 必须包含：
- 各平台安装包（`.msi/.dmg/.deb/.AppImage`）
- 对应签名文件（`*.sig`）
- `latest-{{target}}-{{arch}}.json` 与 `latest-{{target}}-{{arch}}.json.sig`
  - 兼容：如仍使用旧命名，则应包含 `latest-{{target}}.json` 与其 `.sig`

### 1.4 快速自检（排查 “Could not fetch a valid release JSON from the remote”）
- 直接在浏览器访问（按当前平台替换）：`https://github.com/inernoro/prd_agent/releases/latest/download/latest-{{target}}-{{arch}}.json`
  - 若返回 `{"error":"Not Found"}` / 404 / HTML 页面：说明 Release 未上传 manifest（或文件名不一致）
- 检查该 Release 的 Assets 列表中是否存在：
  - `latest-{{target}}-{{arch}}.json`、`latest-{{target}}-{{arch}}.json.sig`
  - 以及安装包对应的 `*.sig`

## 2. 分布式登录/会话：Nginx 负载均衡是否会掉登录？

结论：**不会因为 Nginx 轮询到不同后端实例而“随机掉登录”**（前提：Redis 共享 + JWT Secret 一致）。

### 2.1 当前实现要点（代码级）
- **Access Token**：JWT Bearer，无服务端粘性会话依赖。
- **Refresh 会话**：存 Redis（3 天滑动过期，按端独立：`userId + clientType + sessionKey`）。
- **踢下线/撤销**：`tokenVersion` 存 Redis；JWT 在 `OnTokenValidated` 阶段会校验 tokenVersion，不一致立即拒绝（401）。
- **业务会话（Session）**：`SessionService` 使用 `ICacheManager`（Redis）存储会话状态与 TTL，不依赖单实例内存。

### 2.2 多实例部署的强制约束（必须满足）
- **所有后端实例必须使用同一份 `Jwt__Secret`**（否则会出现“偶发 401”，看起来像随机掉登录）。  
  - docker-compose 生产：`docker-compose.yml` 已改为强制要求 `JWT_SECRET` 环境变量。
- **所有后端实例必须指向同一 Redis（或 Redis Cluster/Sentinel）**。  
  - Redis 不可用时，token 校验会失败，表现为 401（安全兜底）。

### 2.3 Nginx/网关层建议
- 你们的 Nginx 已针对 SSE 做了关键设置（`proxy_buffering off` 等）。  
- 由于认证不是 Cookie Session，不需要 sticky session（如 `ip_hash`）来“保登录”。  

### 2.4 额外注意（可选优化）
- 当前限流中间件（`RateLimitMiddleware`）使用进程内状态，多实例下限流不一致；如果需要“全局一致限流”，应迁移到 Redis。


