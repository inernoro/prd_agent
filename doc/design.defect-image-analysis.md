# 缺陷截图 VLM 预解析设计文档

**文档版本**：v1.0
**创建日期**：2026-02-27
**功能状态**：已实现

---

## 1. 问题背景

### 当前限制

缺陷提交对话框支持粘贴截图和拖拽文件，但 AI 润色功能只能处理纯文本：

```
用户输入文字 + 粘贴截图 → 点击 AI 润色 → 只发送文字给 LLM → 截图被忽略
```

用户截图中往往包含关键信息（红框标记、箭头指向、错误弹窗），这些信息对缺陷描述至关重要，但润色时完全丢失。

### 设计约束

- VLM（视觉语言模型）调用成本高，不应在每次润色时重复发送图片
- 图片分析不应阻塞用户输入流程
- 润色仍使用普通文本模型，保持低成本和快速响应

---

## 2. 设计方案：预解析 + 文本融合

### 2.1 核心思路

将「看图」和「润色」两个步骤解耦：

1. **上传时**：VLM 异步分析截图，提取缺陷描述（一次性）
2. **润色时**：把 VLM 提取的文字描述作为上下文，传给普通文本模型

### 2.2 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    缺陷提交对话框 (Frontend)                  │
│                                                             │
│  ┌──────────────┐    ┌──────────────────────────────────┐   │
│  │   文本输入区   │    │          附件预览区                │   │
│  │  (textarea)   │    │  ┌────┐  ┌────┐  ┌────┐         │   │
│  │  min-h: 280px │    │  │ 📷 │  │ 📷 │  │ 📄 │         │   │
│  │              │    │  │ ✓  │  │ ○  │  │    │         │   │
│  │              │    │  │done│  │分析│  │idle│         │   │
│  │              │    │  └────┘  └────┘  └────┘         │   │
│  │              │    │  ┌──────────────────────────┐    │   │
│  │              │    │  │ 🔍 AI 识别结果            │    │   │
│  │              │    │  │ "页面顶部导航栏显示404"    │    │   │
│  │              │    │  └──────────────────────────┘    │   │
│  └──────────────┘    └──────────────────────────────────┘   │
│                                                             │
│  [📎 附件] [严重性: 轻微] .............. [AI 润色] [提交缺陷] │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 数据流

```
                        ┌─────────────────────┐
                        │     用户操作          │
                        └──────┬──────────────┘
                               │
                 ┌─────────────┼─────────────┐
                 ▼                           ▼
        粘贴/拖拽截图                     输入文字描述
                 │                           │
                 ▼                           │
   ┌─────────────────────────┐              │
   │ 前端: File → base64     │              │
   │ 状态: analyzing         │              │
   └────────┬────────────────┘              │
            │ 异步、不阻塞                    │
            ▼                               │
   ┌─────────────────────────┐              │
   │ POST images/analyze     │              │
   │ ┌─────────────────────┐ │              │
   │ │ VLM (vision 模型)    │ │              │
   │ │                     │ │              │
   │ │ 系统提示词:          │ │              │
   │ │ "分析截图中标记的    │ │              │
   │ │  缺陷内容..."       │ │              │
   │ │                     │ │              │
   │ │ → description 文字  │ │              │
   │ └─────────────────────┘ │              │
   └────────┬────────────────┘              │
            │                               │
            ▼                               │
   状态: done ✓                             │
   description: "页面导航栏..."              │
            │                               │
            │    用户点击 [AI 润色]            │
            │         ┌─────────────────────┘
            ▼         ▼
   ┌─────────────────────────────────┐
   │ POST defects/polish             │
   │                                 │
   │ {                               │
   │   content: "用户输入的文字",      │
   │   templateId: "...",            │
   │   imageDescriptions: [          │
   │     "页面导航栏显示404错误..."    │  ← VLM 预解析结果
   │   ]                             │
   │ }                               │
   │                                 │
   │ ┌─────────────────────────────┐ │
   │ │ 普通 Chat 模型 (非 VLM)     │ │  ← 低成本
   │ │                             │ │
   │ │ user message:               │ │
   │ │ "请润色以下缺陷描述：        │ │
   │ │  {content}                  │ │
   │ │                             │ │
   │ │  用户截图的 AI 分析描述：     │ │
   │ │  1. {imageDescriptions[0]}  │ │
   │ │                             │ │
   │ │  请结合文字和截图分析，       │ │
   │ │  输出完整缺陷报告。"         │ │
   │ └─────────────────────────────┘ │
   │                                 │
   │ → polished content              │
   └─────────────────────────────────┘
```

---

## 3. 前端状态模型

### 3.1 AnalyzedAttachment

```typescript
interface AnalyzedAttachment {
  file: File;
  /** idle=非图片, analyzing=VLM分析中, done=完成, error=失败 */
  status: 'idle' | 'analyzing' | 'done' | 'error';
  /** VLM 提取的缺陷描述文字 */
  description?: string;
}
```

替换原有的 `File[]`，每个附件携带分析状态。

### 3.2 状态流转

```
添加非图片文件 → idle (无需分析)

添加图片文件 → analyzing → done (成功，带 description)
                        → error (失败，不影响提交)
```

### 3.3 缩略图 UI 状态

| 状态 | 缩略图表现 | 边框颜色 | 角标 |
|------|----------|---------|------|
| `analyzing` | 底部半透明条 + 旋转图标 + "解析中" | 默认 | - |
| `done` | 正常显示 | 绿色 `rgba(100,255,150,0.3)` | 绿色 ✓ |
| `error` | 正常显示 | 红色 `rgba(255,120,120,0.3)` | 红色 ⚠ |
| `idle` | 文件图标 + 文件名 | 默认 | - |

点击已分析完成的缩略图，展开绿色预览面板显示 AI 识别结果。

---

## 4. 后端 API

### 4.1 图片分析（新增）

```
POST /api/defect-agent/images/analyze

Request:
{
  "base64": "iVBORw0KGgo...",    // 图片 base64（不含 data: 前缀）
  "mimeType": "image/png"
}

Response:
{
  "success": true,
  "data": {
    "description": "截图显示管理后台的用户列表页面，红框标记了搜索按钮点击后无响应的区域，控制台可见一条 TypeError 错误。"
  }
}
```

**AppCallerCode**: `defect-agent.analyze-image::vision`
**模型类型**: `vision`（走 VLM 模型池）

**VLM 系统提示词**:

```
你是一个专业的缺陷截图分析助手。请仔细观察这张截图，提取以下信息：
1. 截图中被标记、圈出、箭头指向的问题区域
2. 界面上可见的错误信息或异常状态
3. 用户用红框、箭头、文字等标注的重点内容
4. 任何与缺陷相关的上下文信息（页面名称、操作步骤等）

请用简洁准确的语言描述截图中展示的缺陷内容（2-5句话）。直接输出描述，不要添加前缀或解释。
```

### 4.2 缺陷润色（修改）

```
POST /api/defect-agent/defects/polish

Request:
{
  "content": "用户输入的缺陷描述文字",
  "templateId": "可选的模板ID",
  "imageDescriptions": [          // 新增字段
    "截图1的AI分析描述...",
    "截图2的AI分析描述..."
  ]
}
```

**AppCallerCode**: `defect-agent.polish::chat`（不变）
**模型类型**: `chat`（普通文本模型，无需 VLM）

当 `imageDescriptions` 非空时，润色的 user message 会追加截图分析内容，引导模型结合图文输出完整缺陷报告。

---

## 5. 设计决策

### 5.1 为什么不在润色时直接传图片给 VLM？

| 方案 | 优点 | 缺点 |
|------|------|------|
| **A: 润色时传图** | 实现简单 | 每次润色都调用 VLM（贵）；用户看不到 AI 看了什么 |
| **B: 预解析 + 文本融合** ✅ | VLM 只调一次；用户可预览；润色用便宜模型 | 两步流程稍复杂 |

选择方案 B，核心原因：
1. **成本**：VLM 调用价格远高于普通 chat，图片只需看一次
2. **透明度**：用户能看到 AI 从截图中提取了什么，有问题可以手动补充
3. **解耦**：图片分析和文本润色互不依赖，失败互不影响

### 5.2 为什么用 base64 而不是先上传再传 URL？

- 图片 base64 是一次性用于分析的，不需要持久化
- 避免引入额外的上传→获取URL→传URL 三步流程
- 截图通常不大（几十KB到几MB），JSON 内嵌 base64 可接受

### 5.3 图片分析失败怎么办？

- **不阻塞提交**：`error` 状态的图片仍然作为普通附件上传
- **不阻塞润色**：润色时只收集 `done` 状态的描述，忽略失败的
- **UI 友好提示**：角标显示 ⚠，点击展开提示"图片分析失败，不影响缺陷提交"

---

## 6. 涉及文件

| 层 | 文件 | 改动说明 |
|---|------|---------|
| 后端 Registry | `AppCallerRegistry.cs` | 注册 `defect-agent.analyze-image::vision` |
| 后端 Controller | `DefectAgentController.cs` | 新增 `POST images/analyze`；`PolishDefectRequest` 增加 `imageDescriptions` |
| 前端 Contract | `contracts/defectAgent.ts` | 新增 `AnalyzeDefectImageContract` |
| 前端 API 路由 | `api.ts` | 新增 `analyzeImage()` 路由 |
| 前端 Service | `real/defectAgent.ts` | 实现 `analyzeDefectImageReal` |
| 前端 导出 | `index.ts` | 导出 `analyzeDefectImage` |
| 前端 UI | `GlobalDefectSubmitDialog.tsx` | `File[]` → `AnalyzedAttachment[]` + 异步分析 + 状态角标 + 预览面板 |
| 前端 UI | `DefectSubmitPanel.tsx` | 同上 |

---

## 7. AppCallerCode 注册

| AppCallerCode | 模型类型 | 用途 |
|---------------|---------|------|
| `defect-agent.analyze-image::vision` | vision | 截图缺陷分析（VLM） |
| `defect-agent.polish::chat` | chat | 缺陷描述润色（已有，未改） |
| `defect-agent.review::chat` | chat | 缺陷审核对话（已有，未改） |
| `defect-agent.extract::chat` | chat | 信息提取结构化（已有，未改） |
