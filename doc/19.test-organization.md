# 测试组织文档

> 版本: 1.0 | 最后更新: 2026-01-25

## 1. 测试分类概述

项目测试分为两大类别：

| 类别 | 说明 | 运行环境 | 数据来源 |
|------|------|---------|---------|
| **CI 测试** | 自动化持续集成测试 | GitHub Actions / 本地 | 内存数据、Mock |
| **集成测试** | 需要真实外部服务的测试 | 本地 / 专用环境 | 真实外部服务 |

## 2. 测试分类标记

使用 xUnit 的 `[Trait]` 特性标记测试分类：

```csharp
// CI 测试标记
[Trait("Category", TestCategories.CI)]
[Trait("Category", TestCategories.Unit)]
public class MyUnitTests { ... }

// 集成测试标记
[Trait("Category", TestCategories.Integration)]
public class MyIntegrationTests { ... }
```

### 2.1 可用分类

| 分类 | 常量 | 说明 |
|------|------|------|
| CI | `TestCategories.CI` | 适合CI运行，内存数据 |
| Integration | `TestCategories.Integration` | 需要真实外部服务 |
| Unit | `TestCategories.Unit` | 纯单元测试 |
| Image | `TestCategories.Image` | 图像处理相关 |
| Concurrency | `TestCategories.Concurrency` | 并发测试 |

## 3. 测试运行命令

### 3.1 仅 CI 测试（推荐日常开发使用）

```bash
# 运行所有 CI 分类测试
dotnet test PrdAgent.sln --filter "Category=CI"

# 或使用脚本
./scripts/test-ci.sh
```

### 3.2 仅集成测试

```bash
# 运行集成测试（需配置环境变量）
dotnet test PrdAgent.sln --filter "Category=Integration"

# 或使用脚本
./scripts/test-integration.sh
```

### 3.3 运行所有测试

```bash
# 运行全部测试
dotnet test PrdAgent.sln

# 或使用脚本
./scripts/test-all.sh
```

### 3.4 排除特定分类

```bash
# 排除集成测试
dotnet test PrdAgent.sln --filter "Category!=Integration"

# 仅运行单元测试
dotnet test PrdAgent.sln --filter "Category=Unit"
```

### 3.5 前端测试

```bash
cd prd-admin

# 监听模式（开发）
pnpm test

# CI 模式（一次运行）
pnpm test --run
```

## 4. 测试文件清单

### 4.1 CI 测试（内存数据）

| 目录 | 测试文件 | 测试类型 |
|------|---------|---------|
| `Run/` | ChatRunSuiteTests.cs | Unit |
| `Run/` | ChatRunWorkerTests.cs | Unit |
| `Run/` | InMemoryRunEventStoreTests.cs | Unit |
| `Run/` | RunConcurrencyAndCompatibilityTests.cs | Concurrency |
| `Services/` | CanvasPatchLogicTests.cs | Unit |
| `Services/` | GroupNameHeuristicsTests.cs | Unit |
| `Services/` | IdGeneratorTests.cs | Unit |
| `Services/` | ImageGenModelAdapterTests.cs | Unit |
| `Services/` | JwtServiceTests.cs | Unit |
| `Services/` | MarkdownParserTests.cs | Unit |
| `Services/` | ModelPoolSchedulingTests.cs | Unit |
| `Services/` | ModelReclassifyParserTests.cs | Unit |
| `Services/` | ModelsListStatusFilterTests.cs | Unit |
| `Services/` | ModelsListTagAdapterTests.cs | Unit |
| `Services/` | MongoIdConventionTests.cs | Unit |
| `Services/` | MongoIdSerializationTests.cs | Unit |
| `Services/` | OpenAICompatUrlTests.cs | Unit |
| `Services/` | RoundedRectangleTests.cs | Image |
| `Services/` | WatermarkFontRegistryTests.cs | Unit |
| `Services/` | WatermarkRendererTests.cs | Image |
| `Services/` | WatermarkSpecValidatorTests.cs | Unit |

### 4.2 集成测试（真实外部服务）

| 目录 | 测试文件 | 依赖服务 | 环境变量 |
|------|---------|---------|---------|
| `Services/` | TencentCosStorageTests.cs | 腾讯云 COS | `TENCENT_COS_*` |

## 5. 集成测试环境变量

### 5.1 腾讯云 COS 测试

```bash
# 必需
export TENCENT_COS_BUCKET="your-bucket-name"
export TENCENT_COS_REGION="ap-guangzhou"
export TENCENT_COS_SECRET_ID="your-secret-id"
export TENCENT_COS_SECRET_KEY="your-secret-key"

# 可选
export TENCENT_COS_PUBLIC_BASE_URL="https://your-cdn.com"
export TENCENT_COS_PREFIX="data/assets"
export TENCENT_COS_TEST_CLEANUP="true"  # 测试后自动清理
```

## 6. CI 配置

GitHub Actions 工作流 (`.github/workflows/ci.yml`) 已配置为：

1. **后端测试**: 仅运行 `Category=CI` 的测试
2. **前端测试**: 运行 `pnpm test --run`

```yaml
# 后端 CI 测试
- name: Run CI tests
  run: dotnet test PrdAgent.sln -c Release --no-build --filter "Category=CI"

# 前端 CI 测试
- name: Run tests
  run: pnpm test --run
```

## 7. 添加新测试的规范

### 7.1 CI 测试（推荐）

```csharp
using Xunit;

namespace PrdAgent.Api.Tests.Services;

[Trait("Category", TestCategories.CI)]
[Trait("Category", TestCategories.Unit)]
public class MyNewServiceTests
{
    [Fact]
    public void MyMethod_ShouldWork()
    {
        // 使用内存数据或 Mock
        var mock = new Mock<IMyDependency>();
        // ...
    }
}
```

### 7.2 集成测试

```csharp
using Xunit;

namespace PrdAgent.Api.Tests.Services;

/// <summary>
/// 需要真实外部服务的测试
/// 环境变量: MY_SERVICE_API_KEY
/// </summary>
[Trait("Category", TestCategories.Integration)]
public class MyExternalServiceTests
{
    [Fact]
    public async Task CallExternalApi_ShouldSucceed()
    {
        var apiKey = Environment.GetEnvironmentVariable("MY_SERVICE_API_KEY");
        if (string.IsNullOrEmpty(apiKey))
        {
            // 未配置环境变量时跳过测试
            return;
        }

        // 使用真实 API
        // ...
    }
}
```

## 8. 测试覆盖率

生成测试覆盖率报告：

```bash
cd prd-api

# 运行测试并收集覆盖率
dotnet test PrdAgent.sln \
    --filter "Category=CI" \
    /p:CollectCoverage=true \
    /p:CoverletOutputFormat=opencover \
    /p:CoverletOutput=./coverage/

# 覆盖率报告位于 ./coverage/ 目录
```

## 9. 测试统计

| 类别 | .NET 测试 | React 测试 | 总计 |
|------|----------|-----------|------|
| CI 测试 | ~95 | ~96 | ~191 |
| 集成测试 | 1 | 0 | 1 |
| **总计** | **~96** | **~96** | **~192** |

## 10. 最佳实践

1. **优先编写 CI 测试**: 使用 Mock 和内存数据，确保测试可在任何环境快速运行
2. **集成测试谨慎使用**: 仅在必须验证真实外部服务行为时使用
3. **环境变量检查**: 集成测试必须检查环境变量，缺失时优雅跳过
4. **文档更新**: 新增集成测试时更新本文档的环境变量部分
5. **分类标记**: 每个测试类必须添加 `[Trait("Category", ...)]` 标记
