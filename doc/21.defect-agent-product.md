# 缺陷管理 Agent 产品方案

> 智能化的缺陷提交与跟踪系统，让缺陷管理从繁琐变高效。

---

## 产品定位

**一句话描述**：用对话的方式提交缺陷，用看板的方式跟踪进度。

**目标用户**：
- 测试人员：快速提交缺陷，减少填表负担
- 开发人员：清晰了解缺陷详情，高效处理
- 项目经理：掌握整体缺陷态势，及时决策

**核心价值**：
1. **降低提交门槛**：自然语言描述 → AI 结构化提取
2. **加速处理流程**：状态驱动 + 消息协作
3. **减少信息丢失**：版本历史 + 附件管理

---

## 一、缺陷生命周期

### 状态流转

```
                    ┌──────────────┐
                    │    Draft     │ ← 新建/编辑中
                    │    草稿      │
                    └──────┬───────┘
                           │ 提交
                           ▼
                    ┌──────────────┐
         ┌─────────│   Pending    │──────────┐
         │ 拒绝    │    待处理    │   接手   │
         │         └──────────────┘          │
         ▼                                   ▼
  ┌──────────────┐                    ┌──────────────┐
  │   Rejected   │                    │   Working    │
  │    已拒绝    │                    │   处理中     │
  └──────────────┘                    └──────┬───────┘
                                             │ 解决
                                             ▼
                                      ┌──────────────┐
                           ┌──────────│   Resolved   │
                           │ 重开     │    已解决    │
                           │          └──────┬───────┘
                           │                 │ 确认关闭
                           │                 ▼
                           │          ┌──────────────┐
                           └──────────│    Closed    │
                                      │    已关闭    │
                                      └──────────────┘
```

### 状态说明

| 状态 | 触发动作 | 可操作人 | 下一步 |
|------|----------|----------|--------|
| Draft | 创建缺陷 | 提交人 | 提交 / 删除 |
| Pending | 提交缺陷 | 被指派人 | 接手 / 拒绝 |
| Working | 接手处理 | 被指派人 | 解决 |
| Resolved | 标记解决 | 提交人 | 关闭 / 重开 |
| Rejected | 拒绝处理 | 提交人 | 重开 |
| Closed | 确认关闭 | - | 归档 |

---

## 二、缺陷提交

### 设计理念

**"说人话，系统懂"**

传统缺陷系统要求填写大量表单字段，用户负担重且容易遗漏。本系统采用对话式提交，用户只需描述问题，AI 自动提取结构化信息。

### 提交流程

```
用户输入自然语言描述
        │
        ▼
   AI 结构化提取
   ├── 标题
   ├── 重现步骤
   ├── 预期结果
   ├── 实际结果
   └── 严重程度建议
        │
        ▼
   用户确认/补充
        │
        ▼
   选择指派人 → 提交
```

### 严重程度

| 级别 | 标识 | 定义 | 示例 |
|------|------|------|------|
| Critical | 🔴 | 系统崩溃/数据丢失 | 支付后订单消失 |
| Major | 🟠 | 主流程阻断 | 无法登录 |
| Minor | 🟡 | 功能异常但可绕过 | 按钮位置错位 |
| Trivial | 🟢 | 体验问题 | 文案错别字 |

### 优先级

| 级别 | 定义 |
|------|------|
| Urgent | 立即处理，阻塞发布 |
| High | 当前迭代必须解决 |
| Medium | 计划内解决 |
| Low | 有空再说 |

---

## 三、模板系统

### 设计理念

**"不同场景，不同问法"**

不同类型的缺陷需要收集不同的信息。模板定义了 AI 应该提取哪些字段，以及如何引导用户补充。

### 模板结构

```
模板
├── 基本信息
│   ├── 名称
│   └── 描述
├── 必填字段列表
│   ├── 字段名
│   ├── 字段类型 (text/textarea/select/number)
│   ├── 是否必填
│   └── 选项列表 (select 类型)
└── AI 系统提示词
    └── 指导 AI 如何提取和补充信息
```

### 预置模板

| 模板 | 适用场景 | 核心字段 |
|------|----------|----------|
| 通用缺陷 | 功能 Bug | 重现步骤、预期/实际结果 |
| UI 问题 | 界面异常 | 页面位置、截图、设备信息 |
| 性能问题 | 响应慢/卡顿 | 操作场景、耗时、数据量 |
| 兼容性 | 特定环境问题 | 浏览器/系统版本、设备型号 |

### 模板共享

- 用户可创建个人模板
- 可将模板分享给指定用户
- 被分享者可基于模板再创建副本

---

## 四、AI 润色

### 设计理念

**"让描述更专业"**

用户的口语化描述可能不够清晰规范。AI 润色功能将其转化为结构化、专业化的缺陷报告。

### 润色效果

**润色前**：
> 那个页面点了没反应，等了好久才出来，有时候还报错

**润色后**：
> **问题描述**：订单列表页面响应缓慢
>
> **重现步骤**：
> 1. 进入订单管理模块
> 2. 点击"订单列表"菜单
> 3. 等待页面加载
>
> **实际结果**：页面加载耗时约 10 秒，偶发接口报错
>
> **预期结果**：页面应在 2 秒内完成加载

---

## 五、消息协作

### 设计理念

**"沟通留痕，上下文不断"**

缺陷处理过程中需要反复沟通。消息系统将所有对话集中在缺陷详情页，避免信息散落在微信、邮件等渠道。

### 消息类型

| 类型 | 说明 | 示例 |
|------|------|------|
| user | 用户发送的消息 | "这个问题在 iOS 上也有" |
| assistant | AI 回复/提取结果 | "已识别：设备类型=iOS" |
| system | 系统自动消息 | "张三 将状态改为 处理中" |

### 消息特性

- 支持附件引用（图片、日志等）
- 消息按时间序列排列
- 支持 `afterSeq` 增量拉取（断线重连）

---

## 六、附件管理

### 支持类型

| 类别 | 格式 | 用途 |
|------|------|------|
| 图片 | PNG/JPG/GIF | 截图、录屏 GIF |
| 视频 | MP4/MOV | 操作录屏 |
| 日志 | TXT/LOG | 错误日志 |
| 文档 | PDF/DOC | 需求文档引用 |

### 存储方案

- 上传至对象存储（COS）
- 生成预签名 URL 供预览
- 附件与缺陷/消息关联

---

## 七、版本历史

### 设计理念

**"改了什么，一目了然"**

缺陷描述可能多次修改。版本历史记录每次变更，支持对比和回溯。

### 记录内容

每个版本记录：
- 版本号（自增）
- 修改人
- 修改时间
- 变更备注
- 当时的完整内容快照

### 版本对比

支持任意两个版本的 Diff 对比，高亮显示：
- 新增内容（绿色）
- 删除内容（红色）
- 修改内容（黄色）

---

## 八、统计分析

### 概览指标

| 指标 | 说明 |
|------|------|
| 总数 | 系统内缺陷总数 |
| 按状态 | 各状态的缺陷数量分布 |
| 按严重程度 | 各级别的缺陷数量分布 |
| 我提交的 | 当前用户提交的缺陷数 |
| 指派给我 | 分配给当前用户的缺陷数 |

### 扩展方向

1. **趋势图表**：按日/周/月的新增/关闭趋势
2. **处理效率**：平均处理时长、超期率
3. **人员负载**：各成员的待处理数量

---

## 九、文件夹分类

### 设计理念

**"让用户用自己的方式组织"**

系统预设的筛选（状态、优先级）是固定视角，但每个团队都有自己的整理习惯。文件夹让用户按项目、模块、迭代等维度自由归类。

### 核心功能

| 功能 | 说明 |
|------|------|
| 创建文件夹 | 自定义名称、颜色、图标 |
| 移动归类 | 将缺陷拖入文件夹 |
| 批量移动 | 多选后一次性归入 |
| 删除文件夹 | 内容自动移回"未分类" |

### 视图结构

```
左侧边栏
├── 📁 v2.0迭代 (5)
├── 📁 支付模块 (12)
├── 📁 移动端问题 (3)
└── 📂 未分类 (8)
```

---

## 十、回收站

### 设计理念

**"删除不是终点"**

误操作不可避免，软删除给用户后悔的机会。

### 功能说明

| 操作 | 说明 |
|------|------|
| 删除 | 移入回收站，列表不再显示 |
| 回收站 | 查看已删除项，按删除时间倒序 |
| 恢复 | 还原到原位置 |
| 永久删除 | 彻底清除，不可恢复 |

### 用户体验

- 删除无需二次确认（因为可恢复）
- 回收站入口在右上角
- 永久删除需二次确认

---

## 十一、空间隔离

### 设计理念

**"现在共享，未来可分"**

当前阶段所有用户共享数据，促进协作。数据层预埋 `spaceId` 字段，未来可按团队拆分。

### 当前阶段

所有用户共享同一空间，互相可见所有文件夹和缺陷。

### 未来阶段

| 场景 | 行为 |
|------|------|
| 团队 A | 只能看到 `spaceId = "team-a"` 的数据 |
| 团队 B | 只能看到 `spaceId = "team-b"` 的数据 |
| 跨团队 | 系统拒绝，提示"无权限" |

---

## 数据模型概览

```
DefectTemplate (模板)
├── id, name, description
├── requiredFields[]
├── aiSystemPrompt
└── sharedWith[]

DefectReport (缺陷)
├── 基本: id, defectNo, title, rawContent
├── 结构化: structuredData, templateId
├── 状态: status, severity, priority
├── 人员: reporterUserId, assigneeUserId
├── 处理: resolution, rejectReason
├── 时间: createdAt, resolvedAt, closedAt
├── 版本: version, versions[]
├── 附件: attachments[]
├── 软删除: isDeleted, deletedAt, deletedBy
└── 分类: folderId

DefectFolder (文件夹)
├── id, name, color, icon
├── sortOrder
└── spaceId

DefectMessage (消息)
├── id, defectId, seq
├── role, content
└── attachmentIds[]
```

---

## 技术架构

```
┌─────────────────────────────────────────────────────────┐
│                    prd-admin (React)                    │
│  DefectListPage → DefectDetailPanel → DefectChatBox    │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                  prd-api (.NET 8)                       │
│              DefectAgentController                      │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐   │
│  │Templates│ │ Defects │ │Messages │ │Folders/Trash│   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────────┘   │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                      MongoDB                            │
│  defect_templates | defect_reports | defect_messages    │
│                   | defect_folders                      │
└─────────────────────────────────────────────────────────┘
```

---

## 扩展路线图

### 短期 (已规划)

- [ ] 自动清理：回收站 30 天自动永久删除
- [ ] 批量操作：多选删除、批量状态变更
- [ ] 导出功能：导出为 Excel/PDF

### 中期

- [ ] 评论@提醒：消息中@用户触发通知
- [ ] 关联缺陷：标记重复/相关缺陷
- [ ] 自定义字段：用户可添加自定义字段

### 长期

- [ ] 空间隔离上线：按团队拆分数据
- [ ] 智能分类：AI 自动建议所属模块
- [ ] 趋势预警：缺陷激增自动告警

---

*版本: 1.0 | 最后更新: 2026-01-27*
