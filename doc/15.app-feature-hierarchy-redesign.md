# 应用-子功能层级重构设计

## 背景

用户反馈：
1. 当前的应用列表太扁平，缺乏层级结构
2. 应该按前缀分组，例如 `PrdDesktop.Chat.SendMessage` 应该分为：
   - 应用组：PrdDesktop
   - 子功能：Chat
   - 具体功能：SendMessage
3. 模型需求应该可以直接添加模型，而不是只选择分组

## 新的数据结构

### 1. 应用（Application）

```typescript
interface Application {
  id: string;
  code: string;              // prd-desktop, visual-agent, open-platform
  name: string;              // PRD Desktop, 视觉创作 Agent, 开放平台
  description: string;
  icon?: string;
  features: Feature[];       // 子功能列表
  stats: ApplicationStats;
}
```

### 2. 子功能（Feature）

```typescript
interface Feature {
  id: string;
  code: string;              // chat, prd-analysis, image-generation
  name: string;              // 聊天对话, PRD 分析, 图片生成
  description: string;
  modelRequirements: ModelRequirement[];
  isEnabled: boolean;
  stats: FeatureStats;
}
```

### 3. 模型需求（Model Requirement）

```typescript
interface ModelRequirement {
  id: string;
  modelType: string;         // chat, vision, image-gen
  purpose: string;           // 用途说明
  models: AssignedModel[];   // 分配的模型列表（按优先级排序）
  isRequired: boolean;
}

interface AssignedModel {
  platformId: string;
  modelId: string;
  displayName: string;
  priority: number;          // 优先级（数字越小优先级越高）
  isEnabled: boolean;
}
```

## 前端展示结构

### 左侧：应用树形列表

```
┌─────────────────────────────────┐
│ 搜索应用...                      │
├─────────────────────────────────┤
│ 📱 PRD Desktop              [>] │  ← 应用组（可展开/折叠）
│   ├─ 💬 Chat                    │  ← 子功能
│   │   ├─ SendMessage            │  ← 具体功能
│   │   └─ IntentRecognition      │
│   ├─ 📄 PRD                     │
│   │   ├─ Analyze                │
│   │   └─ Preview                │
│   └─ 🔍 Gap                     │
│       ├─ Detect                 │
│       └─ Summarize              │
├─────────────────────────────────┤
│ 🎨 Visual Agent             [>] │
│   ├─ 🖼️ Image                  │
│   │   ├─ Generation            │
│   │   ├─ Analysis              │
│   │   └─ Verification          │
│   └─ 💬 Creative               │
│       └─ Chat                   │
├─────────────────────────────────┤
│ ✍️ Literary Agent           [>] │
│   ├─ 📝 Content                │
│   │   ├─ Generation            │
│   │   └─ Polishing             │
│   └─ 🖼️ Illustration           │
│       └─ Generation             │
├─────────────────────────────────┤
│ 🔌 Open Platform            [>] │
│   └─ 🔄 Proxy                  │
│       ├─ Chat                   │
│       ├─ Embedding              │
│       └─ Rerank                 │
├─────────────────────────────────┤
│ ⚙️ PRD Admin                [>] │
│   ├─ 🧪 Lab                    │
│   │   └─ Experiments           │
│   └─ 🧪 Model                  │
│       └─ Testing                │
└─────────────────────────────────┘
```

### 右侧：子功能详情

```
┌─────────────────────────────────────────────┐
│ 💬 Chat - SendMessage                       │
│ 用户在桌面端发送聊天消息                     │
├─────────────────────────────────────────────┤
│ 模型需求                                     │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ 对话模型 (chat)                    [+]  │ │
│ │ 用途：生成回复内容                       │ │
│ │                                         │ │
│ │ 已分配模型：                             │ │
│ │ ┌─────────────────────────────────────┐ │ │
│ │ │ 1. 轨迹流动 / DeepSeek-V3     [启用] │ │ │
│ │ │    优先级：1                    [↑↓] │ │ │
│ │ │    [编辑] [删除]                     │ │ │
│ │ └─────────────────────────────────────┘ │ │
│ │ ┌─────────────────────────────────────┐ │ │
│ │ │ 2. OpenAI / GPT-4              [启用] │ │ │
│ │ │    优先级：2                    [↑↓] │ │ │
│ │ │    [编辑] [删除]                     │ │ │
│ │ └─────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ 意图识别 (intent)                  [+]  │ │
│ │ 用途：快速识别用户意图                   │ │
│ │                                         │ │
│ │ 已分配模型：                             │ │
│ │ ┌─────────────────────────────────────┐ │ │
│ │ │ 1. OpenAI / GPT-3.5-turbo     [启用] │ │ │
│ │ │    优先级：1                    [↑↓] │ │ │
│ │ │    [编辑] [删除]                     │ │ │
│ │ └─────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ [添加模型需求]                               │
└─────────────────────────────────────────────┘
```

## 添加模型流程

### 1. 点击模型需求卡片的 [+] 按钮

弹出"添加模型"对话框（参照实验室）

### 2. 对话框结构

```
┌─────────────────────────────────────────────┐
│ 添加模型                                [×] │
│ 为"对话模型"添加模型                         │
├─────────────────────────────────────────────┤
│ [按平台添加] [按现有分组添加]                │
├─────────────────────────────────────────────┤
│ 中栏：选择平台和模型                         │
│                                             │
│ 平台：OpenAI                                │
│ ┌─────────────────────────────────────────┐ │
│ │ □ GPT-4                                 │ │
│ │ □ GPT-3.5-turbo                         │ │
│ │ □ GPT-4-turbo                           │ │
│ └─────────────────────────────────────────┘ │
├─────────────────────────────────────────────┤
│ 下栏：已选择的模型                           │
│                                             │
│ 已选择 2 个模型：                            │
│ - OpenAI / GPT-4                            │
│ - OpenAI / GPT-3.5-turbo                    │
│                                             │
│                          [取消] [确认添加]  │
└─────────────────────────────────────────────┘
```

### 3. 确认后

- 将选中的模型添加到模型需求的 `models` 列表
- 自动分配优先级（按添加顺序）
- 默认启用所有模型

## 数据迁移

### 从旧结构迁移到新结构

**旧结构**：
```typescript
{
  appCode: "prd-desktop.chat",
  displayName: "桌面端-聊天对话",
  modelRequirements: [
    { modelType: "chat", purpose: "生成回复", modelGroupId: "group-123" }
  ]
}
```

**新结构**：
```typescript
{
  application: {
    code: "prd-desktop",
    name: "PRD Desktop",
    features: [
      {
        code: "chat",
        name: "聊天对话",
        modelRequirements: [
          {
            modelType: "chat",
            purpose: "生成回复",
            models: [
              { platformId: "xxx", modelId: "deepseek-v3", priority: 1 },
              { platformId: "yyy", modelId: "gpt-4", priority: 2 }
            ]
          }
        ]
      }
    ]
  }
}
```

### 迁移策略

1. **解析 appCode**：
   - `prd-desktop.chat` → `{ app: "prd-desktop", feature: "chat" }`
   - `visual-agent.image-generation` → `{ app: "visual-agent", feature: "image-generation" }`

2. **分组应用**：
   - 按 `app` 分组
   - 每个 `app` 下的 `feature` 作为子功能

3. **模型分组 → 模型列表**：
   - 如果 `modelGroupId` 存在，查询该分组的模型列表
   - 将分组中的模型展开为 `models` 列表

## 后端 API 设计

### 1. 获取应用树

```
GET /api/v1/admin/applications/tree

Response:
{
  "success": true,
  "data": {
    "applications": [
      {
        "code": "prd-desktop",
        "name": "PRD Desktop",
        "features": [
          {
            "code": "chat",
            "name": "聊天对话",
            "modelRequirements": [...]
          }
        ]
      }
    ]
  }
}
```

### 2. 更新子功能的模型需求

```
PUT /api/v1/admin/applications/{appCode}/features/{featureCode}/model-requirements/{requirementId}

Body:
{
  "models": [
    { "platformId": "xxx", "modelId": "deepseek-v3", "priority": 1, "isEnabled": true },
    { "platformId": "yyy", "modelId": "gpt-4", "priority": 2, "isEnabled": true }
  ]
}
```

### 3. 添加模型到模型需求

```
POST /api/v1/admin/applications/{appCode}/features/{featureCode}/model-requirements/{requirementId}/models

Body:
{
  "models": [
    { "platformId": "xxx", "modelId": "deepseek-v3" },
    { "platformId": "yyy", "modelId": "gpt-4" }
  ]
}
```

## 实现步骤

### 阶段 1：数据结构重构（后端）

1. ✅ 创建新的数据模型（Application, Feature, ModelRequirement）
2. ✅ 实现数据迁移脚本（从旧结构迁移到新结构）
3. ✅ 实现新的 API 端点

### 阶段 2：前端树形展示

1. ✅ 创建树形组件（可展开/折叠）
2. ✅ 实现应用分组逻辑
3. ✅ 实现子功能列表

### 阶段 3：模型选择器

1. ✅ 复用实验室的 ModelPickerDialog
2. ✅ 适配到模型需求场景
3. ✅ 实现模型列表的优先级排序

### 阶段 4：模型管理

1. ✅ 实现模型的启用/禁用
2. ✅ 实现模型的优先级调整
3. ✅ 实现模型的删除

## 优势

### 1. 清晰的层级结构
- 应用 → 子功能 → 模型需求 → 具体模型
- 一目了然，易于理解

### 2. 灵活的模型配置
- 每个模型需求可以配置多个模型
- 支持优先级排序
- 支持启用/禁用

### 3. 更好的扩展性
- 新增应用：只需添加到应用列表
- 新增子功能：只需添加到应用的 features
- 新增模型：只需添加到模型需求的 models

### 4. 更好的用户体验
- 树形结构直观
- 模型选择器方便
- 优先级调整简单

## 注意事项

### 1. 性能优化
- 应用树可能很大，需要虚拟滚动
- 模型列表需要分页

### 2. 数据一致性
- 删除模型时，需要同步删除所有引用
- 删除平台时，需要同步删除所有该平台的模型

### 3. 向后兼容
- 旧的 API 需要保留一段时间
- 提供数据迁移工具

## 总结

这个重构将大幅提升应用管理的用户体验，使得应用、子功能、模型需求的层级关系更加清晰，模型配置更加灵活。
