# PRD-Publish 产品需求文档

> 版本：v1.0 | 作者：Claude | 日期：2026-01-26

---

## 1. 产品概述

### 1.1 背景

随着项目迭代频率增加，开发者需要在各种场景（包括移动端、无电脑环境）快速执行发布操作。现有发布流程依赖本地终端，操作繁琐且不便远程执行。

### 1.2 产品定位

**PRD-Publish** 是一个独立的轻量级发布管理系统，提供：
- 一键发布/回退到任意 Git 版本
- 移动端友好的响应式界面
- 极简配置，开箱即用
- 科幻风格的现代化 UI

### 1.3 核心价值

| 价值点 | 描述 |
|--------|------|
| **随时随地** | 手机、平板、电脑均可操作发布 |
| **一键操作** | 选择版本 → 点击发布，无需命令行 |
| **版本可视** | 清晰展示提交历史，精准选择目标版本 |
| **安全可控** | 独立认证，发布历史可追溯 |

---

## 2. 用户故事

| 编号 | 角色 | 故事 | 优先级 |
|------|------|------|--------|
| US-01 | 开发者 | 在手机上查看最新提交并一键发布 | P0 |
| US-02 | 开发者 | 快速回退到指定历史版本 | P0 |
| US-03 | 开发者 | 查看当前运行版本和发布历史 | P0 |
| US-04 | 开发者 | 通过 Tag 发布稳定版本 | P1 |
| US-05 | 开发者 | 实时查看发布执行日志 | P1 |
| US-06 | 运维 | 简单配置即可部署服务 | P0 |

---

## 3. 功能需求

### 3.1 认证模块

#### 3.1.1 登录

- **认证方式**：环境变量配置固定账号密码
- **会话管理**：JWT Token，有效期 7 天
- **安全特性**：
  - 登录失败 5 次锁定 15 分钟
  - Token 支持手动失效（登出）

#### 3.1.2 配置项

```bash
PUBLISH_USERNAME=admin          # 登录用户名
PUBLISH_PASSWORD=your-secret    # 登录密码
PUBLISH_JWT_SECRET=random-key   # JWT 签名密钥
```

### 3.2 版本管理模块

#### 3.2.1 提交列表

| 字段 | 说明 | 示例 |
|------|------|------|
| 短 Hash | 7 位 commit id | `a1b2c3d` |
| 提交消息 | commit message（截断 80 字符） | `feat: Add login page` |
| 作者 | 提交作者 | `张三` |
| 时间 | 相对时间 | `2 小时前` |
| Tag | 关联的 tag（如有） | `v1.2.0` |

#### 3.2.2 筛选功能

- 按分支筛选（默认当前分支）
- 按 Tag 筛选
- 搜索提交消息
- 分页加载（每页 20 条）

#### 3.2.3 当前版本

- 显示当前运行的 commit
- 高亮标识

### 3.3 发布模块

#### 3.3.1 发布流程

```
用户选择版本 → 确认发布 → 执行 exec.sh → 实时日志 → 完成/失败
```

#### 3.3.2 执行脚本

- 路径可配置：`PUBLISH_EXEC_SCRIPT=./exec.sh`
- 传参：`exec.sh <commit_id> <short_hash> <branch>`
- 超时：可配置，默认 5 分钟

#### 3.3.3 实时日志

- SSE 推送执行输出
- 支持 ANSI 颜色渲染
- 自动滚动到底部
- 可复制完整日志

#### 3.3.4 发布锁

- 同一时间只允许一个发布任务
- 显示当前发布状态和进度

### 3.4 历史记录模块

#### 3.4.1 发布历史

| 字段 | 说明 |
|------|------|
| 发布时间 | 执行时间 |
| 目标版本 | commit hash |
| 发布结果 | 成功/失败 |
| 耗时 | 执行时长 |
| 操作人 | 登录用户 |

#### 3.4.2 存储

- JSON 文件存储（`publish-history.json`）
- 保留最近 100 条记录

### 3.5 系统状态模块

#### 3.5.1 状态面板

- 当前运行版本
- 服务运行时长
- 最近一次发布信息
- Git 仓库状态（是否有未提交更改）

---

## 4. 界面设计

### 4.1 设计原则

| 原则 | 说明 |
|------|------|
| **极简** | 核心操作一目了然，无冗余元素 |
| **科幻感** | 深色主题、渐变、微光效果、毛玻璃 |
| **响应式** | 移动端优先，桌面端自适应 |
| **即时反馈** | 操作有明确的视觉反馈 |

### 4.2 页面结构

```
┌─────────────────────────────────────────┐
│  PRD-Publish                    [登出]  │  ← Header
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    │
│  │  当前版本: a1b2c3d              │    │  ← 状态卡片
│  │  上次发布: 2小时前 ✓ 成功       │    │
│  └─────────────────────────────────┘    │
├─────────────────────────────────────────┤
│  [Commits]  [Tags]  [History]           │  ← Tab 切换
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    │
│  │ 🔍 搜索提交...                  │    │  ← 搜索栏
│  └─────────────────────────────────┘    │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │ ● a1b2c3d  feat: Add feature   │    │  ← 版本列表
│  │   张三 · 2小时前         [发布] │    │
│  ├─────────────────────────────────┤    │
│  │ ○ b2c3d4e  fix: Bug fix        │    │
│  │   李四 · 5小时前         [发布] │    │
│  ├─────────────────────────────────┤    │
│  │ ○ c3d4e5f  v1.2.0 🏷️           │    │
│  │   王五 · 1天前           [发布] │    │
│  └─────────────────────────────────┘    │
│                                         │
│  [加载更多...]                          │
└─────────────────────────────────────────┘
```

### 4.3 移动端适配

#### 4.3.1 断点

| 断点 | 宽度 | 布局调整 |
|------|------|----------|
| Mobile | < 640px | 单列，全宽按钮 |
| Tablet | 640-1024px | 双列可选 |
| Desktop | > 1024px | 最大宽度 800px 居中 |

#### 4.3.2 移动端优化

- 触摸友好：按钮最小 44px
- 手势支持：下拉刷新
- 简化信息：折叠次要信息
- 底部操作栏：关键操作固定底部

### 4.4 视觉规范

#### 4.4.1 配色

```css
/* 主色调 - 科幻蓝 */
--primary: #00D4FF;
--primary-glow: rgba(0, 212, 255, 0.3);

/* 背景 - 深空黑 */
--bg-primary: #0a0a0f;
--bg-secondary: #12121a;
--bg-card: rgba(255, 255, 255, 0.03);

/* 文字 */
--text-primary: #ffffff;
--text-secondary: rgba(255, 255, 255, 0.6);

/* 状态色 */
--success: #00ff88;
--error: #ff4757;
--warning: #ffa502;
```

#### 4.4.2 效果

- **毛玻璃**：`backdrop-filter: blur(20px)`
- **边框光晕**：`border: 1px solid rgba(0, 212, 255, 0.2)`
- **悬浮发光**：hover 时边框增强
- **渐变背景**：微妙的径向渐变

### 4.5 交互细节

#### 4.5.1 发布确认

```
┌──────────────────────────────────┐
│        确认发布                   │
│  ──────────────────────────────  │
│  目标版本: a1b2c3d               │
│  提交消息: feat: Add feature     │
│  ──────────────────────────────  │
│  ⚠️ 发布将执行部署脚本            │
│                                  │
│     [取消]        [确认发布]     │
└──────────────────────────────────┘
```

#### 4.5.2 发布进行中

```
┌──────────────────────────────────┐
│  🚀 正在发布...                   │
│  ──────────────────────────────  │
│  ┌────────────────────────────┐  │
│  │ $ git fetch origin         │  │
│  │ $ git checkout a1b2c3d     │  │
│  │ Already on 'a1b2c3d'       │  │
│  │ $ ./deploy.sh              │  │
│  │ Building...                │  │
│  │ █████████░░░░░░░░ 50%      │  │
│  └────────────────────────────┘  │
│                                  │
│          [取消发布]              │
└──────────────────────────────────┘
```

---

## 5. 技术方案

### 5.1 架构

```
prd-publish/
├── server.js           # 后端服务入口
├── package.json        # 依赖配置
├── .env.example        # 配置模板
├── public/             # 静态前端文件
│   ├── index.html
│   ├── app.js
│   └── style.css
└── publish-history.json  # 发布历史（自动生成）
```

### 5.2 技术选型

| 层级 | 技术 | 理由 |
|------|------|------|
| 后端 | Node.js + Express | 轻量、单文件部署 |
| 前端 | 原生 HTML/CSS/JS | 零依赖、加载快 |
| 认证 | JWT | 无状态、简单 |
| 实时 | SSE | 原生支持、简单可靠 |

### 5.3 API 设计

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `POST /api/login` | POST | 登录 | 否 |
| `GET /api/commits` | GET | 提交列表 | 是 |
| `GET /api/tags` | GET | Tag 列表 | 是 |
| `GET /api/status` | GET | 当前状态 | 是 |
| `POST /api/deploy` | POST | 执行发布 | 是 |
| `GET /api/deploy/stream` | GET | 发布日志 SSE | 是 |
| `GET /api/history` | GET | 发布历史 | 是 |

### 5.4 配置项汇总

```bash
# 认证配置
PUBLISH_USERNAME=admin
PUBLISH_PASSWORD=your-secret
PUBLISH_JWT_SECRET=your-jwt-secret

# 服务配置
PUBLISH_PORT=3939
PUBLISH_HOST=0.0.0.0

# Git 配置
PUBLISH_REPO_PATH=/path/to/repo
PUBLISH_BRANCH=main

# 执行配置
PUBLISH_EXEC_SCRIPT=./exec.sh
PUBLISH_EXEC_TIMEOUT=300000
```

### 5.5 exec.sh 接口规范

```bash
#!/bin/bash
# 参数说明:
#   $1 - 完整 commit hash
#   $2 - 短 commit hash (7位)
#   $3 - 分支名
#
# 退出码:
#   0 - 成功
#   非0 - 失败
#
# 标准输出会实时推送到前端

COMMIT=$1
SHORT_HASH=$2
BRANCH=$3

echo "开始部署版本: $SHORT_HASH"
# 你的部署逻辑...
```

---

## 6. 部署方案

### 6.1 快速启动

```bash
# 1. 进入目录
cd prd-publish

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.example .env
vim .env

# 4. 启动服务
npm start

# 或使用 PM2 守护
pm2 start server.js --name prd-publish
```

### 6.2 Systemd 服务（可选）

```ini
[Unit]
Description=PRD Publish Service
After=network.target

[Service]
Type=simple
User=deploy
WorkingDirectory=/path/to/prd-publish
ExecStart=/usr/bin/node server.js
Restart=on-failure
EnvironmentFile=/path/to/prd-publish/.env

[Install]
WantedBy=multi-user.target
```

---

## 7. 安全考虑

| 风险 | 措施 |
|------|------|
| 未授权访问 | 环境变量认证 + JWT |
| 暴力破解 | 登录失败锁定 |
| 脚本注入 | commit id 严格校验（仅允许 hex） |
| 日志泄露 | 敏感信息脱敏 |
| 并发冲突 | 发布锁机制 |

---

## 8. 后续迭代

| 版本 | 功能 | 优先级 |
|------|------|--------|
| v1.1 | 多仓库支持 | P2 |
| v1.1 | Webhook 通知 | P2 |
| v1.2 | 定时发布 | P3 |
| v1.2 | 发布审批流程 | P3 |

---

## 9. 验收标准

- [ ] 移动端可正常登录和发布
- [ ] 桌面端 UI 显示正常
- [ ] 提交列表正确显示 hash、消息、时间
- [ ] 一键发布功能正常
- [ ] 实时日志正确推送
- [ ] 发布历史正确记录
- [ ] 配置项全部生效
- [ ] exec.sh 参数正确传递

---

## 附录 A: 界面原型（ASCII）

### 登录页（移动端）

```
┌─────────────────────┐
│                     │
│    ◆ PRD-Publish    │
│                     │
│  ┌───────────────┐  │
│  │ 用户名        │  │
│  └───────────────┘  │
│  ┌───────────────┐  │
│  │ 密码          │  │
│  └───────────────┘  │
│                     │
│  ┌───────────────┐  │
│  │    登  录     │  │
│  └───────────────┘  │
│                     │
└─────────────────────┘
```

### 主页（移动端）

```
┌─────────────────────┐
│ PRD-Publish    [☰]  │
├─────────────────────┤
│ 当前: a1b2c3d       │
│ 上次: 2小时前 ✓     │
├─────────────────────┤
│ [提交] [标签] [历史]│
├─────────────────────┤
│ 🔍 搜索...          │
├─────────────────────┤
│ ● a1b2c3d           │
│   feat: Add feature │
│   2小时前    [发布] │
├─────────────────────┤
│ ○ b2c3d4e           │
│   fix: Bug fix      │
│   5小时前    [发布] │
├─────────────────────┤
│      [加载更多]     │
└─────────────────────┘
```
