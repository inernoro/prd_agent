# å†…è”å›¾ç‰‡èŠå¤©åˆ†æåŠŸèƒ½æ”¹è¿›è®¾è®¡

> **æ–‡æ¡£çŠ¶æ€**: è¿›è¡Œä¸­
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-27
> **æœ€åæ›´æ–°**: 2026-01-28
> **è´Ÿè´£äºº**: AI Assistant + ç”¨æˆ·åä½œ

---

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 ç”¨æˆ·éœ€æ±‚

ç”¨æˆ·è§‚å¯Ÿåˆ°ç«å“å›¾ç‰‡ç¼–è¾‘å¹³å°å…·æœ‰ä»¥ä¸‹é«˜çº§åŠŸèƒ½ï¼š

1. **ç‚¹å‡»è¯†åˆ« (Click-to-Segment)**: ä½¿ç”¨ Cmd+é¼ æ ‡ç‚¹å‡»å¯è¯†åˆ«å›¾ç‰‡ä¸­è¢«ç‚¹å‡»çš„å¯¹è±¡
2. **å†…è”å›¾ç‰‡åµŒå…¥**: åœ¨èŠå¤©è¾“å…¥æ¡†ä¸­ï¼Œå›¾ç‰‡/div å¯ä»¥åµŒå…¥åˆ°æ–‡å­—ä¸­é—´ï¼Œåƒæ–‡å­—çš„ä¸€éƒ¨åˆ†
3. **ä¸¤é˜¶æ®µé€‰æ‹©**: å…ˆé¢„é€‰å›¾ç‰‡ï¼ˆç°è‰²ï¼‰ï¼Œç‚¹å‡»è¾“å…¥æ¡†åç¡®è®¤ï¼ˆå˜æˆ chipï¼‰

### 1.2 å½“å‰ç—›ç‚¹

| ç—›ç‚¹ | æè¿° |
|------|------|
| å‚è€ƒå›¾ä½ç½®å›ºå®š | å‚è€ƒå›¾æ˜¯ç‹¬ç«‹ `<p>` æ ‡ç­¾ï¼Œåœ¨è¾“å…¥æ¡†ä¸Šæ–¹ï¼Œæ— æ³•ä¸æ–‡å­—äº¤ç»‡ |
| å…³è”æ€§ä¸æ˜ç¡® | ç”¨æˆ·åˆ†ä¸æ¸…å›¾ç‰‡å’Œæ–‡å­—çš„å…ˆåé¡ºåºã€å¼•ç”¨å…³ç³» |
| imageRefs è¢«æµªè´¹ | `getStructuredContent()` è¿”å›çš„ imageRefs æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ”¹ç”¨æ­£åˆ™é‡æ–°æå– |
| ä¸‰é“¾è·¯å‰²è£‚ | å·¦ä¾§æ·»åŠ ã€å³ä¸‹è§’è¾“å…¥ã€é¦–é¡µå¸¦å…¥ä¸‰ä¸ªå…¥å£å„è‡ªå¤„ç†ï¼Œä½“éªŒä¸ç»Ÿä¸€ |

### 1.3 æ”¹è¿›ç›®æ ‡

1. **ç»Ÿä¸€ä¸‰ä¸ªè¾“å…¥é“¾è·¯çš„æ•°æ®æ¨¡å‹**
2. **æ­£ç¡®ä½¿ç”¨ RichComposer æä¾›çš„ imageRefs**
3. **æä¾›å®æ—¶éªŒè¯ï¼Œé˜²æ­¢å¼•ç”¨å¤±æ•ˆçš„å›¾ç‰‡**
4. **ä¸ç ´åç°æœ‰çš„æº¢å‡ºä¿æŠ¤å’Œ UI ä¼˜åŒ–**

---

## äºŒã€ç°çŠ¶åˆ†æ

### 2.1 ä¸‰ä¸ªè¾“å…¥é“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å½“å‰æ¶æ„                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   é“¾è·¯1: å·¦ä¾§ç”»å¸ƒ              é“¾è·¯2: å³ä¸‹è§’è¾“å…¥           é“¾è·¯3: é¦–é¡µå¸¦å…¥  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚ onUploadImagesâ”‚           â”‚ RichComposer â”‚           â”‚ initialPromptâ”‚â”‚
â”‚   â”‚ setCanvas()   â”‚           â”‚ @img chip    â”‚           â”‚ [IMAGE=...]  â”‚â”‚
â”‚   â”‚ selectedKeys  â”‚           â”‚ imageRefs    â”‚           â”‚ parseInline  â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚          â”‚                           â”‚                          â”‚        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                      â†“                                   â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                        â”‚  buildRequestTextWithRefs â”‚                      â”‚
â”‚                        â”‚  (ç”¨æ­£åˆ™é‡æ–°è§£æ)          â”‚                      â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å…³é”®ä»£ç ä½ç½®

| æ–‡ä»¶ | è¡Œå· | ç”¨é€” |
|------|------|------|
| `prd-admin/src/components/RichComposer/index.tsx` | å…¨æ–‡ 252 è¡Œ | å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸»ä½“ |
| `prd-admin/src/components/RichComposer/ImageChipNode.tsx` | å…¨æ–‡ 238 è¡Œ | å›¾ç‰‡ chip èŠ‚ç‚¹ |
| `prd-admin/src/components/RichComposer/ImageMentionPlugin.tsx` | å…¨æ–‡ 340 è¡Œ | @img ä¸‹æ‹‰èœå• |
| `prd-admin/src/pages/ai-chat/AdvancedVisualAgentTab.tsx` | 3190-3206 | onSendRich å‡½æ•° |
| `prd-admin/src/pages/ai-chat/AdvancedVisualAgentTab.tsx` | 3074-3125 | buildRequestTextWithRefs |
| `prd-admin/src/pages/ai-chat/AdvancedVisualAgentTab.tsx` | 3030-3057 | initialPrompt å¤„ç† |
| `prd-admin/src/lib/visualAgentPromptUtils.ts` | å…¨æ–‡ 200 è¡Œ | parseInlinePrompt ç­‰ |

### 2.3 å½“å‰é—®é¢˜ä»£ç 

```typescript
// AdvancedVisualAgentTab.tsx:3194
// âŒ åªå–äº† textï¼Œå®Œå…¨å¿½ç•¥äº† imageRefs
const { text } = composer.getStructuredContent();

// ç„¶ååœ¨ buildRequestTextWithRefs ä¸­ç”¨æ­£åˆ™é‡æ–°æå–
const refsByText = extractReferencedImagesInOrder(rawText);
// â†‘ è¿™æ˜¯åœ¨é‡å¤å·¥ä½œï¼ImageChipNode å·²ç»æœ‰å®Œæ•´çš„å…ƒæ•°æ®
```

### 2.4 å·²æœ‰çš„æº¢å‡ºä¿æŠ¤ï¼ˆä¸å¯ç ´åï¼‰

```
ImageChipNode çš„ä¿æŠ¤æªæ–½:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  chip ç»“æ„:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚åºå·  â”‚ ç¼©ç•¥å›¾â”‚ æ ‡ç­¾          â”‚                                â”‚
â”‚  â”‚14px  â”‚ 14px â”‚ max 80px      â”‚                                â”‚
â”‚  â”‚å›ºå®š  â”‚ å›ºå®š â”‚ JSæˆªæ–­+ellipsisâ”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                 â”‚
â”‚  ä¿æŠ¤1: displayLabel = label.slice(0, 6) + '...'  (JS æˆªæ–­)     â”‚
â”‚  ä¿æŠ¤2: maxWidth: 80, textOverflow: ellipsis      (CSS æˆªæ–­)    â”‚
â”‚  ä¿æŠ¤3: flexShrink: 0                             (ä¸è¢«å‹ç¼©)    â”‚
â”‚  ä¿æŠ¤4: å®¹å™¨ overflowY: 'auto', maxHeight: 120    (æ»šåŠ¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è¦çº¦å®š**: ä»»ä½•ä¿®æ”¹éƒ½ä¸å¾—ç ´åä¸Šè¿°ä¿æŠ¤æªæ–½ã€‚

---

## ä¸‰ã€æ”¹è¿›è®¡åˆ’

### 3.1 æ ¸å¿ƒæ€æƒ³ï¼šå¥‘çº¦ä¼˜å…ˆ + å•ä¸€æ•°æ®æº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç›®æ ‡æ¶æ„                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   é“¾è·¯1        é“¾è·¯2        é“¾è·¯3                                        â”‚
â”‚     â”‚            â”‚            â”‚                                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                  â†“                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚  ImageRefResolver (ç»Ÿä¸€é—¨å«)          â”‚  â† å•ä¸€å…¥å£                  â”‚
â”‚   â”‚                                      â”‚                              â”‚
â”‚   â”‚  èŒè´£:                               â”‚                              â”‚
â”‚   â”‚  1. éªŒè¯ refId æ˜¯å¦åœ¨ canvas èŒƒå›´å†…  â”‚                              â”‚
â”‚   â”‚  2. åˆå¹¶å¤šæ¥æºçš„å¼•ç”¨ï¼ˆå»é‡ã€æ’åºï¼‰    â”‚                              â”‚
â”‚   â”‚  3. å¤„ç†æ—§æ ¼å¼å…¼å®¹                   â”‚                              â”‚
â”‚   â”‚  4. è¿”å›æ ‡å‡†åŒ–çš„ç»“æœ                 â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                  â†“                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚  sendText() / runFromText()          â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ–°å¢æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `prd-admin/src/lib/imageRefContract.ts` | ç±»å‹å®šä¹‰ï¼ˆå¥‘çº¦ï¼‰ | âœ… å·²åˆ›å»º |
| `prd-admin/src/lib/imageRefResolver.ts` | ç»Ÿä¸€è§£æå™¨ | âœ… å·²åˆ›å»º |
| `prd-admin/src/lib/imageRefResolver.test.ts` | å•å…ƒæµ‹è¯• | â³ å¾…åˆ›å»º |
| `prd-admin/src/pages/_dev/RichComposerLab.tsx` | è¯•éªŒåœºé¡µé¢ï¼ˆç‹¬ç«‹ï¼‰ | âœ… å·²åˆ›å»º |
| `prd-admin/src/pages/lab-workshop/WorkshopLabTab.tsx` | è¯•éªŒè½¦é—´ï¼ˆLab å†…åµŒï¼‰ | âœ… å·²åˆ›å»º |

---

## å››ã€å®æ–½æ­¥éª¤ä¸è¿›åº¦

### Step 1: åˆ›å»ºè¯•éªŒåœºï¼ˆä¸ç¢°ç°æœ‰ä»£ç ï¼‰
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **é£é™©**: é›¶
- **å›æ»š**: åˆ é™¤æ–‡ä»¶
- **å†…å®¹**:
  - âœ… åˆ›å»º `/lab?tab=workshop` è¯•éªŒè½¦é—´
  - âœ… åˆ›å»º `/_dev/rich-composer-lab` ç‹¬ç«‹é¡µé¢
  - âœ… æ¨¡æ‹Ÿç”»å¸ƒã€çª„å®¹å™¨æµ‹è¯•ã€è¾¹ç•Œæµ‹è¯•ç”¨ä¾‹
  - âœ… å®æ—¶æ˜¾ç¤º `getStructuredContent()` è¾“å‡º
  - âœ… éªŒæ”¶æ£€æŸ¥æ¸…å•

### Step 2: åˆ›å»ºå¥‘çº¦å’Œè§£æå™¨ï¼ˆä¸ç¢° UIï¼‰
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **é£é™©**: é›¶
- **å›æ»š**: åˆ é™¤æ–‡ä»¶
- **å†…å®¹**:
  - âœ… æ–°å¢ `imageRefContract.ts` - ç±»å‹å®šä¹‰
  - âœ… æ–°å¢ `imageRefResolver.ts` - ç»Ÿä¸€è§£æå™¨
  - â³ æ–°å¢æµ‹è¯•æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

### Step 3: å¹¶è¡Œè¿è¡Œæ–°æ—§é€»è¾‘
- **çŠ¶æ€**: â³ å¾…å¼€å§‹
- **é£é™©**: é›¶
- **å›æ»š**: åˆ é™¤ä»£ç 
- **å†…å®¹**:
  - åœ¨ `onSendRich` ä¸­å¹¶è¡Œè°ƒç”¨ `resolveImageRefs`
  - ä»… `console.log` å¯¹æ¯”ç»“æœï¼Œä¸å®é™…åˆ‡æ¢
  - æ”¶é›†å¯¹æ¯”æ•°æ®

### Step 4: ç¡®è®¤ç»“æœä¸€è‡´ååˆ‡æ¢
- **çŠ¶æ€**: â³ å¾…å¼€å§‹
- **é£é™©**: ä½
- **å›æ»š**: æ¢å¤æ—§ä»£ç 
- **å†…å®¹**:
  - åˆ‡æ¢åˆ°æ–°è§£æå™¨
  - ä¿ç•™æ—§ä»£ç æ³¨é‡Š

### Step 5: æ·»åŠ  UI å®æ—¶éªŒè¯
- **çŠ¶æ€**: â³ å¾…å¼€å§‹
- **é£é™©**: ä½
- **å›æ»š**: åˆ é™¤ç»„ä»¶
- **å†…å®¹**:
  - å¤±æ•ˆ chip çº¢è‰²è¾¹æ¡†æç¤º
  - å‘é€å‰è­¦å‘Š

### Step 6: æ¸…ç†æ—§ä»£ç 
- **çŠ¶æ€**: â³ å¾…å¼€å§‹
- **é£é™©**: ä¸­
- **å›æ»š**: git revert
- **å†…å®¹**:
  - åˆ é™¤ `buildRequestTextWithRefs`
  - åˆ é™¤ `extractReferencedImagesInOrder`

---

## äº”ã€éš¾ç‚¹ä¸é£é™©

### 5.1 å·²è¯†åˆ«çš„éš¾ç‚¹

| éš¾ç‚¹ | æè¿° | åº”å¯¹ç­–ç•¥ |
|------|------|----------|
| chip è¶…å‡ºè¾“å…¥æ¡†å®½åº¦ | å›¾ç‰‡æ ‡ç­¾+åç§°é•¿åº¦å¯èƒ½è¶…å‡ºå®¹å™¨ | **å·²æœ‰ä¿æŠ¤**ï¼Œä¸åšæ”¹åŠ¨ |
| æ—§ [IMAGE] æ ¼å¼å…¼å®¹ | é¦–é¡µå¸¦å…¥å¯èƒ½ä½¿ç”¨æ—§æ ¼å¼ | åœ¨ resolver ä¸­ç»Ÿä¸€å¤„ç† |
| ä¸‰é“¾è·¯ä½“éªŒç»Ÿä¸€ | å·¦ä¾§/å³ä¸‹/é¦–é¡µä¸‰å…¥å£å„è‡ªå¤„ç† | å¼ºåˆ¶æ‰€æœ‰å…¥å£ç»è¿‡ç»Ÿä¸€ resolver |
| refId æ‚¬ç©ºå¼•ç”¨ | ç”¨æˆ·åˆ é™¤å›¾ç‰‡å chip ä»å¼•ç”¨ | å®æ—¶éªŒè¯ + UI è­¦å‘Š |

### 5.2 ç»å¯¹ä¸èƒ½åšçš„äº‹

1. **ä¸å¾—ä¿®æ”¹ ImageChipNode çš„ç°æœ‰æ ·å¼**ï¼ˆæº¢å‡ºä¿æŠ¤ï¼‰
2. **ä¸å¾—åˆ é™¤ JS å±‚é¢çš„æ ‡ç­¾æˆªæ–­é€»è¾‘**ï¼ˆ`displayLabel = label.slice(0, 6) + '...'`ï¼‰
3. **ä¸å¾—åœ¨æœªéªŒè¯çš„æƒ…å†µä¸‹ç›´æ¥åˆ‡æ¢é€»è¾‘**
4. **ä¸å¾—ç ´åç°æœ‰çš„ä¸‰ä¸ªé“¾è·¯åŠŸèƒ½**

### 5.3 é£é™©ç¼“è§£

- **è¯•éªŒåœºéš”ç¦»**: æ‰€æœ‰æ–°åŠŸèƒ½å…ˆåœ¨ `/_dev/` é¡µé¢éªŒè¯
- **å¹¶è¡Œå¯¹æ¯”**: æ–°æ—§é€»è¾‘åŒæ—¶è¿è¡Œï¼Œconsole.log å¯¹æ¯”
- **æ¸è¿›åˆ‡æ¢**: æ¯ä¸€æ­¥éƒ½å¯ç‹¬ç«‹å›æ»š
- **æµ‹è¯•è¦†ç›–**: å¿…é¡»é€šè¿‡æ‰€æœ‰è¾¹ç•Œæµ‹è¯•

---

## å…­ã€éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½éªŒæ”¶

| æµ‹è¯•ç”¨ä¾‹ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|----------|----------|------|
| é“¾è·¯1: é€‰ä¸­å•å¼ å›¾ç‰‡å‘é€ | refs åŒ…å«è¯¥å›¾ç‰‡ | â³ |
| é“¾è·¯1: é€‰ä¸­å¤šå¼ å›¾ç‰‡å‘é€ | refs æŒ‰ selectedKeys é¡ºåº | â³ |
| é“¾è·¯2: è¾“å…¥ @img1 å‘é€ | refs åŒ…å« refId=1 çš„å›¾ç‰‡ | â³ |
| é“¾è·¯2: è¾“å…¥å¤šä¸ª @img å‘é€ | refs æŒ‰æ–‡æœ¬ä¸­å‡ºç°é¡ºåº | â³ |
| é“¾è·¯3: ä»é¦–é¡µå¸¦ [IMAGE=...] è¿›æ¥ | æ­£ç¡®è§£æå¹¶æ¸…ç†æ—§æ ¼å¼ | â³ |
| è¾¹ç•Œ: chip å¼•ç”¨å·²åˆ é™¤çš„å›¾ç‰‡ | äº§ç”Ÿè­¦å‘Šï¼Œrefs ä¸­ä¸åŒ…å« | â³ |
| è¾¹ç•Œ: ç©ºç™½æ¶ˆæ¯ | è¿”å› ok=falseï¼Œerrors åŒ…å«æç¤º | â³ |
| è¾¹ç•Œ: é‡å¤å¼•ç”¨ | è‡ªåŠ¨å»é‡ | â³ |

### 6.2 UI éªŒæ”¶

| æµ‹è¯•ç”¨ä¾‹ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|----------|----------|------|
| è¶…é•¿æ ‡ç­¾ (50 ä¸ªå­—) | æ­£å¸¸æˆªæ–­ï¼Œä¸æº¢å‡º | â³ |
| å¤šä¸ª chip è¿ç»­ | è‡ªåŠ¨æ¢è¡Œï¼Œä¸è¶…å‡ºå®¹å™¨ | â³ |
| chip + é•¿æ–‡å­—æ··åˆ | æ’ç‰ˆæ­£å¸¸ | â³ |
| çª„å®¹å™¨ (200px) | ä¸ç ´åå¸ƒå±€ | â³ |
| å¼•ç”¨ä¸å­˜åœ¨çš„ @img99 | æ˜¾ç¤ºè­¦å‘Šæ ·å¼ | â³ |

### 6.3 å…¼å®¹æ€§éªŒæ”¶

| æµ‹è¯•ç”¨ä¾‹ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|----------|----------|------|
| æ—§æ ¼å¼ `[IMAGE=url\|name]` | æ­£ç¡®è§£æ | â³ |
| æ–°æ ¼å¼ `[IMAGE src=... name=...]` | æ­£ç¡®è§£æ | â³ |
| ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ | æ‰€æœ‰ç°æœ‰æµç¨‹æ­£å¸¸ | â³ |

---

## ä¸ƒã€çº¦å®šä¸è§„åˆ™

### 7.1 ä»£ç çº¦å®š

```typescript
// 1. æ‰€æœ‰å›¾ç‰‡å¼•ç”¨å¿…é¡»ç»è¿‡ ImageRefResolver
// âœ… æ­£ç¡®
const result = resolveImageRefs({ rawText, chipRefs, selectedKeys, canvas });
if (result.ok) await send(result);

// âŒ é”™è¯¯ï¼šç»•è¿‡ resolver
const refs = extractReferencedImagesInOrder(text);
```

```typescript
// 2. ä¼˜å…ˆçº§é¡ºåº
// chipRefs > æ–‡æœ¬ä¸­çš„ @imgN > selectedKeys > inlineImage
```

```typescript
// 3. ç±»å‹å®šä¹‰å¿…é¡»ä½¿ç”¨å¥‘çº¦æ–‡ä»¶
import type { ResolvedImageRef, ImageRefResolveResult } from '@/lib/imageRefContract';
```

### 7.2 æµ‹è¯•çº¦å®š

- æ¯ä¸ªæ–°åŠŸèƒ½å¿…é¡»æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•
- è¾¹ç•Œæƒ…å†µå¿…é¡»è¦†ç›–
- æµ‹è¯•æ–‡ä»¶å‘½å: `*.test.ts`

### 7.3 æ–‡æ¡£çº¦å®š

- ä»»ä½•æ”¹åŠ¨å¿…é¡»æ›´æ–°æœ¬æ–‡æ¡£çš„è¿›åº¦
- æ–°å¢æ–‡ä»¶å¿…é¡»åœ¨"æ–°å¢æ–‡ä»¶æ¸…å•"ä¸­ç™»è®°
- éªŒæ”¶æ ‡å‡†å®Œæˆåæ ‡è®° âœ…

---

## å…«ã€æŠ€æœ¯é€‰å‹

### 8.1 å·²ç¡®è®¤ä½¿ç”¨

| æŠ€æœ¯ | ç”¨é€” | ç†ç”± |
|------|------|------|
| Lexical | å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ | å·²åœ¨ä½¿ç”¨ |
| DecoratorNode | ImageChipNode | å·²å®ç° |
| åŸç”Ÿ ResizeObserver | å®¹å™¨å°ºå¯¸ç›‘å¬ | é¡¹ç›®ä¸­å·²æœ‰ä½¿ç”¨ |
| çº¯ CSS max-width | chip å®½åº¦é™åˆ¶ | å·²æœ‰ï¼Œä¸åšæ”¹åŠ¨ |

### 8.2 æš‚ä¸å®ç°ï¼ˆæœªæ¥è€ƒè™‘ï¼‰

| åŠŸèƒ½ | ç†ç”± |
|------|------|
| Click-to-Segment (SAM) | éœ€è¦ GPU æœåŠ¡ï¼Œå·¥ä½œé‡å¤§ï¼Œä¼˜å…ˆçº§ P3 |
| æ‹–æ‹½å›¾ç‰‡åˆ°è¾“å…¥æ¡† | å½“å‰ä¼˜å…ˆè§£å†³æ•°æ®æµé—®é¢˜ |
| å¤šå›¾æƒé‡æ§åˆ¶ | è¶…å‡ºå½“å‰èŒƒå›´ |

---

## ä¹ã€ä¸šåŠ¡é€»è¾‘è§„èŒƒ

### 9.1 ä¸¤é˜¶æ®µé€‰æ‹©æœºåˆ¶

ç”¨æˆ·é€‰æ‹©å›¾ç‰‡åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š**é¢„é€‰** å’Œ **ç¡®è®¤**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ä¸¤é˜¶æ®µé€‰æ‹©æµç¨‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  é˜¶æ®µ1: é¢„é€‰ (Pre-select)                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  è§¦å‘æ–¹å¼:                                                                  â”‚
â”‚    â€¢ å•å‡»å›¾ç‰‡ â†’ é¢„é€‰è¯¥å›¾ç‰‡                                                  â”‚
â”‚    â€¢ é¼ æ ‡æ‹–æ‹½æ¡†é€‰ â†’ é¢„é€‰å¤šå¼ å›¾ç‰‡                                             â”‚
â”‚                                                                             â”‚
â”‚  è§†è§‰çŠ¶æ€:                                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚ ğŸ–¼   â”‚  â”‚ ğŸ–¼   â”‚  â”‚ ğŸ–¼   â”‚                                            â”‚
â”‚    â”‚      â”‚  â”‚ â–‘â–‘â–‘â–‘ â”‚  â”‚ â–‘â–‘â–‘â–‘ â”‚  â† ç°è‰²è¾¹æ¡†/é®ç½© = é¢„é€‰ä¸­                   â”‚
â”‚    â”‚ #1   â”‚  â”‚ #2 âœ“ â”‚  â”‚ #3 âœ“ â”‚                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚    (æœªé€‰)    (é¢„é€‰)    (é¢„é€‰)                                               â”‚
â”‚                                                                             â”‚
â”‚  ç‰¹æ€§:                                                                      â”‚
â”‚    â€¢ é¢„é€‰çŠ¶æ€å¯å–æ¶ˆï¼ˆå†æ¬¡ç‚¹å‡»å–æ¶ˆï¼‰                                          â”‚
â”‚    â€¢ é¢„é€‰çŠ¶æ€å¯æ›¿æ¢ï¼ˆç‚¹å‡»å…¶ä»–å›¾ç‰‡ï¼‰                                          â”‚
â”‚    â€¢ æ”¯æŒå¤šé€‰ï¼ˆæ¡†é€‰æˆ–è¿ç»­å•å‡»ä¸åŒå›¾ç‰‡ï¼‰                                       â”‚
â”‚                                                                             â”‚
â”‚  é˜¶æ®µ2: ç¡®è®¤é€‰æ‹© (Confirm)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  è§¦å‘æ¡ä»¶:                                                                  â”‚
â”‚    â€¢ ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆfocusï¼‰                                                    â”‚
â”‚    â€¢ æˆ–å¼€å§‹è¾“å…¥æ–‡å­—                                                         â”‚
â”‚                                                                             â”‚
â”‚  ç»“æœ:                                                                      â”‚
â”‚    1. é¢„é€‰çš„å›¾ç‰‡ â†’ è½¬æ¢ä¸º chip æ’å…¥è¾“å…¥æ¡†å…‰æ ‡ä½ç½®                            â”‚
â”‚    2. é¢„é€‰çŠ¶æ€æ¸…ç©º                                                          â”‚
â”‚    3. å›¾ç‰‡æ¢å¤ä¸ºå¯é€‰çŠ¶æ€ï¼ˆå¯ä»¥ç»§ç»­é€‰æ‹©æ›´å¤šï¼‰                                  â”‚
â”‚                                                                             â”‚
â”‚  è¾“å…¥æ¡†çŠ¶æ€:                                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚    â”‚ [2][ğŸ–¼][äººç‰©å›¾] [3][ğŸ–¼][äº§å“å›¾] |                           â”‚          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 å›¾ç‰‡çŠ¶æ€å®šä¹‰

| çŠ¶æ€ | è§†è§‰æ ·å¼ | å«ä¹‰ | å¯æ‰§è¡Œæ“ä½œ |
|------|----------|------|------------|
| æœªé€‰ä¸­ | æ™®é€šè¾¹æ¡† | å¯è¢«é€‰æ‹© | å•å‡»é¢„é€‰ã€æ¡†é€‰é¢„é€‰ |
| é¢„é€‰ä¸­ | ç°è‰²è¾¹æ¡† + åŠé€æ˜é®ç½© | "æˆ‘æ‰“ç®—ç”¨è¿™å¼ " | å–æ¶ˆã€æ›¿æ¢ã€ç¡®è®¤ |
| å·²ç¡®è®¤ | è“ç´«è‰² chip åœ¨è¾“å…¥æ¡†ä¸­ | å·²æ’å…¥æ¶ˆæ¯ | åœ¨è¾“å…¥æ¡†ä¸­åˆ é™¤ |

### 9.3 å¿«æ·é”®è§„åˆ’

| å¿«æ·é”® | å½“å‰åŠŸèƒ½ | æœªæ¥åŠŸèƒ½ï¼ˆä¿ç•™ï¼‰ |
|--------|----------|------------------|
| å•å‡»å›¾ç‰‡ | é¢„é€‰è¯¥å›¾ç‰‡ | - |
| æ‹–æ‹½æ¡†é€‰ | é¢„é€‰å¤šå¼ å›¾ç‰‡ | - |
| Cmd/Ctrl + å•å‡» | **ä¿ç•™** | å¤šå±‚çº§é€‰æ‹©ï¼ˆè¯†åˆ«å›¾ç‰‡ä¸­çš„å…ƒç´ ï¼‰ |
| Esc | å–æ¶ˆé¢„é€‰ | - |

> **æ³¨æ„**: `Cmd/Ctrl + å•å‡»` ä¿ç•™ç»™æœªæ¥çš„"å¤šå±‚çº§é€‰æ‹©"åŠŸèƒ½ï¼ˆClick-to-Segmentï¼‰ï¼Œ
> å¯è¯†åˆ«å›¾ç‰‡ä¸­çš„å…·ä½“å…ƒç´ ï¼ˆå¦‚"è§¦æ‘¸å±æ˜¾ç¤ºå™¨"ï¼‰ï¼Œæš‚ä¸å®ç°ã€‚

---

## åã€åç«¯è¯·æ±‚è§„èŒƒ

### 10.1 æ ¸å¿ƒé—®é¢˜

**å¦‚ä½•è®© AI æ¨¡å‹ç†è§£æ¯å¼ å›¾ç‰‡çš„é¡ºåºå’Œç”¨æˆ·æ„å›¾ï¼Ÿ**

å•çº¯å‘é€å›¾ç‰‡ URL åˆ—è¡¨ï¼ŒAI æ— æ³•ç†è§£ï¼š
- å“ªå¼ æ˜¯è¦ä¿®æ”¹çš„ç›®æ ‡å›¾
- å“ªå¼ æ˜¯é£æ ¼å‚è€ƒ
- ç”¨æˆ·æœŸæœ›çš„æ“ä½œæ˜¯ä»€ä¹ˆ

### 10.2 è¡Œä¸šåšæ³•å¯¹æ¯”

| å¹³å° | æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| **Midjourney** | ä½ç½®+æƒé‡è¯­æ³• `img1::0.5 img2::1.5` | ç²¾ç¡®æ§åˆ¶ | å­¦ä¹ æˆæœ¬é«˜ |
| **Leonardo** | æ‹–æ‹½åˆ°ä¸åŒæ§½ä½ (Reference/Target) | ç›´è§‚ | éœ€è¦é¢„å®šä¹‰æ§½ä½ |
| **GPT-4V/Claude** | åœ¨ prompt ä¸­è¯´æ˜è§’è‰² | çµæ´» | ä¾èµ–è¯­è¨€æè¿°å‡†ç¡®æ€§ |
| **ControlNet** | ä¸åŒè¾“å…¥é€šé“ (depth/pose/edge) | ä¸“ä¸š | ä»…é€‚ç”¨äºç‰¹å®šåœºæ™¯ |

### 10.3 æˆ‘ä»¬çš„æ–¹æ¡ˆï¼šç»“æ„åŒ–å›¾ç‰‡å¼•ç”¨

é‡‡ç”¨ **ç»“æ„åŒ– prompt + å›¾ç‰‡å…ƒæ•°æ®** çš„æ–¹å¼ï¼Œç¡®ä¿ AI èƒ½ç†è§£å›¾ç‰‡è§’è‰²ã€‚

#### 10.3.1 è¯·æ±‚æ•°æ®ç»“æ„

```typescript
interface ImageGenRequest {
  /** ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ–‡æœ¬ï¼ˆåŒ…å« @imgN å¼•ç”¨ï¼‰ */
  prompt: string;

  /** å›¾ç‰‡å¼•ç”¨åˆ—è¡¨ï¼ˆæŒ‰ç”¨æˆ·å¼•ç”¨é¡ºåºï¼‰ */
  imageRefs: Array<{
    /** å¼•ç”¨ IDï¼ˆå¯¹åº” @img1, @img2...ï¼‰ */
    refId: number;
    /** å›¾ç‰‡ URL */
    url: string;
    /** å›¾ç‰‡è§’è‰²ï¼ˆå¯é€‰ï¼Œç”± AI æ¨æ–­æˆ–ç”¨æˆ·æŒ‡å®šï¼‰ */
    role?: 'target' | 'reference' | 'style' | 'background';
    /** ç”¨æˆ·ç»™çš„æ ‡ç­¾/æè¿° */
    label?: string;
    /** å›¾ç‰‡ä¸­è¢«é€‰ä¸­çš„åŒºåŸŸï¼ˆæœªæ¥ SAM åŠŸèƒ½ï¼‰ */
    region?: {
      point?: { x: number; y: number };
      mask?: string;  // base64 æˆ– URL
      elementLabel?: string;  // "è§¦æ‘¸å±æ˜¾ç¤ºå™¨"
    };
  }>;

  /** ç”Ÿæˆå°ºå¯¸ */
  size?: string;
}
```

#### 10.3.2 å‘é€ç»™ AI çš„ Prompt æ ¼å¼

```
ç”¨æˆ·è¯·æ±‚: æŠŠ @img1 çš„èƒŒæ™¯æ¢æˆ @img2 çš„é£æ ¼

ã€å›¾ç‰‡å¼•ç”¨ï¼ˆæŒ‰é¡ºåºï¼‰ã€‘
- @img1: ç”Ÿäº§è®¾å¤‡.jpgï¼ˆç›®æ ‡å›¾ - è¦ä¿®æ”¹çš„å›¾ç‰‡ï¼‰
- @img2: é£æ™¯èƒŒæ™¯.jpgï¼ˆå‚è€ƒå›¾ - é£æ ¼å‚è€ƒï¼‰

ã€ä»»åŠ¡ç†è§£ã€‘
è¯·å°†ç¬¬ä¸€å¼ å›¾ï¼ˆç”Ÿäº§è®¾å¤‡ï¼‰çš„èƒŒæ™¯æ›¿æ¢ä¸ºç¬¬äºŒå¼ å›¾ï¼ˆé£æ™¯ï¼‰çš„é£æ ¼ã€‚
ä¿ç•™å‰æ™¯çš„ç”Ÿäº§è®¾å¤‡ä¸å˜ï¼Œä»…ä¿®æ”¹èƒŒæ™¯åŒºåŸŸã€‚
```

#### 10.3.3 å›¾ç‰‡è§’è‰²æ¨æ–­è§„åˆ™

å½“ç”¨æˆ·æ²¡æœ‰æ˜ç¡®æŒ‡å®šè§’è‰²æ—¶ï¼ŒæŒ‰ä»¥ä¸‹è§„åˆ™æ¨æ–­ï¼š

| åœºæ™¯ | æ¨æ–­è§„åˆ™ |
|------|----------|
| å•å›¾ + "ä¿®æ”¹/æ¢/æ”¹" | è¯¥å›¾ä¸º target |
| å•å›¾ + "ç”Ÿæˆç±»ä¼¼/å‚è€ƒ" | è¯¥å›¾ä¸º reference |
| åŒå›¾ + "æŠŠAæ¢æˆB" | A=target, B=reference |
| åŒå›¾ + "Açš„é£æ ¼+Bçš„å†…å®¹" | A=style, B=target |
| å¤šå›¾æ— æ˜ç¡®æŒ‡ç¤º | ç¬¬ä¸€å¼ ä¸º targetï¼Œå…¶ä½™ä¸º reference |

### 10.4 æœªæ¥æ‰©å±•ï¼šåŒºåŸŸé€‰æ‹©

å½“å®ç° Click-to-Segment (SAM) åŠŸèƒ½åï¼Œå¯ä»¥ç²¾ç¡®æŒ‡å®šå›¾ç‰‡ä¸­çš„å…ƒç´ ï¼š

```typescript
// ç”¨æˆ· Cmd+ç‚¹å‡»äº†å›¾ç‰‡ä¸­çš„"è§¦æ‘¸å±æ˜¾ç¤ºå™¨"
imageRefs: [{
  refId: 1,
  url: '...',
  region: {
    point: { x: 0.35, y: 0.42 },  // ç‚¹å‡»ä½ç½®ï¼ˆ0-1ï¼‰
    elementLabel: 'è§¦æ‘¸å±æ˜¾ç¤ºå™¨',  // SAM è¯†åˆ«ç»“æœ
    mask: 'data:image/png;base64,...'  // åˆ†å‰²æ©ç 
  }
}]
```

Prompt ä¼šå˜æˆï¼š
```
ç”¨æˆ·è¯·æ±‚: æŠŠ @img1 ä¸­çš„è§¦æ‘¸å±æ˜¾ç¤ºå™¨æ¢æˆæ›´å¤§çš„å±å¹•

ã€å›¾ç‰‡å¼•ç”¨ã€‘
- @img1: ç”Ÿäº§çº¿ç…§ç‰‡
  - é€‰ä¸­åŒºåŸŸ: è§¦æ‘¸å±æ˜¾ç¤ºå™¨ (ä½ç½®: 35%, 42%)

ã€ä»»åŠ¡ç†è§£ã€‘
è¯·å°†å›¾ç‰‡ä¸­æ ‡è®°çš„"è§¦æ‘¸å±æ˜¾ç¤ºå™¨"æ›¿æ¢ä¸ºæ›´å¤§çš„å±å¹•ï¼Œä¿æŒå…¶ä»–å…ƒç´ ä¸å˜ã€‚
```

---

## åä¸€ã€æ„å›¾åˆ†æ Agent è§„åˆ’

> **çŠ¶æ€**: â³ å¾…å®ç°
> **ä¼˜å…ˆçº§**: P2
> **ä¾èµ–**: Step 3 å®Œæˆå

### 11.1 è®¾è®¡åŸåˆ™

**ä¸åœ¨å‰ç«¯ä»£ç ä¸­åšæ„å›¾åˆ‡è¯/åˆ†æ**ï¼Œè€Œæ˜¯ï¼š
- **å•å›¾åœºæ™¯**ï¼šæ²¿ç”¨åŸæœ‰é€»è¾‘ï¼Œç›´æ¥å‘é€ï¼Œä¸é¢å¤–è°ƒç”¨ Agent
- **å¤šå›¾åœºæ™¯**ï¼šäº¤ç»™åç«¯ Agent åˆ†ææ„å›¾ï¼Œå‰ç«¯åªè´Ÿè´£æ”¶é›†æ•°æ®

### 11.2 æµç¨‹è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å¤„ç†æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·è¾“å…¥: "æŠŠ @img1 å’Œ @img2 èåˆæˆæ–°å›¾"                        â”‚
â”‚                    â†“                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚  ImageRefResolver è§£æ                  â”‚                    â”‚
â”‚   â”‚  â†’ refs: [{refId:1}, {refId:2}]        â”‚                    â”‚
â”‚   â”‚  â†’ cleanText: "æŠŠ å’Œ èåˆæˆæ–°å›¾"        â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                    â†“                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚  åˆ¤æ–­: refs.length > 1 ?               â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚          â†“ NO (å•å›¾)          â†“ YES (å¤šå›¾)                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  åŸæœ‰é€»è¾‘         â”‚  â”‚  è°ƒç”¨ visual-intent Agent â”‚            â”‚
â”‚   â”‚  ç›´æ¥ç”Ÿæˆå›¾ç‰‡     â”‚  â”‚                          â”‚            â”‚
â”‚   â”‚                  â”‚  â”‚  POST /api/visual-agent/ â”‚            â”‚
â”‚   â”‚                  â”‚  â”‚       analyze-intent     â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                   â†“                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                    â”‚  Agent è¿”å›ç»“æ„åŒ–æ„å›¾         â”‚             â”‚
â”‚                    â”‚  {                           â”‚             â”‚
â”‚                    â”‚    action: "blend",          â”‚             â”‚
â”‚                    â”‚    target: {refId: 1},       â”‚             â”‚
â”‚                    â”‚    references: [{refId: 2}], â”‚             â”‚
â”‚                    â”‚    enhancedPrompt: "..."     â”‚             â”‚
â”‚                    â”‚  }                           â”‚             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                   â†“                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                    â”‚  ä½¿ç”¨å¢å¼ºåçš„ prompt ç”Ÿæˆå›¾ç‰‡  â”‚             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 åç«¯ Agent è®¾è®¡

**ä½ç½®**: `VisualAgentController.cs`

**æ–°å¢ç«¯ç‚¹**: `POST /api/visual-agent/analyze-intent`

```csharp
// è¯·æ±‚
{
  "text": "æŠŠè¿™ä¸¤å¼ å›¾èåˆ",
  "imageRefs": [
    { "refId": 1, "url": "...", "label": "é£æ™¯å›¾" },
    { "refId": 2, "url": "...", "label": "äººç‰©å›¾" }
  ]
}

// å“åº”
{
  "action": "blend",           // blend/replace/style_transfer/composite
  "target": { "refId": 1 },    // è¦ä¿®æ”¹çš„å›¾
  "references": [{ "refId": 2 }],  // å‚è€ƒå›¾
  "styleRef": null,            // é£æ ¼å‚è€ƒï¼ˆå¦‚æœ‰ï¼‰
  "enhancedPrompt": "å°†é£æ™¯å›¾ä¸äººç‰©å›¾èåˆï¼Œä¿ç•™äººç‰©ä¸»ä½“ï¼ŒèƒŒæ™¯æ›¿æ¢ä¸ºé£æ™¯",
  "confidence": 0.85
}
```

**Agent æ³¨å†Œ**: åœ¨ `PromptStages` ä¸­æ³¨å†Œ `visual-intent-analyzer`

### 11.4 å‰ç«¯è°ƒç”¨æ—¶æœº

```typescript
// AdvancedVisualAgentTab.tsx
const sendText = async (rawText: string) => {
  const result = resolveImageRefs({ rawText, chipRefs, selectedKeys, canvas });

  // å•å›¾ï¼šåŸæœ‰é€»è¾‘
  if (result.refs.length <= 1) {
    await runFromText(rawText, ...);
    return;
  }

  // å¤šå›¾ï¼šè°ƒç”¨æ„å›¾åˆ†æ Agent
  const intent = await api.post('/api/visual-agent/analyze-intent', {
    text: result.cleanText,
    imageRefs: result.refs.map(r => ({
      refId: r.refId,
      url: r.src,
      label: r.label,
    })),
  });

  // ä½¿ç”¨å¢å¼ºåçš„ prompt
  await runFromText(intent.enhancedPrompt, ...);
};
```

### 11.5 å®æ–½æ­¥éª¤

| æ­¥éª¤ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | å®Œæˆ Step 3ï¼ˆå¹¶è¡Œå¯¹æ¯”æ–°æ—§è§£æå™¨ï¼‰ | â³ å¾…å¼€å§‹ |
| 2 | åç«¯æ–°å¢ `analyze-intent` ç«¯ç‚¹ | â³ å¾…å¼€å§‹ |
| 3 | æ³¨å†Œ `visual-intent-analyzer` Agent | â³ å¾…å¼€å§‹ |
| 4 | å‰ç«¯åˆ¤æ–­ refs.lengthï¼Œæ¡ä»¶è°ƒç”¨ | â³ å¾…å¼€å§‹ |
| 5 | æµ‹è¯•ï¼šå•å›¾/åŒå›¾/å¤šå›¾åœºæ™¯ | â³ å¾…å¼€å§‹ |

### 11.6 Agent Prompt æ¨¡æ¿ï¼ˆè‰æ¡ˆï¼‰

```
ä½ æ˜¯ä¸€ä¸ªè§†è§‰åˆ›ä½œæ„å›¾åˆ†æåŠ©æ‰‹ã€‚

ç”¨æˆ·è¾“å…¥: "{text}"
å¼•ç”¨çš„å›¾ç‰‡:
{imageRefs.map(r => `- @img${r.refId}: ${r.label}`).join('\n')}

è¯·åˆ†æç”¨æˆ·çš„æ„å›¾ï¼Œè¿”å› JSON æ ¼å¼ï¼š
{
  "action": "blend|replace|style_transfer|composite|generate",
  "target": { "refId": N } æˆ– null,
  "references": [{ "refId": N }, ...],
  "styleRef": { "refId": N } æˆ– null,
  "enhancedPrompt": "æ›´æ¸…æ™°çš„æŒ‡ä»¤æè¿°",
  "confidence": 0.0-1.0
}

è§„åˆ™ï¼š
1. å¦‚æœç”¨æˆ·è¯´"æŠŠAæ¢æˆB"ï¼ŒAæ˜¯targetï¼ŒBæ˜¯reference
2. å¦‚æœç”¨æˆ·è¯´"Açš„é£æ ¼+Bçš„å†…å®¹"ï¼ŒAæ˜¯styleRefï¼ŒBæ˜¯target
3. å¦‚æœåªæ˜¯"èåˆ/åˆæˆ"ï¼Œç¬¬ä¸€å¼ æ˜¯targetï¼Œå…¶ä½™æ˜¯reference
4. enhancedPrompt è¦æ¯”åŸæ–‡æ›´æ¸…æ™°ï¼Œæ˜ç¡®æŒ‡å‡ºæ¯å¼ å›¾çš„ä½œç”¨
```

---

## åäºŒã€å‚è€ƒèµ„æ–™

### 12.1 ç«å“åˆ†æ

| åŠŸèƒ½ | Midjourney | Leonardo | æˆ‘ä»¬å½“å‰ | æ”¹è¿›å |
|------|------------|----------|----------|--------|
| å†…è”å›¾ç‰‡å¼•ç”¨ | âœ… | âœ… | âš ï¸ @img chip | âœ… å®Œå–„æ•°æ®æµ |
| å¤šå›¾æ··åˆ | âœ… | âœ… | âš ï¸ æ”¯æŒä½†ä½“éªŒå·® | âœ… æ¸…æ™°é¡ºåº |
| åŒºåŸŸé€‰æ‹© | âœ… | âœ… | âŒ | âŒ (æœªæ¥) |

### 12.2 ç›¸å…³æ–‡æ¡£

- `agent.literary-agent.md` - æ–‡å­¦åˆ›ä½œ Agent è®¾è®¡
- `rule.app-feature-definition.md` - åº”ç”¨åŠŸèƒ½å®šä¹‰è§„èŒƒ
- `2.srs.md` - ç³»ç»Ÿéœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦

---

## åä¸‰ã€å˜æ›´è®°å½•

| æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|----------|------|
| 2026-01-28 | æ·»åŠ æ„å›¾åˆ†æ Agent è§„åˆ’ï¼ˆç¬¬åä¸€ç« ï¼‰ | AI Assistant |
| 2026-01-28 | å®ç°ä¸¤é˜¶æ®µé€‰æ‹©åŠŸèƒ½ï¼ˆé¢„é€‰â†’ç¡®è®¤ï¼‰ | AI Assistant |
| 2026-01-28 | å®Œæˆ Step 2ï¼šåˆ›å»ºå¥‘çº¦å’Œè§£æå™¨ | AI Assistant |
| 2026-01-28 | ä¿®å¤è¯•éªŒåœºæµ‹è¯•ç”¨ä¾‹ï¼ˆ@img è§£æä¸º chipï¼‰ | AI Assistant |
| 2026-01-28 | æ·»åŠ ä¸šåŠ¡é€»è¾‘è§„èŒƒï¼šä¸¤é˜¶æ®µé€‰æ‹©ã€åç«¯è¯·æ±‚è§„èŒƒ | AI Assistant |
| 2026-01-28 | å®Œæˆ Step 1ï¼šåˆ›å»ºè¯•éªŒè½¦é—´ | AI Assistant |
| 2026-01-27 | åˆ›å»ºæ–‡æ¡£ | AI Assistant |

---

## é™„å½•ï¼šå¥‘çº¦ç±»å‹å®šä¹‰ï¼ˆé¢„è§ˆï¼‰

```typescript
// imageRefContract.ts

/**
 * ç»Ÿä¸€çš„å›¾ç‰‡å¼•ç”¨æè¿°
 */
export interface ResolvedImageRef {
  canvasKey: string;
  refId: number;
  src: string;
  label: string;
  source: 'chip' | 'selected' | 'inline' | 'text';
}

/**
 * è§£æç»“æœ
 */
export interface ImageRefResolveResult {
  ok: boolean;
  cleanText: string;
  refs: ResolvedImageRef[];
  warnings: string[];
  errors: string[];
}

/**
 * ç»Ÿä¸€å…¥å£çš„è¾“å…¥å‚æ•°
 */
export interface ImageRefResolveInput {
  rawText: string;
  chipRefs?: Array<{ canvasKey: string; refId: number }>;
  selectedKeys?: string[];
  inlineImage?: { src: string; name?: string };
  canvas: CanvasImageItem[];
}
```
