# 19. 知识库多文档功能

> **版本**：1.0 | **最后更新**：2026-01-23
> **状态**：已实现 | **关联提交**：`feat: 知识库多文档功能 - Phase 2/3`

---

## 1. 功能概述

知识库多文档功能允许每个群组管理最多 **10 份** 参考文档（`.pdf` / `.md`），取代旧的"一群一文档"单 PRD 绑定模式。

**核心价值**：

- 支持多份 PRD 或参考资料同时作为 AI 对话的知识上下文
- 群主自主管理（上传/替换/删除），成员可查看
- 文件存储到 COS 对象存储，文本提取后注入 LLM 上下文

---

## 2. 业务流程

### 2.1 整体流程图

```
┌──────────────────────────────────────────────────────────────┐
│  用户操作                                                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 创建群组（仅需群名，无需上传文档）                              │
│         ↓                                                    │
│  2. 进入知识库管理页面                                           │
│         ↓                                                    │
│  3. 上传文档（.pdf / .md，最多10份，每份最大10MB）                  │
│         ↓                                                    │
│  4. 开始对话（AI 基于所有知识库文档回答）                           │
│                                                              │
│  可选操作：                                                     │
│  • 预览文档内容（查看提取的文本）                                   │
│  • 替换文档（新文件覆盖旧文件，版本号+1）                           │
│  • 删除文档（软删除，不可恢复）                                    │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 与旧模式对比

| 维度 | 旧模式（已废弃） | 新模式（多文档 KB） |
|------|-----------------|-------------------|
| 群组与文档关系 | 1:1（`prdDocumentId`） | 1:N（最多10个） |
| 文档格式 | 仅 `.md` | `.pdf` + `.md` |
| 上传方式 | 文本内容直传 | 二进制 multipart/form-data |
| 创建群组 | 必须先上传 PRD | 只需群名，文档后续添加 |
| 对话前置条件 | 必须绑定文档 | 有 session 即可（无文档时报错提示） |
| 文件存储 | 后端直存文本到 MongoDB | COS 对象存储 + MongoDB 元数据 |
| 删除方式 | 无删除功能 | 软删除（`status=Deleted`） |
| 替换方式 | 无替换功能 | 原地替换 + 版本号递增 |
| LLM 注入 | 单文档文本 | 多文档标签拼接 |
| 引用跳转 | 基于 ParsedPrd 提取 | 暂时禁用（TODO 多文档引用） |

---

## 3. 系统架构

### 3.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│  桌面客户端（Tauri）                                       │
│  ┌──────────────────┐  ┌───────────────────────────┐    │
│  │  KnowledgeBasePage │  │  kbStore (Zustand)        │    │
│  │  (React UI)       │  │  loadDocuments / upload   │    │
│  │                   │  │  replace / delete / clear │    │
│  └────────┬──────────┘  └────────────┬──────────────┘    │
│           │  invoke()                 │                   │
│  ┌────────▼───────────────────────────▼──────────────┐   │
│  │  commands/kb.rs (Tauri Commands)                   │   │
│  │  list / upload / replace / delete / get_content   │   │
│  └────────────────────────┬──────────────────────────┘   │
│                           │  reqwest (multipart)         │
└───────────────────────────┼──────────────────────────────┘
                            │  HTTP API
┌───────────────────────────▼──────────────────────────────┐
│  后端 API (.NET 8)                                        │
│  ┌────────────────────────────────────────────────────┐  │
│  │  KnowledgeBaseController                           │  │
│  │  Route: api/v1/groups/{groupId}/kb/documents       │  │
│  │  GET / POST / GET {id} / GET {id}/content          │  │
│  │  PUT {id} / DELETE {id}                            │  │
│  └────────────────────────┬───────────────────────────┘  │
│                           │                              │
│  ┌────────────────────────▼───────────────────────────┐  │
│  │  KnowledgeBaseService                              │  │
│  │  • 文件校验（格式/大小/数量）                          │  │
│  │  • COS 上传/删除                                    │  │
│  │  • PDF 文本提取（PdfPig）                            │  │
│  │  • Token 估算                                      │  │
│  │  • MongoDB CRUD                                    │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  ┌────────────────────────────────────────────────────┐  │
│  │  ChatService（对话时注入知识库）                       │  │
│  │  kbDocuments → BuildMultiDocContextMessage          │  │
│  │  → LLM messages[0] (user role)                     │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

### 3.2 数据流

#### 上传流程

```
React (File API)
  → file.arrayBuffer()
  → Array.from(new Uint8Array(buffer))   // JS → Rust IPC 传输
  → Rust: reqwest::multipart::Form       // 组装 multipart
  → HTTP POST /groups/{gid}/kb/documents
  → Controller: IFormFile → byte[]
  → Service.ValidateFile()               // 格式/大小/数量校验
  → Storage.SaveAsync()                  // COS 上传，返回 URL+SHA256
  → ExtractText()                        // PDF用PdfPig，MD直接UTF8解码
  → EstimateTokens()                     // charCount / 1.8
  → MongoDB InsertOne                    // 落库
  → 返回 KbDocumentResponse
```

#### 对话注入流程

```
ChatService.SendMessageAsync()
  → _kbService.GetActiveDocumentsAsync(groupId)     // 查询活跃文档
  → kbDocuments.Count == 0 → 报错"未绑定知识库"
  → _promptManager.BuildMultiDocContextMessage()    // 拼接多文档
  → messages[0] = { role: "user", content: "[[CONTEXT:KB]]..[[/CONTEXT:KB]]" }
  → messages[1..N] = 历史对话
  → messages[last] = 当前用户输入
  → LLM.StreamGenerateAsync(systemPrompt, messages)
```

---

## 4. API 接口定义

### 4.1 路由

基础路径：`api/v1/groups/{groupId}/kb/documents`

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/` | 获取文档列表 | 群成员 |
| POST | `/` | 上传文档（多文件） | 群主 |
| GET | `/{documentId}` | 获取单个文档元信息 | 群成员 |
| GET | `/{documentId}/content` | 获取文档文本内容 | 群成员 |
| PUT | `/{documentId}` | 替换文档 | 群主 |
| DELETE | `/{documentId}` | 删除文档 | 群主 |

### 4.2 请求/响应格式

#### POST 上传（multipart/form-data）

```
Content-Type: multipart/form-data
Form field: files (multiple)
Request-Size-Limit: 110MB (10 files × 10MB + overhead)
```

**Response 201:**
```json
{
  "success": true,
  "data": [
    {
      "documentId": "a1b2c3d4...",
      "fileName": "prd-v2.pdf",
      "fileType": "pdf",
      "fileSize": 1048576,
      "charCount": 15000,
      "tokenEstimate": 8333,
      "uploadedAt": "2026-01-23T10:00:00Z",
      "replaceVersion": 1,
      "hasTextContent": true
    }
  ]
}
```

#### PUT 替换（multipart/form-data）

```
Content-Type: multipart/form-data
Form field: file (single)
Request-Size-Limit: 11MB
```

#### GET 内容

```json
{
  "success": true,
  "data": {
    "documentId": "a1b2c3d4...",
    "fileName": "prd-v2.pdf",
    "textContent": "# PRD 文档\n\n...",
    "fileUrl": "https://cos.example.com/kb-documents/pdf/xxx"
  }
}
```

---

## 5. 数据模型

### 5.1 MongoDB 集合：`kb_documents`

```csharp
public class KbDocument
{
    public string DocumentId { get; set; }      // UUID (32位hex)
    public string GroupId { get; set; }          // 所属群组
    public string FileName { get; set; }         // 原始文件名
    public KbFileType FileType { get; set; }     // Pdf | Markdown
    public long FileSize { get; set; }           // 字节数
    public string FileUrl { get; set; }          // COS 存储 URL
    public string FileSha256 { get; set; }       // COS 对象 SHA256
    public string? TextContent { get; set; }     // 提取的文本（LLM注入用）
    public int CharCount { get; set; }           // 字符数
    public int TokenEstimate { get; set; }       // Token 估算 (charCount/1.8)
    public string UploadedBy { get; set; }       // 上传者 UserId
    public DateTime UploadedAt { get; set; }     // 上传时间 UTC
    public int ReplaceVersion { get; set; }      // 版本号（从1开始）
    public KbDocumentStatus Status { get; set; } // Active | Deleted
}
```

### 5.2 前端类型定义

```typescript
// TypeScript (prd-desktop)
export interface KbDocument {
  documentId: string;
  fileName: string;
  fileType: string;       // "pdf" | "markdown"
  fileSize: number;
  charCount: number;
  tokenEstimate: number;
  uploadedAt: string;
  replaceVersion: number;
  hasTextContent: boolean;
}

export interface KbDocumentContent {
  documentId: string;
  fileName: string;
  textContent: string | null;
  fileUrl: string;
}
```

### 5.3 Rust IPC 类型

```rust
// Tauri commands (prd-desktop)
pub struct KbFileInput {
    pub file_name: String,
    pub content: Vec<u8>,       // JS ArrayBuffer → Vec<u8>
    pub mime_type: String,
}

pub struct KbDocumentInfo { /* 对应 KbDocumentResponse */ }
pub struct KbDocumentContentInfo { /* 对应 KbDocumentContentResponse */ }
```

---

## 6. 业务规则

### 6.1 文件校验

| 规则 | 值 | 校验层 |
|------|------|--------|
| 最大文档数/群组 | 10 | 前端 + Service |
| 单文件最大大小 | 10 MB | 前端 + Service |
| 允许格式 | `.pdf`, `.md` | 前端 + Service |
| 空文件 | 拒绝 | Service |
| 单次上传最大文件数 | 10 | Controller |

### 6.2 权限控制

| 操作 | 权限要求 |
|------|----------|
| 查看文档列表 | 群组成员 (`IsMemberAsync`) |
| 查看文档内容 | 群组成员 |
| 上传文档 | 群主 (`group.OwnerId == userId`) |
| 替换文档 | 群主 |
| 删除文档 | 群主 |

### 6.3 删除策略

- **软删除**：设置 `Status = Deleted`，不物理删除 MongoDB 记录
- **COS 文件**：删除操作不主动清理 COS 文件（避免误删）
- **替换时清理**：替换文档会删除旧文件的 COS 对象（失败仅 log warning）
- **不可恢复**：前端无取消删除入口

### 6.4 Token 估算算法

```
TokenEstimate = CharCount / 1.8
```

折中考虑中英混合文本（中文约 1.5 字/token，英文约 4 字符/token）。

---

## 7. LLM 上下文注入

### 7.1 注入格式

多文档内容通过 `PromptManager.BuildMultiDocContextMessage()` 拼接后，作为 messages 的第一条 user 消息注入：

```
[[CONTEXT:KB]]
<KB_DOC name="prd-v2.md">
# 产品需求文档
...全文内容...
</KB_DOC>

<KB_DOC name="技术方案.pdf">
...提取的文本内容...
</KB_DOC>

[[/CONTEXT:KB]]
```

### 7.2 消息构成

```
messages = [
  { role: "user",      content: "[[CONTEXT:KB]]...[[/CONTEXT:KB]]" },  // KB 上下文
  { role: "user",      content: "历史消息1" },                           // 历史对话
  { role: "assistant", content: "历史回复1" },
  { role: "user",      content: "当前用户输入" }                          // 当前问题
]
```

### 7.3 对话前置条件

- 群组必须至少有 1 份活跃的 KB 文档
- 无文档时返回 SSE error 事件：`DOCUMENT_NOT_FOUND`

---

## 8. 文本提取

### 8.1 Markdown 文件

直接 UTF-8 解码 `byte[] → string`。

### 8.2 PDF 文件

使用 [PdfPig](https://www.nuget.org/packages/PdfPig/) 库（NuGet 包 `PdfPig` v0.1.13）：

```csharp
using var document = PdfDocument.Open(content);
foreach (var page in document.GetPages())
{
    var text = page.Text;
    // 拼接非空页面文本
}
```

- 解析失败（加密/扫描件等）→ `TextContent = null`，`CharCount = 0`
- 仅 log warning，不阻断上传流程

---

## 9. 存储设计

### 9.1 COS 对象存储

| 字段 | 值 |
|------|------|
| Domain | `kb-documents` |
| Type (PDF) | `pdf` |
| Type (MD) | `md` |
| 去重 | SHA256 内容哈希 |
| URL 格式 | `https://cos.example.com/kb-documents/{type}/{hash}` |

### 9.2 替换时的存储操作

```
1. 上传新文件 → SaveAsync() → 获得新 URL + SHA256
2. 删除旧文件 → DeleteByShaAsync(oldSha256)（失败仅 warning）
3. 更新 MongoDB 记录（URL/SHA256/文件名/文本/版本号）
```

---

## 10. 前端实现

### 10.1 页面：KnowledgeBasePage

**入口**：侧边栏「知识库」按钮 → `mode='Knowledge'`

**功能**：
- 文档列表（文件名、类型图标、大小、字符数、Token 数）
- 上传按钮（支持多选，`accept=".pdf,.md"`）
- 操作菜单（预览/替换/删除）
- 预览 modal（显示提取的文本内容）
- 数量上限提示（N/10 份文档）

### 10.2 状态管理：kbStore

```typescript
interface KbState {
  documents: KbDocument[];
  loading: boolean;
  error: string | null;
  loadDocuments(groupId): Promise<void>;
  uploadDocuments(groupId, files): Promise<boolean>;
  replaceDocument(groupId, documentId, file): Promise<boolean>;
  deleteDocument(groupId, documentId): Promise<boolean>;
  clear(): void;
}
```

### 10.3 Tauri IPC 调用链

```
React (File API)
  → file.arrayBuffer()
  → Array.from(new Uint8Array(buffer))
  → invoke('upload_kb_documents', { groupId, files: KbFileInput[] })
  → Rust: reqwest multipart form
  → HTTP API
```

---

## 11. 单元测试覆盖

测试文件：`tests/PrdAgent.Api.Tests/Services/KnowledgeBaseServiceTests.cs`

| 测试类别 | 用例数 | 覆盖场景 |
|---------|--------|----------|
| 上传验证 | 4 | 空文件、超大文件、不支持格式(.docx/.txt) |
| 数量上限 | 3 | 超限（8+3>10）、已满（10+1）、恰好差一（9+1=10） |
| 上传成功 | 5 | MD文件、多文件批量、PDF文件、10MB边界、ID唯一性 |
| 文件类型检测 | 6 | .pdf/.PDF/.Pdf/.md/.MD/.Md (Theory) |
| 文本提取 | 2 | Markdown正确提取、无效PDF返回null |
| Token估算 | 1 | charCount/1.8 比率验证 |
| 删除 | 3 | 文档不存在、群组不匹配、正常软删除 |
| 替换 | 5 | 文档不存在、群组不匹配、超大文件、正常替换+旧文件删除、旧文件删除失败不影响 |
| 边界 | 2 | 存储服务异常透传、文档ID唯一性 |
| **总计** | **31** | - |

---

## 12. 关键文件索引

### 后端 (.NET)

| 文件 | 路径 | 职责 |
|------|------|------|
| Controller | `prd-api/src/PrdAgent.Api/Controllers/KnowledgeBaseController.cs` | API 入口、权限校验 |
| Service | `prd-api/src/PrdAgent.Infrastructure/Services/KnowledgeBaseService.cs` | 业务逻辑 |
| Interface | `prd-api/src/PrdAgent.Core/Interfaces/IKnowledgeBaseService.cs` | 服务接口 + KbUploadFile |
| Model | `prd-api/src/PrdAgent.Core/Models/KbDocument.cs` | 数据模型 |
| Prompt | `prd-api/src/PrdAgent.Infrastructure/Prompts/PromptManager.cs:100` | 多文档拼接 |
| Chat | `prd-api/src/PrdAgent.Core/Services/ChatService.cs:103-207` | KB 注入对话 |
| Tests | `prd-api/tests/PrdAgent.Api.Tests/Services/KnowledgeBaseServiceTests.cs` | 单元测试 |

### 桌面客户端 (Tauri)

| 文件 | 路径 | 职责 |
|------|------|------|
| Rust Commands | `prd-desktop/src-tauri/src/commands/kb.rs` | IPC 命令 |
| Rust Models | `prd-desktop/src-tauri/src/models/mod.rs` | 数据结构 |
| API Client | `prd-desktop/src-tauri/src/services/api_client.rs` | multipart 方法 |
| TypeScript Types | `prd-desktop/src/types/index.ts` | 前端类型 |
| Store | `prd-desktop/src/stores/kbStore.ts` | 状态管理 |
| Page | `prd-desktop/src/components/KnowledgeBase/KnowledgeBasePage.tsx` | 管理界面 |
| Sidebar | `prd-desktop/src/components/Layout/Sidebar.tsx` | 入口按钮 |

---

## 13. 已知限制与 TODO

| 项目 | 状态 | 说明 |
|------|------|------|
| 多文档引用跳转 | TODO | 旧的 `DocCitationExtractor` 基于单个 ParsedPrd，多文档场景需重新设计 |
| COS 孤立文件清理 | TODO | 软删除后 COS 文件未清理，需定期清理任务 |
| 文档内容搜索 | TODO | 当前无全文搜索能力，仅按文件名区分 |
| Token 精确计算 | TODO | 当前使用 `charCount/1.8` 估算，可接入 tiktoken |
| 扫描件 PDF | 已处理 | 解析失败时 `TextContent=null`，不阻断上传 |
| 大文件流式上传 | 未实现 | 当前全量读入内存，10MB 上限下可接受 |
| 文档排序 | 已实现 | 按 `UploadedAt` 升序排列 |
| 并发上传冲突 | 已处理 | 数量校验在 Service 层，MongoDB 原子操作 |

---

## 14. 废弃清单

以下概念/文件/API 已被本功能替代，不应再使用：

| 废弃项 | 替代方案 |
|--------|----------|
| `DocumentUpload.tsx` | `KnowledgeBasePage.tsx` |
| `commands/document.rs` | `commands/kb.rs` |
| `nameHeuristics.ts` | 已删除（群名不再依赖文档内容） |
| `upload_document` 命令 | `upload_kb_documents` |
| `bind_group_prd` 命令 | 不再需要（群组不绑定单文档） |
| `get_document_content` 命令 | `get_kb_document_content` |
| `Group.prdDocumentId` 字段 | `Group.hasKnowledgeBase` + `kbDocumentCount` |
| `Session.documentId` 字段 | 已移除（文档与会话解耦） |
| `Document` / `DocumentContent` 类型 | `KbDocument` / `KbDocumentContent` |
