# å¤šé€šé“é€‚é…å™¨è®¾è®¡ï¼ˆChannel Adapterï¼‰

## æ–‡æ¡£ç‰ˆæœ¬

- **ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-02-03
- **æœ€åæ›´æ–°**ï¼š2026-02-03
- **çŠ¶æ€**ï¼šè§„åˆ’ä¸­

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯ä¸åŠ¨æœº

å½“å‰å¼€æ”¾å¹³å°ä»…æ”¯æŒ HTTP APIï¼ˆOpenAI å…¼å®¹æ ¼å¼ï¼‰ä½œä¸ºå”¯ä¸€å…¥å£ã€‚éšç€äº§å“èƒ½åŠ›æ‰©å±•ï¼Œéœ€è¦æ”¯æŒæ›´å¤šå¤–éƒ¨äº¤äº’é€šé“ï¼š

| é€šé“ | åœºæ™¯ | ç‰¹ç‚¹ |
|------|------|------|
| **é‚®ä»¶** | ç¦»çº¿å¼‚æ­¥ä»»åŠ¡ã€ç§»åŠ¨ç«¯å¿«æ·è§¦å‘ | å¤©ç„¶å¼‚æ­¥ã€æ”¯æŒé™„ä»¶ã€è¦†ç›–é¢å¹¿ |
| **çŸ­ä¿¡** | ç´§æ€¥æŒ‡ä»¤ã€æ— ç½‘ç»œç¯å¢ƒ | å­—æ•°é™åˆ¶ã€æˆæœ¬æ•æ„Ÿ |
| **Siri/è¯­éŸ³** | å…ææ“ä½œã€å¿«æ·æŒ‡ä»¤ | è‡ªç„¶è¯­è¨€ã€ä¸Šä¸‹æ–‡æœ‰é™ |
| **App Push** | ç§»åŠ¨ç«¯æ·±åº¦é›†æˆ | ç»“æ„åŒ–ã€å¯äº¤äº’ |
| **Webhook** | ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆ | äº‹ä»¶é©±åŠ¨ã€å¯ç¼–ç¨‹ |

**æ ¸å¿ƒæ´å¯Ÿ**ï¼šè¿™äº›é€šé“æœ¬è´¨ä¸Šéƒ½æ˜¯"è¾“å…¥æŒ‡ä»¤ â†’ æ‰§è¡Œä»»åŠ¡ â†’ è¾“å‡ºç»“æœ"çš„æ¨¡å¼ï¼ŒåŒºåˆ«ä»…åœ¨äºï¼š
- **Input åè®®**ï¼šå¦‚ä½•æ¥æ”¶æŒ‡ä»¤ï¼ˆé‚®ä»¶è§£æã€çŸ­ä¿¡ç½‘å…³ã€è¯­éŸ³è¯†åˆ«ï¼‰
- **Output åè®®**ï¼šå¦‚ä½•è¿”å›ç»“æœï¼ˆå›å¤é‚®ä»¶ã€çŸ­ä¿¡ã€Push é€šçŸ¥ï¼‰
- **èº«ä»½éªŒè¯**ï¼šå¦‚ä½•è¯†åˆ«ç”¨æˆ·ï¼ˆé‚®ç®±ç™½åå•ã€æ‰‹æœºå·ç»‘å®šã€è®¾å¤‡ Tokenï¼‰

### 1.2 è®¾è®¡ç›®æ ‡

1. **ç»Ÿä¸€æŠ½è±¡**ï¼šå®šä¹‰é€šé“é€‚é…å™¨æ¥å£ï¼Œæ–°é€šé“åªéœ€å®ç°é€‚é…å™¨å³å¯æ¥å…¥
2. **èº«ä»½æ˜ å°„**ï¼šä¸åŒé€šé“çš„èº«ä»½æ ‡è¯†ï¼ˆé‚®ç®±ã€æ‰‹æœºå·ï¼‰ç»Ÿä¸€æ˜ å°„åˆ°ç³»ç»Ÿç”¨æˆ·
3. **èƒ½åŠ›å¤ç”¨**ï¼šæ‰€æœ‰é€šé“å…±äº«åŒä¸€å¥—ä»»åŠ¡æ‰§è¡Œå¼•æ“ï¼ˆç°æœ‰ Agent èƒ½åŠ›ï¼‰
4. **å¯è§‚æµ‹æ€§**ï¼šç»Ÿä¸€çš„æ—¥å¿—ã€ç›‘æ§ã€å®¡è®¡

### 1.3 æ ¸å¿ƒä»·å€¼

> **"ä¸€æ¬¡ç¼–å†™ï¼Œå¤šé€šé“è§¦å‘"**
>
> ç”¨æˆ·é€šè¿‡é‚®ä»¶å‘é€ `ç”Ÿæˆä¸€å¼ å¤•é˜³ä¸‹çš„çŒ«å’ªå›¾ç‰‡`ï¼Œä¸é€šè¿‡ API è°ƒç”¨ `visual-agent` å›¾åƒç”Ÿæˆæ˜¯åŒä¸€ä¸ªä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œä»…å…¥å£å’Œå‡ºå£ä¸åŒã€‚

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Multi-Channel Gateway                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Email Inboundâ”‚  â”‚ SMS Gateway  â”‚  â”‚ Siri Shortcutâ”‚  â”‚ Webhook      â”‚    â”‚
â”‚  â”‚   Adapter    â”‚  â”‚   Adapter    â”‚  â”‚   Adapter    â”‚  â”‚   Adapter    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                 â”‚                 â”‚                 â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                      â”‚             â”‚                 â”‚                      â”‚
â”‚                      â–¼             â–¼                 â–¼                      â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚           Channel Router                     â”‚                â”‚
â”‚              â”‚  â€¢ èº«ä»½è§£æ (Identity Resolution)            â”‚                â”‚
â”‚              â”‚  â€¢ æ„å›¾è¯†åˆ« (Intent Detection)               â”‚                â”‚
â”‚              â”‚  â€¢ æƒé™æ ¡éªŒ (Permission Check)               â”‚                â”‚
â”‚              â”‚  â€¢ ç™½åå•éªŒè¯ (Whitelist Validation)         â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚           Task Dispatcher                    â”‚                â”‚
â”‚              â”‚  â€¢ è·¯ç”±åˆ°å¯¹åº” Agent                          â”‚                â”‚
â”‚              â”‚  â€¢ åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ (Task Queue)                 â”‚                â”‚
â”‚              â”‚  â€¢ ä»»åŠ¡çŠ¶æ€è¿½è¸ª                              â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                    â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â–¼                          â–¼                          â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ PRD Agent   â”‚          â”‚Visual Agent â”‚          â”‚Defect Agent â”‚         â”‚
â”‚  â”‚ (prd-agent) â”‚          â”‚(visual-agent)â”‚          â”‚(defect-agent)â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                          â”‚                          â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                    â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚           Response Dispatcher                â”‚                â”‚
â”‚              â”‚  â€¢ ç»“æœæ ¼å¼åŒ–                                â”‚                â”‚
â”‚              â”‚  â€¢ é€šé“è·¯ç”±                                  â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                    â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â–¼              â–¼           â–¼           â–¼              â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚Email Outboundâ”‚ â”‚ SMS Outbound â”‚ â”‚ Push Notif   â”‚ â”‚ Webhook CB   â”‚       â”‚
â”‚  â”‚   Adapter    â”‚ â”‚   Adapter    â”‚ â”‚   Adapter    â”‚ â”‚   Adapter    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

#### 2.2.1 Channel Adapterï¼ˆé€šé“é€‚é…å™¨ï¼‰

```csharp
/// <summary>
/// é€šé“é€‚é…å™¨æ¥å£ - æ‰€æœ‰é€šé“å¿…é¡»å®ç°
/// </summary>
public interface IChannelAdapter
{
    /// <summary>
    /// é€šé“æ ‡è¯† (email, sms, siri, webhook)
    /// </summary>
    string ChannelType { get; }

    /// <summary>
    /// æ˜¯å¦æ”¯æŒå…¥ç«™ï¼ˆæ¥æ”¶æ¶ˆæ¯ï¼‰
    /// </summary>
    bool SupportsInbound { get; }

    /// <summary>
    /// æ˜¯å¦æ”¯æŒå‡ºç«™ï¼ˆå‘é€å“åº”ï¼‰
    /// </summary>
    bool SupportsOutbound { get; }
}

/// <summary>
/// å…¥ç«™é€‚é…å™¨ - æ¥æ”¶å¤–éƒ¨æ¶ˆæ¯
/// </summary>
public interface IInboundChannelAdapter : IChannelAdapter
{
    /// <summary>
    /// è§£æå…¥ç«™æ¶ˆæ¯ä¸ºç»Ÿä¸€æ ¼å¼
    /// </summary>
    Task<ChannelMessage> ParseInboundAsync(object rawMessage, CancellationToken ct);

    /// <summary>
    /// è§£æå‘é€è€…èº«ä»½
    /// </summary>
    Task<ChannelIdentity> ResolveIdentityAsync(object rawMessage, CancellationToken ct);
}

/// <summary>
/// å‡ºç«™é€‚é…å™¨ - å‘é€å“åº”
/// </summary>
public interface IOutboundChannelAdapter : IChannelAdapter
{
    /// <summary>
    /// å‘é€å“åº”åˆ°æŒ‡å®šç›®æ ‡
    /// </summary>
    Task SendResponseAsync(ChannelResponse response, CancellationToken ct);
}
```

#### 2.2.2 Channel Messageï¼ˆç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ï¼‰

```csharp
/// <summary>
/// ç»Ÿä¸€é€šé“æ¶ˆæ¯
/// </summary>
public class ChannelMessage
{
    /// <summary>
    /// æ¶ˆæ¯å”¯ä¸€æ ‡è¯†
    /// </summary>
    public string MessageId { get; set; }

    /// <summary>
    /// é€šé“ç±»å‹
    /// </summary>
    public string ChannelType { get; set; }

    /// <summary>
    /// å‘é€è€…èº«ä»½
    /// </summary>
    public ChannelIdentity Sender { get; set; }

    /// <summary>
    /// æ¶ˆæ¯å†…å®¹ï¼ˆçº¯æ–‡æœ¬ï¼‰
    /// </summary>
    public string Content { get; set; }

    /// <summary>
    /// é™„ä»¶åˆ—è¡¨
    /// </summary>
    public List<ChannelAttachment> Attachments { get; set; }

    /// <summary>
    /// åŸå§‹æ¶ˆæ¯å…ƒæ•°æ®
    /// </summary>
    public Dictionary<string, object> Metadata { get; set; }

    /// <summary>
    /// æ¥æ”¶æ—¶é—´
    /// </summary>
    public DateTime ReceivedAt { get; set; }
}

/// <summary>
/// é€šé“èº«ä»½æ ‡è¯†
/// </summary>
public class ChannelIdentity
{
    /// <summary>
    /// é€šé“ç±»å‹
    /// </summary>
    public string ChannelType { get; set; }

    /// <summary>
    /// é€šé“å†…å”¯ä¸€æ ‡è¯†ï¼ˆé‚®ç®±åœ°å€ã€æ‰‹æœºå·ã€è®¾å¤‡IDç­‰ï¼‰
    /// </summary>
    public string ChannelIdentifier { get; set; }

    /// <summary>
    /// æ˜ å°„åˆ°çš„ç³»ç»Ÿç”¨æˆ·IDï¼ˆå¯ä¸ºç©ºï¼Œè¡¨ç¤ºæœªç»‘å®šï¼‰
    /// </summary>
    public string? MappedUserId { get; set; }

    /// <summary>
    /// æ˜¾ç¤ºåç§°
    /// </summary>
    public string? DisplayName { get; set; }
}
```

#### 2.2.3 Channel Whitelistï¼ˆç™½åå•é…ç½®ï¼‰

```csharp
/// <summary>
/// é€šé“ç™½åå•é…ç½®
/// </summary>
public class ChannelWhitelistConfig
{
    public string Id { get; set; }

    /// <summary>
    /// é€šé“ç±»å‹
    /// </summary>
    public string ChannelType { get; set; }

    /// <summary>
    /// èº«ä»½æ ‡è¯†æ¨¡å¼ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
    /// ç¤ºä¾‹ï¼š*@company.com, +8613800138000, specific@email.com
    /// </summary>
    public string IdentifierPattern { get; set; }

    /// <summary>
    /// ç»‘å®šçš„ç³»ç»Ÿç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
    /// </summary>
    public string? BoundUserId { get; set; }

    /// <summary>
    /// å…è®¸çš„ Agent åˆ—è¡¨ï¼ˆç©º=å…¨éƒ¨å…è®¸ï¼‰
    /// </summary>
    public List<string>? AllowedAgents { get; set; }

    /// <summary>
    /// å…è®¸çš„æ“ä½œç±»å‹
    /// </summary>
    public List<string>? AllowedOperations { get; set; }

    /// <summary>
    /// æ¯æ—¥è°ƒç”¨é™é¢
    /// </summary>
    public int? DailyQuota { get; set; }

    /// <summary>
    /// æ˜¯å¦å¯ç”¨
    /// </summary>
    public bool IsActive { get; set; }

    /// <summary>
    /// å¤‡æ³¨
    /// </summary>
    public string? Note { get; set; }

    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
}
```

### 2.3 æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®Œæ•´æ•°æ®æµ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. å…¥ç«™é˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å¤–éƒ¨æ¶ˆæ¯ â”‚ â”€â”€â”€â–¶ â”‚ Inbound     â”‚ â”€â”€â”€â–¶ â”‚ Channel     â”‚
   â”‚ (é‚®ä»¶)   â”‚      â”‚ Adapter     â”‚      â”‚ Message     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                     â”‚
                          â–¼                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
                    â”‚ Identity    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Resolver    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
2. è·¯ç”±é˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Whitelist   â”‚ â”€â”€â”€â–¶ â”‚ Intent      â”‚ â”€â”€â”€â–¶ â”‚ Task        â”‚
   â”‚ Validator   â”‚      â”‚ Detector    â”‚      â”‚ Creator     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                     â”‚
         â”‚ æ‹’ç»æœªæˆæƒ          â”‚ è§£æç”¨æˆ·æ„å›¾         â”‚ åˆ›å»ºä»»åŠ¡
         â–¼                    â–¼                     â–¼

3. æ‰§è¡Œé˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Task Queue  â”‚ â”€â”€â”€â–¶ â”‚ Agent       â”‚ â”€â”€â”€â–¶ â”‚ Task Result â”‚
   â”‚             â”‚      â”‚ Executor    â”‚      â”‚             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ è°ƒç”¨å¯¹åº” Agent
                              â–¼

4. å‡ºç«™é˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Response    â”‚ â”€â”€â”€â–¶ â”‚ Outbound    â”‚ â”€â”€â”€â–¶ â”‚ å‘é€å“åº”    â”‚
   â”‚ Formatter   â”‚      â”‚ Adapter     â”‚      â”‚ (å›å¤é‚®ä»¶)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. é‚®ä»¶é€šé“è¯¦ç»†è®¾è®¡ï¼ˆé¦–æœŸå®ç°ï¼‰

### 3.1 é‚®ä»¶é€šé“æ¦‚è¿°

é‚®ä»¶é€šé“æ˜¯ç¬¬ä¸€ä¸ªå®ç°çš„é HTTP é€šé“ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å¼‚æ­¥å¤„ç†** | é‚®ä»¶å¤©ç„¶å¼‚æ­¥ï¼Œç”¨æˆ·å‘é€åä¸éœ€è¦å®æ—¶ç­‰å¾… |
| **æ”¯æŒé™„ä»¶** | å¯ä¸Šä¼ å›¾ç‰‡ã€æ–‡æ¡£ä½œä¸ºä»»åŠ¡è¾“å…¥ |
| **è¦†ç›–å¹¿æ³›** | å‡ ä¹æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰é‚®ç®± |
| **å¯è¿½æº¯** | é‚®ä»¶æœ¬èº«å°±æ˜¯å®Œæ•´çš„ä»»åŠ¡è®°å½• |
| **ç¦»çº¿è§¦å‘** | ä¸éœ€è¦æ‰“å¼€ App/ç½‘é¡µï¼Œéšæ—¶å‘é€ |

### 3.2 é‚®ä»¶äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           é‚®ä»¶äº¤äº’å®Œæ•´æµç¨‹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·                      é‚®ä»¶æœåŠ¡å™¨                   PRD Agent
  â”‚                           â”‚                           â”‚
  â”‚  1. å‘é€é‚®ä»¶åˆ°            â”‚                           â”‚
  â”‚     agent@company.com     â”‚                           â”‚
  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚  2. Webhook/IMAP æ¨é€     â”‚
  â”‚                           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚                           â”‚  3. è§£æé‚®ä»¶
  â”‚                           â”‚                           â”‚  â€¢ æå–å‘ä»¶äºº
  â”‚                           â”‚                           â”‚  â€¢ æå–ä¸»é¢˜/æ­£æ–‡
  â”‚                           â”‚                           â”‚  â€¢ ä¸‹è½½é™„ä»¶
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚                           â”‚  4. èº«ä»½éªŒè¯
  â”‚                           â”‚                           â”‚  â€¢ ç™½åå•åŒ¹é…
  â”‚                           â”‚                           â”‚  â€¢ ç”¨æˆ·ç»‘å®šæŸ¥æ‰¾
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚                           â”‚  5. æ„å›¾è¯†åˆ«
  â”‚                           â”‚                           â”‚  â€¢ è§£ææŒ‡ä»¤
  â”‚                           â”‚                           â”‚  â€¢ è·¯ç”±åˆ° Agent
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚                           â”‚  6. åˆ›å»ºä»»åŠ¡
  â”‚                           â”‚                           â”‚  â€¢ å…¥é˜Ÿç­‰å¾…æ‰§è¡Œ
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚  7. ç¡®è®¤æ”¶åˆ°ï¼ˆå¯é€‰ï¼‰      â”‚
  â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
  â”‚  "å·²æ”¶åˆ°æ‚¨çš„è¯·æ±‚ï¼Œæ­£åœ¨å¤„ç†" â”‚                           â”‚
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚                           â”‚  8. æ‰§è¡Œä»»åŠ¡
  â”‚                           â”‚                           â”‚  â€¢ è°ƒç”¨å¯¹åº” Agent
  â”‚                           â”‚                           â”‚  â€¢ ç”Ÿæˆç»“æœ
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚  9. å‘é€ç»“æœé‚®ä»¶          â”‚
  â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
  â”‚  "æ‚¨çš„ä»»åŠ¡å·²å®Œæˆï¼Œç»“æœå¦‚ä¸‹" â”‚                           â”‚
  â”‚                           â”‚                           â”‚
```

### 3.3 é‚®ä»¶æ ¼å¼è§„èŒƒ

#### 3.3.1 ç”¨æˆ·å‘é€æ ¼å¼

**æ–¹å¼ä¸€ï¼šä¸»é¢˜æŒ‡ä»¤**
```
æ”¶ä»¶äºº: agent@prdagent.com
ä¸»é¢˜: [ç”Ÿå›¾] ä¸€åªåœ¨å¤•é˜³ä¸‹å¥”è·‘çš„é‡‘æ¯›çŠ¬
æ­£æ–‡: (å¯é€‰çš„è¯¦ç»†æè¿°æˆ–å‚æ•°)
```

**æ–¹å¼äºŒï¼šæ­£æ–‡æŒ‡ä»¤**
```
æ”¶ä»¶äºº: agent@prdagent.com
ä¸»é¢˜: ä»»åŠ¡è¯·æ±‚
æ­£æ–‡:
è¯·å¸®æˆ‘ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼šä¸€åªåœ¨å¤•é˜³ä¸‹å¥”è·‘çš„é‡‘æ¯›çŠ¬

é£æ ¼ï¼šå†™å®æ‘„å½±é£æ ¼
å°ºå¯¸ï¼š16:9
```

**æ–¹å¼ä¸‰ï¼šé™„ä»¶è§¦å‘**
```
æ”¶ä»¶äºº: agent@prdagent.com
ä¸»é¢˜: åˆ†æè¿™å¼ æˆªå›¾
æ­£æ–‡: è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªåŸå‹è®¾è®¡çš„é—®é¢˜
é™„ä»¶: screenshot.png
```

#### 3.3.2 ç³»ç»Ÿå›å¤æ ¼å¼

**ä»»åŠ¡ç¡®è®¤é‚®ä»¶**
```
å‘ä»¶äºº: agent@prdagent.com
æ”¶ä»¶äºº: user@company.com
ä¸»é¢˜: Re: [ç”Ÿå›¾] ä¸€åªåœ¨å¤•é˜³ä¸‹å¥”è·‘çš„é‡‘æ¯›çŠ¬

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¬ ä»»åŠ¡å·²æ¥æ”¶

ä»»åŠ¡ç±»å‹ï¼šå›¾åƒç”Ÿæˆ
ä»»åŠ¡ç¼–å·ï¼šTASK-20260203-001
é¢„è®¡å®Œæˆï¼š5-10 åˆ†é’Ÿ

æ‚¨å¯ä»¥å›å¤æœ¬é‚®ä»¶è¿½é—®æˆ–å–æ¶ˆä»»åŠ¡ã€‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PRD Agent Â· å¤šé€šé“æ™ºèƒ½åŠ©æ‰‹
```

**ä»»åŠ¡å®Œæˆé‚®ä»¶**
```
å‘ä»¶äºº: agent@prdagent.com
æ”¶ä»¶äºº: user@company.com
ä¸»é¢˜: Re: [ç”Ÿå›¾] ä¸€åªåœ¨å¤•é˜³ä¸‹å¥”è·‘çš„é‡‘æ¯›çŠ¬

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… ä»»åŠ¡å®Œæˆ

ä»»åŠ¡ç±»å‹ï¼šå›¾åƒç”Ÿæˆ
ä»»åŠ¡ç¼–å·ï¼šTASK-20260203-001
è€—æ—¶ï¼š42 ç§’

ç”Ÿæˆç»“æœï¼š
[å›¾ç‰‡é™„ä»¶æˆ– CDN é“¾æ¥]

ğŸ“ å›¾ç‰‡æè¿°ï¼š
ä¸€åªé‡‘æ¯›çŠ¬åœ¨é‡‘è‰²å¤•é˜³ä¸‹çš„æµ·æ»©ä¸Šå¥”è·‘ï¼Œ
åŠ¨æ€æ¨¡ç³Šæ•ˆæœçªå‡ºé€Ÿåº¦æ„Ÿï¼Œæ¸©æš–çš„è‰²è°ƒ...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å›å¤æœ¬é‚®ä»¶å¯ç»§ç»­å¯¹è¯æˆ–æäº¤æ–°ä»»åŠ¡
PRD Agent Â· å¤šé€šé“æ™ºèƒ½åŠ©æ‰‹
```

**é”™è¯¯é€šçŸ¥é‚®ä»¶**
```
å‘ä»¶äºº: agent@prdagent.com
æ”¶ä»¶äºº: user@company.com
ä¸»é¢˜: Re: [ç”Ÿå›¾] ä¸€åªåœ¨å¤•é˜³ä¸‹å¥”è·‘çš„é‡‘æ¯›çŠ¬

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŒ ä»»åŠ¡å¤±è´¥

ä»»åŠ¡ç±»å‹ï¼šå›¾åƒç”Ÿæˆ
ä»»åŠ¡ç¼–å·ï¼šTASK-20260203-001
å¤±è´¥åŸå› ï¼šå†…å®¹å®‰å…¨ç­–ç•¥æ‹¦æˆª

æ‚¨çš„è¯·æ±‚åŒ…å«äº†ä¸å…è®¸ç”Ÿæˆçš„å†…å®¹ç±»å‹ã€‚
è¯·ä¿®æ”¹æè¿°åé‡æ–°æäº¤ã€‚

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PRD Agent Â· å¤šé€šé“æ™ºèƒ½åŠ©æ‰‹
```

### 3.4 é‚®ä»¶æ„å›¾è¯†åˆ«

#### 3.4.1 æŒ‡ä»¤å‰ç¼€æ˜ å°„

| å‰ç¼€æ ‡ç­¾ | Agent | æ“ä½œç±»å‹ | ç¤ºä¾‹ |
|----------|-------|----------|------|
| `[ç”Ÿå›¾]` `[ç”»å›¾]` `[å›¾ç‰‡]` | visual-agent | image-gen | `[ç”Ÿå›¾] å¤•é˜³ä¸‹çš„çŒ«` |
| `[ç¼ºé™·]` `[BUG]` `[é—®é¢˜]` | defect-agent | create | `[ç¼ºé™·] ç™»å½•é¡µé¢æ ·å¼é”™ä¹±` |
| `[PRD]` `[éœ€æ±‚]` `[æ–‡æ¡£]` | prd-agent | query | `[PRD] ç”¨æˆ·æ³¨å†Œæµç¨‹æ˜¯ä»€ä¹ˆ` |
| `[æŸ¥è¯¢]` `[åˆ—è¡¨]` | - | query | `[æŸ¥è¯¢] æœ€è¿‘çš„ç¼ºé™·` |
| `[å–æ¶ˆ]` `[åœæ­¢]` | - | cancel | `[å–æ¶ˆ] TASK-xxx` |
| `[å¸®åŠ©]` `[help]` | - | help | `[å¸®åŠ©]` |

#### 3.4.2 è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«

å½“æ²¡æœ‰æ˜ç¡®å‰ç¼€æ—¶ï¼Œä½¿ç”¨ LLM è¿›è¡Œæ„å›¾è¯†åˆ«ï¼š

```json
{
  "appCallerCode": "channel.email::intent",
  "modelType": "intent",
  "prompt": "åˆ†æä»¥ä¸‹é‚®ä»¶å†…å®¹ï¼Œè¯†åˆ«ç”¨æˆ·æ„å›¾...",
  "expectedOutput": {
    "intent": "image-gen | defect-create | prd-query | ...",
    "agent": "visual-agent | defect-agent | prd-agent",
    "parameters": { ... },
    "confidence": 0.95
  }
}
```

### 3.5 é‚®ä»¶é€‚é…å™¨å®ç°

```csharp
/// <summary>
/// é‚®ä»¶å…¥ç«™é€‚é…å™¨
/// </summary>
public class EmailInboundAdapter : IInboundChannelAdapter
{
    public string ChannelType => "email";
    public bool SupportsInbound => true;
    public bool SupportsOutbound => false;

    private readonly IEmailParser _emailParser;
    private readonly IAttachmentProcessor _attachmentProcessor;

    public async Task<ChannelMessage> ParseInboundAsync(object rawMessage, CancellationToken ct)
    {
        var emailData = rawMessage as EmailWebhookPayload;

        return new ChannelMessage
        {
            MessageId = emailData.MessageId,
            ChannelType = "email",
            Content = ExtractContent(emailData),
            Attachments = await ProcessAttachments(emailData.Attachments, ct),
            Metadata = new Dictionary<string, object>
            {
                ["subject"] = emailData.Subject,
                ["inReplyTo"] = emailData.InReplyTo,
                ["references"] = emailData.References,
                ["receivedAt"] = emailData.Date
            },
            ReceivedAt = DateTime.UtcNow
        };
    }

    public async Task<ChannelIdentity> ResolveIdentityAsync(object rawMessage, CancellationToken ct)
    {
        var emailData = rawMessage as EmailWebhookPayload;

        return new ChannelIdentity
        {
            ChannelType = "email",
            ChannelIdentifier = emailData.From.Email.ToLowerInvariant(),
            DisplayName = emailData.From.Name
        };
    }
}

/// <summary>
/// é‚®ä»¶å‡ºç«™é€‚é…å™¨
/// </summary>
public class EmailOutboundAdapter : IOutboundChannelAdapter
{
    public string ChannelType => "email";
    public bool SupportsInbound => false;
    public bool SupportsOutbound => true;

    private readonly IEmailSender _emailSender;
    private readonly IEmailTemplateRenderer _templateRenderer;

    public async Task SendResponseAsync(ChannelResponse response, CancellationToken ct)
    {
        var template = response.ResponseType switch
        {
            "task-received" => "email-task-received",
            "task-completed" => "email-task-completed",
            "task-failed" => "email-task-failed",
            _ => "email-generic"
        };

        var htmlBody = await _templateRenderer.RenderAsync(template, response.Data, ct);

        await _emailSender.SendAsync(new EmailMessage
        {
            To = response.RecipientIdentifier,
            Subject = $"Re: {response.OriginalSubject}",
            HtmlBody = htmlBody,
            Attachments = response.Attachments,
            InReplyTo = response.OriginalMessageId,
            References = response.ThreadReferences
        }, ct);
    }
}
```

### 3.6 é‚®ä»¶æ¥æ”¶æ–¹æ¡ˆ

#### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®æ—¶æ€§ | å¤æ‚åº¦ | æˆæœ¬ | æ¨èåœºæ™¯ |
|------|--------|--------|------|----------|
| **IMAP è½®è¯¢** | åˆ†é’Ÿçº§ | ä½ | å…è´¹ | å°è§„æ¨¡ã€ä½é¢‘ |
| **IMAP IDLE** | ç§’çº§ | ä¸­ | å…è´¹ | ä¸­ç­‰è§„æ¨¡ |
| **Webhookï¼ˆæ¨èï¼‰** | å®æ—¶ | ä¸­ | æŒ‰é‡ä»˜è´¹ | ç”Ÿäº§ç¯å¢ƒ |

#### æ¨èæ–¹æ¡ˆï¼šé‚®ä»¶æœåŠ¡ Webhook

ä½¿ç”¨ç¬¬ä¸‰æ–¹é‚®ä»¶æœåŠ¡ï¼ˆå¦‚ SendGridã€Mailgunã€Postmarkï¼‰çš„ Inbound Parse åŠŸèƒ½ï¼š

```
ç”¨æˆ·å‘é€é‚®ä»¶
     â”‚
     â–¼
é‚®ä»¶æœåŠ¡å™¨ (MX è®°å½•æŒ‡å‘ SendGrid)
     â”‚
     â–¼
SendGrid Inbound Parse
     â”‚
     â–¼
Webhook POST åˆ° /api/channels/email/inbound
     â”‚
     â–¼
PRD Agent å¤„ç†
```

**Webhook ç«¯ç‚¹è®¾è®¡**ï¼š

```csharp
[ApiController]
[Route("api/channels/email")]
public class EmailChannelController : ControllerBase
{
    private readonly IChannelRouter _router;
    private readonly EmailInboundAdapter _adapter;

    /// <summary>
    /// æ¥æ”¶é‚®ä»¶æœåŠ¡å•†çš„ Webhook æ¨é€
    /// </summary>
    [HttpPost("inbound")]
    public async Task<IActionResult> ReceiveInbound(
        [FromForm] SendGridInboundPayload payload,
        CancellationToken ct)
    {
        // 1. éªŒè¯ Webhook ç­¾å
        if (!ValidateWebhookSignature(Request))
            return Unauthorized();

        // 2. è§£æé‚®ä»¶
        var message = await _adapter.ParseInboundAsync(payload, ct);
        var identity = await _adapter.ResolveIdentityAsync(payload, ct);

        // 3. è·¯ç”±åˆ°é€šé“å¤„ç†å™¨
        var result = await _router.RouteAsync(message, identity, ct);

        // 4. è¿”å› 200 ç¡®è®¤æ”¶åˆ°
        return Ok();
    }
}
```

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 MongoDB é›†åˆ

#### channel_whitelistï¼ˆé€šé“ç™½åå•ï¼‰

```javascript
{
  "_id": "wl_email_001",
  "channelType": "email",
  "identifierPattern": "*@company.com",  // æ”¯æŒé€šé…ç¬¦
  "boundUserId": null,                    // å¯ç»‘å®šåˆ°ç‰¹å®šç”¨æˆ·
  "allowedAgents": ["visual-agent", "prd-agent"],
  "allowedOperations": ["image-gen", "query"],
  "dailyQuota": 100,
  "isActive": true,
  "note": "å…¬å¸å‘˜å·¥é‚®ç®±",
  "createdAt": "2026-02-03T00:00:00Z",
  "createdBy": "admin_001"
}
```

#### channel_identity_mappingsï¼ˆèº«ä»½æ˜ å°„ï¼‰

```javascript
{
  "_id": "map_001",
  "channelType": "email",
  "channelIdentifier": "zhangsan@company.com",
  "userId": "user_001",
  "displayName": "å¼ ä¸‰",
  "isVerified": true,
  "verifiedAt": "2026-02-03T00:00:00Z",
  "createdAt": "2026-02-03T00:00:00Z"
}
```

#### channel_tasksï¼ˆé€šé“ä»»åŠ¡ï¼‰

```javascript
{
  "_id": "task_20260203_001",
  "channelType": "email",
  "channelMessageId": "msg_xxx@mail.gmail.com",
  "senderIdentifier": "zhangsan@company.com",
  "mappedUserId": "user_001",

  "intent": "image-gen",
  "targetAgent": "visual-agent",
  "originalContent": "[ç”Ÿå›¾] å¤•é˜³ä¸‹çš„é‡‘æ¯›çŠ¬",
  "parsedParameters": {
    "prompt": "å¤•é˜³ä¸‹çš„é‡‘æ¯›çŠ¬",
    "style": "photography"
  },

  "status": "completed",  // pending, processing, completed, failed, cancelled
  "statusHistory": [
    { "status": "pending", "at": "2026-02-03T10:00:00Z" },
    { "status": "processing", "at": "2026-02-03T10:00:05Z" },
    { "status": "completed", "at": "2026-02-03T10:00:47Z" }
  ],

  "result": {
    "type": "image",
    "imageUrl": "https://cdn.example.com/xxx.png",
    "metadata": { ... }
  },
  "error": null,

  "responsesSent": [
    {
      "type": "task-received",
      "sentAt": "2026-02-03T10:00:05Z",
      "messageId": "resp_001"
    },
    {
      "type": "task-completed",
      "sentAt": "2026-02-03T10:00:48Z",
      "messageId": "resp_002"
    }
  ],

  "createdAt": "2026-02-03T10:00:00Z",
  "completedAt": "2026-02-03T10:00:47Z"
}
```

#### channel_request_logsï¼ˆé€šé“è¯·æ±‚æ—¥å¿—ï¼‰

```javascript
{
  "_id": "log_001",
  "channelType": "email",
  "taskId": "task_20260203_001",
  "senderIdentifier": "zhangsan@company.com",
  "mappedUserId": "user_001",
  "intent": "image-gen",
  "targetAgent": "visual-agent",
  "status": "completed",
  "durationMs": 42000,
  "tokensUsed": {
    "input": 150,
    "output": 50
  },
  "createdAt": "2026-02-03T10:00:00Z"
}
```

### 4.2 ç´¢å¼•è®¾è®¡

```javascript
// channel_whitelist
db.channel_whitelist.createIndex({ "channelType": 1, "identifierPattern": 1 });
db.channel_whitelist.createIndex({ "isActive": 1 });

// channel_identity_mappings
db.channel_identity_mappings.createIndex({ "channelType": 1, "channelIdentifier": 1 }, { unique: true });
db.channel_identity_mappings.createIndex({ "userId": 1 });

// channel_tasks
db.channel_tasks.createIndex({ "channelType": 1, "senderIdentifier": 1 });
db.channel_tasks.createIndex({ "status": 1, "createdAt": -1 });
db.channel_tasks.createIndex({ "mappedUserId": 1, "createdAt": -1 });
db.channel_tasks.createIndex({ "createdAt": 1 }, { expireAfterSeconds: 2592000 }); // 30å¤©TTL

// channel_request_logs
db.channel_request_logs.createIndex({ "channelType": 1, "createdAt": -1 });
db.channel_request_logs.createIndex({ "mappedUserId": 1, "createdAt": -1 });
db.channel_request_logs.createIndex({ "createdAt": 1 }, { expireAfterSeconds: 2592000 }); // 30å¤©TTL
```

---

## 5. ç®¡ç†åå°åŠŸèƒ½

### 5.1 é€šé“ç®¡ç†é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šé“ç®¡ç†                                                    [+ æ·»åŠ ç™½åå•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€ é€šé“çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  ğŸ“§ é‚®ä»¶é€šé“        âœ… å·²å¯ç”¨     ä»Šæ—¥: 156 è¯·æ±‚                        â”‚ â”‚
â”‚  â”‚  ğŸ“± çŸ­ä¿¡é€šé“        â¸ï¸ æœªé…ç½®     -                                     â”‚ â”‚
â”‚  â”‚  ğŸ™ï¸ Sirié€šé“        â¸ï¸ æœªé…ç½®     -                                     â”‚ â”‚
â”‚  â”‚  ğŸ”— Webhooké€šé“     â¸ï¸ æœªé…ç½®     -                                     â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€ é‚®ä»¶ç™½åå• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  æ¨¡å¼                    ç»‘å®šç”¨æˆ·      å…è®¸Agent      æ¯æ—¥é™é¢   çŠ¶æ€  â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  *@company.com          -            å…¨éƒ¨           100      âœ…      â”‚ â”‚
â”‚  â”‚  zhangsan@gmail.com     å¼ ä¸‰         visual-agent   50       âœ…      â”‚ â”‚
â”‚  â”‚  test@test.com          -            prd-agent      10       â¸ï¸      â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç™½åå•é…ç½®å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ·»åŠ é‚®ä»¶ç™½åå•                                      [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  é€šé“ç±»å‹        [ğŸ“§ é‚®ä»¶ â–¼]                                 â”‚
â”‚                                                              â”‚
â”‚  èº«ä»½æ¨¡å¼        [*@company.com                    ]         â”‚
â”‚                  æ”¯æŒé€šé…ç¬¦ * ï¼Œå¦‚ *@company.com              â”‚
â”‚                                                              â”‚
â”‚  ç»‘å®šç”¨æˆ·        [é€‰æ‹©ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰          â–¼]               â”‚
â”‚                  ç»‘å®šåæ‰€æœ‰è¯·æ±‚ä»¥è¯¥ç”¨æˆ·èº«ä»½æ‰§è¡Œ               â”‚
â”‚                                                              â”‚
â”‚  å…è®¸çš„ Agent    [â˜‘ visual-agent] [â˜‘ prd-agent]             â”‚
â”‚                  [â˜ defect-agent] [â˜ literary-agent]        â”‚
â”‚                                                              â”‚
â”‚  æ¯æ—¥é™é¢        [100                              ] æ¬¡      â”‚
â”‚                  0 = ä¸é™åˆ¶                                  â”‚
â”‚                                                              â”‚
â”‚  å¤‡æ³¨            [å…¬å¸å‘˜å·¥é‚®ç®±                      ]         â”‚
â”‚                                                              â”‚
â”‚                              [å–æ¶ˆ]  [ç¡®å®š]                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ä»»åŠ¡ç›‘æ§é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šé“ä»»åŠ¡ç›‘æ§                      [é€šé“: å…¨éƒ¨ â–¼] [çŠ¶æ€: å…¨éƒ¨ â–¼] [ğŸ” æœç´¢]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ä»»åŠ¡ID              å‘é€è€…                Agent          çŠ¶æ€    åˆ›å»ºæ—¶é—´  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  TASK-...-001       ğŸ“§ zhang@co.com      visual-agent   âœ…å®Œæˆ   10:00:47  â”‚
â”‚  TASK-...-002       ğŸ“§ li@company.com    prd-agent      ğŸ”„å¤„ç†ä¸­  10:01:23  â”‚
â”‚  TASK-...-003       ğŸ“§ test@test.com     defect-agent   âŒå¤±è´¥   10:02:05  â”‚
â”‚                                                                              â”‚
â”‚  [< ä¸Šä¸€é¡µ]                    ç¬¬ 1 é¡µ / å…± 10 é¡µ               [ä¸‹ä¸€é¡µ >]  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. API æ¥å£è®¾è®¡

### 6.1 ç®¡ç†æ¥å£

**åŸºç¡€è·¯å¾„**ï¼š`/api/admin/channels`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/whitelist` | è·å–ç™½åå•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ |
| POST | `/whitelist` | åˆ›å»ºç™½åå•è§„åˆ™ |
| PUT | `/whitelist/{id}` | æ›´æ–°ç™½åå•è§„åˆ™ |
| DELETE | `/whitelist/{id}` | åˆ é™¤ç™½åå•è§„åˆ™ |
| POST | `/whitelist/{id}/toggle` | å¯ç”¨/ç¦ç”¨ç™½åå•è§„åˆ™ |
| GET | `/identity-mappings` | è·å–èº«ä»½æ˜ å°„åˆ—è¡¨ |
| POST | `/identity-mappings` | åˆ›å»ºèº«ä»½æ˜ å°„ |
| DELETE | `/identity-mappings/{id}` | åˆ é™¤èº«ä»½æ˜ å°„ |
| GET | `/tasks` | è·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ |
| GET | `/tasks/{id}` | è·å–ä»»åŠ¡è¯¦æƒ… |
| POST | `/tasks/{id}/retry` | é‡è¯•å¤±è´¥ä»»åŠ¡ |
| POST | `/tasks/{id}/cancel` | å–æ¶ˆä»»åŠ¡ |
| GET | `/stats` | è·å–é€šé“ç»Ÿè®¡ |

### 6.2 Webhook æ¥å£

**åŸºç¡€è·¯å¾„**ï¼š`/api/channels`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/email/inbound` | æ¥æ”¶é‚®ä»¶ Webhook |
| POST | `/email/status` | æ¥æ”¶é‚®ä»¶å‘é€çŠ¶æ€å›è°ƒ |
| POST | `/sms/inbound` | æ¥æ”¶çŸ­ä¿¡ Webhookï¼ˆé¢„ç•™ï¼‰ |
| POST | `/webhook/{appId}` | é€šç”¨ Webhook å…¥å£ï¼ˆé¢„ç•™ï¼‰ |

---

## 7. å®‰å…¨è®¾è®¡

### 7.1 ç™½åå•éªŒè¯æµç¨‹

```
æ”¶åˆ°å…¥ç«™æ¶ˆæ¯
      â”‚
      â–¼
æå–å‘é€è€…èº«ä»½æ ‡è¯†
      â”‚
      â–¼
éå†ç™½åå•è§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
      â”‚
      â”œâ”€ ç²¾ç¡®åŒ¹é…ï¼ˆzhangsan@company.comï¼‰
      â”œâ”€ åŸŸåé€šé…ï¼ˆ*@company.comï¼‰
      â””â”€ å…¨å±€é€šé…ï¼ˆ*ï¼‰
      â”‚
      â–¼
åŒ¹é…æˆåŠŸ? â”€â”€â”€ å¦ â”€â”€â–¶ è®°å½•æ—¥å¿—ï¼Œé™é»˜ä¸¢å¼ƒï¼ˆä¸å›å¤ï¼‰
      â”‚
      â”‚ æ˜¯
      â–¼
æ£€æŸ¥è§„åˆ™æ˜¯å¦å¯ç”¨
      â”‚
      â–¼
æ£€æŸ¥æ¯æ—¥é…é¢
      â”‚
      â–¼
æ£€æŸ¥å…è®¸çš„ Agent
      â”‚
      â–¼
é€šè¿‡ â”€â”€â–¶ ç»§ç»­å¤„ç†
```

### 7.2 é˜²æ»¥ç”¨æªæ–½

| æªæ–½ | è¯´æ˜ |
|------|------|
| **ç™½åå•æœºåˆ¶** | åªå¤„ç†ç™½åå•å†…çš„å‘é€è€… |
| **æ¯æ—¥é…é¢** | é™åˆ¶å•ä¸ªå‘é€è€…æ¯æ—¥è¯·æ±‚æ•° |
| **é™é»˜ä¸¢å¼ƒ** | æœªæˆæƒè¯·æ±‚ä¸å›å¤ï¼Œé¿å…æš´éœ²ç³»ç»Ÿå­˜åœ¨ |
| **å†…å®¹å®‰å…¨** | è°ƒç”¨ Agent å‰è¿›è¡Œå†…å®¹å®‰å…¨æ£€æµ‹ |
| **é™„ä»¶å¤§å°é™åˆ¶** | é™åˆ¶é™„ä»¶æ€»å¤§å°ï¼ˆé»˜è®¤ 10MBï¼‰ |
| **è¯·æ±‚é¢‘ç‡é™åˆ¶** | åŒä¸€å‘é€è€…çŸ­æ—¶é—´å†…è¯·æ±‚è¿‡å¤šæ—¶é™æµ |

### 7.3 Webhook å®‰å…¨

| æªæ–½ | è¯´æ˜ |
|------|------|
| **ç­¾åéªŒè¯** | éªŒè¯é‚®ä»¶æœåŠ¡å•†çš„ Webhook ç­¾å |
| **IP ç™½åå•** | ä»…å…è®¸é‚®ä»¶æœåŠ¡å•† IP è®¿é—® Webhook ç«¯ç‚¹ |
| **HTTPS å¼ºåˆ¶** | Webhook ç«¯ç‚¹ä»…æ”¯æŒ HTTPS |
| **å¹‚ç­‰å¤„ç†** | ç›¸åŒ MessageId çš„è¯·æ±‚åªå¤„ç†ä¸€æ¬¡ |

---

## 8. é…ç½®é¡¹

### 8.1 appsettings.json

```json
{
  "Channels": {
    "Email": {
      "Enabled": true,
      "InboundAddress": "agent@prdagent.com",
      "Provider": "SendGrid",
      "SendGrid": {
        "ApiKey": "SG.xxx",
        "WebhookSigningKey": "xxx",
        "AllowedIps": ["167.89.0.0/17"]
      },
      "DefaultDailyQuota": 100,
      "MaxAttachmentSizeMb": 10,
      "ResponseTemplates": {
        "TaskReceived": "templates/email-task-received.html",
        "TaskCompleted": "templates/email-task-completed.html",
        "TaskFailed": "templates/email-task-failed.html"
      }
    },
    "Sms": {
      "Enabled": false
    },
    "Siri": {
      "Enabled": false
    }
  }
}
```

---

## 9. å®æ–½è®¡åˆ’

### 9.1 é˜¶æ®µä¸€ï¼šé‚®ä»¶é€šé“ MVPï¼ˆ2-3 å‘¨ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| é€šé“é€‚é…å™¨æ¥å£å®šä¹‰ | P0 | IChannelAdapter, IInboundChannelAdapter, IOutboundChannelAdapter |
| é‚®ä»¶å…¥ç«™é€‚é…å™¨ | P0 | SendGrid Inbound Parse é›†æˆ |
| é‚®ä»¶å‡ºç«™é€‚é…å™¨ | P0 | SendGrid å‘é€é›†æˆ |
| ç™½åå•éªŒè¯æœåŠ¡ | P0 | ç™½åå•åŒ¹é…ã€é…é¢æ£€æŸ¥ |
| æ„å›¾è¯†åˆ«æœåŠ¡ | P0 | å‰ç¼€è§£æ + LLM æ„å›¾è¯†åˆ« |
| ä»»åŠ¡è°ƒåº¦æœåŠ¡ | P0 | ä»»åŠ¡åˆ›å»ºã€çŠ¶æ€ç®¡ç† |
| ç®¡ç†åå° - ç™½åå•ç®¡ç† | P1 | CRUD + å¯ç”¨/ç¦ç”¨ |
| ç®¡ç†åå° - ä»»åŠ¡ç›‘æ§ | P1 | ä»»åŠ¡åˆ—è¡¨ã€è¯¦æƒ…ã€é‡è¯• |

### 9.2 é˜¶æ®µäºŒï¼šå¢å¼ºåŠŸèƒ½ï¼ˆ2 å‘¨ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| é‚®ä»¶çº¿ç¨‹è¿½è¸ª | P1 | æ”¯æŒå›å¤é‚®ä»¶ç»§ç»­å¯¹è¯ |
| é™„ä»¶å¤„ç†å¢å¼º | P1 | å›¾ç‰‡è¯†åˆ«ã€æ–‡æ¡£è§£æ |
| èº«ä»½æ˜ å°„ç®¡ç† | P1 | é‚®ç®±ç»‘å®šåˆ°ç³»ç»Ÿç”¨æˆ· |
| é‚®ä»¶æ¨¡æ¿ç¼–è¾‘ | P2 | å¯è§†åŒ–ç¼–è¾‘å“åº”æ¨¡æ¿ |
| ç»Ÿè®¡æŠ¥è¡¨ | P2 | é€šé“ä½¿ç”¨é‡ç»Ÿè®¡ |

### 9.3 é˜¶æ®µä¸‰ï¼šæ‰©å±•é€šé“ï¼ˆæŒ‰éœ€ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| çŸ­ä¿¡é€šé“ | P2 | Twilio/é˜¿é‡Œäº‘çŸ­ä¿¡é›†æˆ |
| Siri å¿«æ·æŒ‡ä»¤ | P2 | iOS Shortcuts é›†æˆ |
| Webhook é€šç”¨å…¥å£ | P2 | æ”¯æŒè‡ªå®šä¹‰ Webhook |

---

## 10. é™„å½•

### 10.1 appKey å®šä¹‰

æ ¹æ® CLAUDE.md åº”ç”¨èº«ä»½éš”ç¦»åŸåˆ™ï¼Œé€šé“é€‚é…å™¨æ¨¡å—ä½¿ç”¨ä»¥ä¸‹ appKeyï¼š

| appKey | è¯´æ˜ |
|--------|------|
| `channel-gateway` | å¤šé€šé“ç½‘å…³ï¼ˆç»Ÿä¸€å…¥å£ï¼‰ |

### 10.2 AppCallerCode å®šä¹‰

| AppCallerCode | è¯´æ˜ |
|---------------|------|
| `channel.email::intent` | é‚®ä»¶æ„å›¾è¯†åˆ« |
| `channel.email::content-safety` | é‚®ä»¶å†…å®¹å®‰å…¨æ£€æµ‹ |
| `channel.sms::intent` | çŸ­ä¿¡æ„å›¾è¯†åˆ«ï¼ˆé¢„ç•™ï¼‰ |

### 10.3 ç›¸å…³æ–‡æ¡£

- [å¼€æ”¾å¹³å°è®¾è®¡](./design.open-platform.md)
- [LLM Gateway ä½¿ç”¨æŒ‡å—](../CLAUDE.md#llm-gateway-ç»Ÿä¸€è°ƒç”¨è§„åˆ™)
- [åº”ç”¨èº«ä»½éš”ç¦»åŸåˆ™](../CLAUDE.md#åº”ç”¨èº«ä»½éš”ç¦»åŸåˆ™)

---

## å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| v1.0 | 2026-02-03 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«é‚®ä»¶é€šé“è¯¦ç»†è®¾è®¡ | - |
