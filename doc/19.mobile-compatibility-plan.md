# 19. 移动端兼容性规划

> **创建日期**：2025-01-23
> **状态**：规划阶段
> **优先级**：中期战略

---

## 一、现状分析

### 1.1 当前技术栈移动端就绪度

| 技术 | 用途 | 移动端兼容 | 说明 |
|------|------|:----------:|------|
| Tailwind CSS v4 | 样式系统 | ✅ | 框架本身支持响应式，但项目中**零使用**断点修饰符 |
| Radix UI | 无头组件 | ⚠️ | 支持移动端但需要 Sheet/Drawer 变体 |
| React 18 | UI 框架 | ✅ | 完全兼容 |
| Zustand | 状态管理 | ✅ | 框架无关 |
| React Router v7 | 路由 | ✅ | 完全兼容 |
| Three.js | 3D 可视化 | ❌ | 移动端 WebGL 性能差 |
| Tauri 2.0 | 桌面客户端 | ❌ | 仅桌面平台 |
| .NET 8 API | 后端 | ✅ | API 与前端解耦，无需改动 |

### 1.2 当前阻塞项

| 阻塞项 | 严重程度 | 说明 |
|--------|:--------:|------|
| 零响应式断点 | 🔴 高 | 未使用任何 `sm:` `md:` `lg:` 修饰符 |
| 固定侧边栏布局 | 🔴 高 | AppShell 假设 ≥1200px 宽度 |
| 仅 hover 交互 | 🔴 高 | 无触摸替代方案 |
| 小尺寸控件 | 🟡 中 | 按钮/标签 28px 高度 < 44px 触摸目标最低要求 |
| 高性能 CSS 特效 | 🟡 中 | backdrop-filter blur 40-60px 移动端卡顿 |
| 小字体 | 🟡 中 | 10-12px 文字在小屏幕上不可读 |
| 无 PWA 配置 | 🟠 低 | 无 manifest / Service Worker |

---

## 二、移动端策略选型

### 方案对比

| 方案 | 开发成本 | 用户体验 | 维护成本 | 适用场景 |
|------|:--------:|:--------:|:--------:|----------|
| **A. 响应式改造** | 中 | ⭐⭐⭐ | 低 | 内部管理工具 |
| **B. 独立移动 Web 应用** | 高 | ⭐⭐⭐⭐ | 中 | 面向用户的产品 |
| **C. React Native / Flutter** | 很高 | ⭐⭐⭐⭐⭐ | 高 | 高交互原生体验 |
| **D. 渐进式 (PWA + 响应式)** | 中高 | ⭐⭐⭐⭐ | 中低 | 兼顾离线与安装 |

### 推荐方案：D. 渐进式 (PWA + 响应式)

**理由**：
1. 复用现有 React + Tailwind 代码库，改造成本可控
2. PWA 可安装到手机主屏，体验接近原生
3. Service Worker 支持离线缓存和推送通知
4. 一套代码适配桌面/平板/手机多端
5. 不需要应用商店审核发布流程

---

## 三、实施阶段规划

### Phase 0：基础设施准备（预计 1-2 周）

#### 0.1 响应式断点体系

```css
/* 基于 Tailwind CSS v4 默认断点 */
--breakpoint-sm: 640px;   /* 手机横屏 / 大屏手机 */
--breakpoint-md: 768px;   /* 平板竖屏 */
--breakpoint-lg: 1024px;  /* 平板横屏 / 小笔记本 */
--breakpoint-xl: 1280px;  /* 桌面 */
--breakpoint-2xl: 1536px; /* 大屏桌面 */
```

#### 0.2 Design Token 移动端扩展

```css
/* tokens.css 新增 */
:root {
  --touch-target-min: 44px;      /* Apple HIG 最低触摸目标 */
  --font-size-mobile-body: 16px; /* 移动端正文字号 */
  --spacing-safe-bottom: env(safe-area-inset-bottom); /* 刘海屏适配 */
}
```

#### 0.3 需要创建的基础文件

| 文件 | 用途 |
|------|------|
| `prd-admin/public/manifest.json` | PWA 应用清单 |
| `prd-admin/public/sw.js` | Service Worker |
| `prd-admin/src/hooks/useMediaQuery.ts` | 响应式断点 Hook |
| `prd-admin/src/hooks/useTouchDevice.ts` | 触摸设备检测 |
| `prd-admin/src/components/mobile/MobileNav.tsx` | 移动端导航抽屉 |
| `prd-admin/src/components/mobile/BottomSheet.tsx` | 底部弹出面板 |

---

### Phase 1：核心布局响应式改造（预计 2-3 周）

#### 1.1 AppShell 改造

**当前问题**：固定侧边栏 + 固定 padding-left

**改造方案**：

```
桌面端 (≥1024px):     平板端 (768-1023px):    手机端 (<768px):
┌──┬──────────┐      ┌──┬──────────┐       ┌──────────┐
│侧│           │      │侧│           │       │  顶部栏   │
│边│  主内容   │      │边│  主内容   │       ├──────────┤
│栏│           │      │栏│           │       │          │
│  │           │      │折│           │       │  主内容   │
│  │           │      │叠│           │       │          │
└──┴──────────┘      └──┴──────────┘       ├──────────┤
                                            │ 底部导航  │
                                            └──────────┘
```

**关键改动**：
- `< 768px`：侧边栏转为抽屉式 (Drawer)，点击汉堡菜单打开
- `768-1023px`：侧边栏默认折叠为图标模式 (72px)
- `≥ 1024px`：保持当前布局

#### 1.2 导航系统改造

| 屏幕尺寸 | 导航形态 | 交互方式 |
|----------|----------|----------|
| 手机 (<768px) | 底部 Tab Bar (4-5个核心入口) + 抽屉菜单 | 触摸 + 滑动手势 |
| 平板 (768-1023px) | 折叠侧边栏 (图标) | 触摸 + 展开 |
| 桌面 (≥1024px) | 完整侧边栏 | 鼠标 hover + 点击 |

#### 1.3 触摸交互适配

```typescript
// 替换所有 hover-only 交互
// Before:
<div className="opacity-0 group-hover:opacity-100">Actions</div>

// After:
<div className="opacity-0 group-hover:opacity-100
               touch:opacity-100">Actions</div>

// 或使用 @media (hover: hover) 检测
```

**核心改动清单**：
- [ ] 所有可点击元素最小尺寸 44×44px
- [ ] hover 交互添加 touch/active 替代
- [ ] 右键菜单转为长按菜单
- [ ] 拖拽操作提供替代操作方式
- [ ] 表单输入添加 `inputmode` 属性

---

### Phase 2：页面级适配（预计 3-4 周）

按使用频率和复杂度排序：

#### 优先级 P0 - 核心页面

| 页面 | 改造要点 |
|------|----------|
| **对话/Chat** | 消息列表全宽、输入框贴底固定、长按菜单 |
| **PRD 阅读** | Markdown 阅读视图优化、字号适配、图片响应式 |
| **登录/认证** | 全屏表单、大按钮、生物识别入口 |

#### 优先级 P1 - 重要页面

| 页面 | 改造要点 |
|------|----------|
| **会话列表** | 卡片列表布局、下拉刷新、滑动操作 |
| **模型选择** | 底部弹出选择器代替下拉框 |
| **设置** | 分组列表式布局 |

#### 优先级 P2 - 管理页面

| 页面 | 改造要点 |
|------|----------|
| **数据表格类** | 卡片视图代替表格、横向滚动备选 |
| **权限管理** | 树形折叠 + 标签式权限 |
| **水印配置** | 图片上传适配、预览缩放 |

#### 优先级 P3 - 可降级页面

| 页面 | 策略 |
|------|------|
| **视觉创作画布** | 仅展示提示"请使用桌面端" |
| **3D 可视化** | 降级为 2D 图表或静态图 |
| **代码编辑器** | 只读模式，编辑引导到桌面 |

---

### Phase 3：PWA 能力建设（预计 1-2 周）

#### 3.1 Web App Manifest

```json
{
  "name": "PRD Agent",
  "short_name": "PRD",
  "description": "PRD 智能解读与问答助手",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#0a0a0c",
  "theme_color": "#0a0a0c",
  "orientation": "any",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" },
    { "src": "/icons/icon-maskable-512.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
  ]
}
```

#### 3.2 Service Worker 策略

| 资源类型 | 缓存策略 | 说明 |
|----------|----------|------|
| 静态资源 (JS/CSS/图片) | Cache First | 版本更新后刷新 |
| API 请求 | Network First | 离线时展示缓存数据 |
| SSE 流 | Network Only | 实时对话不缓存 |
| 字体文件 | Cache First | 长期缓存 |

#### 3.3 离线功能范围

| 功能 | 离线可用 | 说明 |
|------|:--------:|------|
| 查看历史对话 | ✅ | IndexedDB 缓存 |
| 查看 PRD 文档 | ✅ | 本地缓存已解析的 PRD |
| 发起新对话 | ❌ | 需要 LLM API |
| 图片生成 | ❌ | 需要后端服务 |
| 用户设置 | ✅ | localStorage |

---

### Phase 4：性能优化（预计 1-2 周）

#### 4.1 移动端性能关键项

| 优化项 | 方案 | 影响 |
|--------|------|------|
| backdrop-filter | 移动端降级为纯色半透明 | 减少 GPU 占用 50%+ |
| Three.js | 条件加载，移动端不初始化 | 减少 JS 包体积 ~500KB |
| 图片 | `<picture>` + srcset 响应式图片 | 减少流量消耗 |
| 字体 | `font-display: swap` + 子集化 | 首屏渲染加速 |
| 动画 | `prefers-reduced-motion` 降级 | 已部分实现 |
| 代码分割 | 按路由 lazy loading | 首屏 JS 减少 60%+ |

#### 4.2 移动端 CSS 性能降级

```css
@media (max-width: 768px) {
  .glass-card {
    /* 移动端降级：纯色代替毛玻璃 */
    backdrop-filter: none;
    background: rgba(20, 20, 24, 0.95);
  }

  .animation-heavy {
    /* 减少动画复杂度 */
    animation: none;
    transition: opacity 0.15s ease;
  }
}
```

---

### Phase 5：Tauri Mobile 探索（中长期）

#### 5.1 Tauri 2.0 移动端支持

Tauri 2.0 已支持 iOS 和 Android 构建：

```toml
# src-tauri/Cargo.toml 新增
[target.'cfg(target_os = "android")'.dependencies]
# Android 特定依赖

[target.'cfg(target_os = "ios")'.dependencies]
# iOS 特定依赖
```

#### 5.2 移动端 Tauri 需要解决的问题

| 问题 | 方案 |
|------|------|
| 窗口尺寸约束 (800×600) | 移除最小尺寸或按平台条件设置 |
| 文件系统访问 | 使用平台沙盒 API |
| 自动更新 | iOS/Android 各自应用商店机制 |
| 推送通知 | FCM (Android) / APNs (iOS) |
| 原生导航 | WebView + 原生导航栏混合 |

#### 5.3 评估建议

> **短期**（0-6个月）：优先 PWA 方案，成本低见效快
> **中期**（6-12个月）：若 PWA 体验不满足需求，启动 Tauri Mobile 方案
> **长期**（12+个月）：根据用户反馈决定是否需要原生 App

---

## 四、后端 API 适配

### 4.1 需要新增/修改的 API

| API | 类型 | 说明 |
|-----|------|------|
| `GET /api/v1/health/ping` | 新增 | 轻量心跳，PWA 用于检测在线状态 |
| `POST /api/v1/push/subscribe` | 新增 | Web Push 订阅注册 |
| `GET /api/v1/sessions?page&limit` | 修改 | 添加分页支持（移动端分批加载） |
| `GET /api/v1/messages?afterSeq&limit` | 已有 | SSE 重连机制已适合移动端弱网 |

### 4.2 移动端特殊考虑

| 考虑项 | 方案 |
|--------|------|
| 弱网环境 | 请求重试 + 指数退避（已有 SSE afterSeq 机制） |
| 数据压缩 | 启用 Brotli/Gzip 压缩 |
| 图片压缩 | 增加 `?quality=` `?width=` 参数 |
| 会话保持 | Token 刷新机制 + 后台恢复 |

---

## 五、移动端测试策略

### 5.1 设备覆盖矩阵

| 类别 | 设备 / 分辨率 | 优先级 |
|------|---------------|:------:|
| iOS 手机 | iPhone 14/15 (390×844) | P0 |
| Android 手机 | Pixel 7 (412×915) | P0 |
| iOS 平板 | iPad Air (820×1180) | P1 |
| Android 平板 | Samsung Tab S9 (800×1280) | P1 |
| 折叠屏 | Galaxy Fold (280→717px) | P2 |

### 5.2 测试维度

- [ ] 响应式布局断点切换
- [ ] 触摸交互（点击、滑动、长按、双指缩放）
- [ ] 虚拟键盘弹出时的布局适配
- [ ] 安全区域（刘海屏、底部指示条）
- [ ] 横竖屏切换
- [ ] PWA 安装与启动
- [ ] 离线/弱网场景
- [ ] 系统深色/浅色模式
- [ ] 性能（首屏加载 < 3s，交互响应 < 100ms）

---

## 六、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 改造影响桌面端稳定性 | 高 | 移动端样式用断点隔离，桌面端不变 |
| Three.js 移动端性能 | 中 | 条件加载 + 功能降级提示 |
| iOS Safari 兼容性 | 中 | 重点测试 WebKit 特殊行为 |
| PWA iOS 限制 | 中 | iOS 不支持 Web Push（需接受限制） |
| 复杂表格移动端可读性 | 低 | 卡片视图 + 横向滚动 |

---

## 七、里程碑时间线

```
Phase 0 ──── Phase 1 ──── Phase 2 ──── Phase 3 ──── Phase 4 ──── Phase 5
基础设施      核心布局      页面适配      PWA能力       性能优化      Tauri Mobile
(1-2周)      (2-3周)      (3-4周)      (1-2周)      (1-2周)      (中长期评估)
   │            │            │            │            │             │
   ├─ Token     ├─ AppShell  ├─ Chat页面  ├─ Manifest  ├─ 毛玻璃降级 ├─ iOS 构建
   ├─ Hook      ├─ 导航系统  ├─ PRD阅读   ├─ SW缓存    ├─ 代码分割   ├─ Android 构建
   ├─ PWA清单   ├─ 触摸适配  ├─ 会话列表  ├─ 离线支持  ├─ 图片优化   ├─ 原生集成
   └─ 工具链    └─ 断点系统  └─ 管理页面  └─ Push通知  └─ 包体优化   └─ 发布流程
```

---

## 八、决策记录

| 决策 | 选择 | 理由 |
|------|------|------|
| 移动端策略 | PWA + 响应式优先 | 复用代码、成本可控、无商店审核 |
| 最低支持版本 | iOS 15+ / Android 10+ | 覆盖 95%+ 活跃设备 |
| CSS 方案 | Tailwind 断点 (Mobile First) | 现有基础设施，学习成本低 |
| 导航模式 | 底部 Tab + 抽屉 | 符合移动端操作习惯 |
| 复杂功能策略 | 优雅降级 | 视觉画布等功能引导到桌面端 |
| 离线策略 | 有限离线（只读） | 核心功能依赖 LLM API |

---

## 九、开始行动前的前置确认

在启动 Phase 0 之前，需要确认：

1. **目标用户群**：移动端面向全部用户还是仅管理员？
2. **优先设备**：iOS 优先还是 Android 优先？
3. **最小可用功能**：移动端第一版需要哪些核心功能？
4. **是否需要原生能力**：相机、文件系统、生物识别等？
5. **性能预算**：首屏加载时间 / JS 包体积上限？
6. **是否接受功能降级**：视觉画布等复杂功能是否可以不支持移动端？
