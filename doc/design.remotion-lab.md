# Remotion 视频实验室

> 用 React 代码创建视频，用自然语言生成动画。

---

## 产品定位

**一句话描述**：在浏览器中实时预览和创作 Remotion 视频动画，支持 AI 生成。

**目标用户**：
- 开发人员：快速原型设计视频效果
- 设计师：探索动画创意，无需编写代码
- 内容创作者：生成短视频素材

**核心价值**：
1. **即时预览**：参数调整实时反映到视频
2. **AI 驱动**：用自然语言描述，自动生成动画代码
3. **学习工具**：通过示例学习 Remotion 框架

---

## 一、功能架构

### 模式划分

```
┌─────────────────────────────────────────────────────────────────┐
│                     Remotion 视频实验室                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────┐    ┌─────────────────────────────┐   │
│   │    预设模板模式      │    │       AI 生成模式           │   │
│   │   (Templates)       │    │      (AI Generator)         │   │
│   ├─────────────────────┤    ├─────────────────────────────┤   │
│   │ • 文字揭示          │    │ • 自然语言输入              │   │
│   │ • Logo 动画         │    │ • LLM 代码生成              │   │
│   │ • 粒子波浪          │    │ • 浏览器内编译              │   │
│   │ • 参数化控制        │    │ • 动态组件渲染              │   │
│   └─────────────────────┘    └─────────────────────────────┘   │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                  Remotion Player                        │   │
│   │            (实时预览 + 播放控制)                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 技术流程

```
                    预设模板模式
                    ────────────
用户选择模板 → 调节参数 → Remotion Player 渲染
                 │
                 ▼
              实时预览


                    AI 生成模式
                    ────────────
用户输入描述
     │
     ▼
┌─────────────────┐
│ LLM Gateway     │  ← System Prompt (Remotion 最佳实践)
│ runModelLabStream│
└────────┬────────┘
         │ SSE 流式响应
         ▼
┌─────────────────┐
│ 代码清理        │  ← 移除 markdown 标记
│ extractCode()   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Babel Standalone│  ← 浏览器内编译 JSX/TSX
│ transform()     │
└────────┬────────┘
         │ React 组件
         ▼
┌─────────────────┐
│ 依赖注入        │  ← React, Remotion APIs
│ new Function()  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Remotion Player │  ← 动态渲染
└─────────────────┘
```

---

## 二、预设模板

### 模板列表

| 模板名称 | 效果描述 | 可配置参数 |
|----------|----------|------------|
| **文字揭示** | 逐词弹出动画 | 文字内容、颜色、背景色、字号 |
| **Logo 动画** | 旋转光环 + 文字淡入 | Logo 文字、主色、副色、背景色 |
| **粒子波浪** | 流动的粒子效果 | 粒子颜色、背景色、粒子数量、波浪速度 |
| **Matrix 代码雨** | 黑客帝国风格代码雨 | 字符颜色、背景色、列数、速度 |
| **故障文字** | Glitch 故障风格特效 | 文字内容、文字颜色、背景色、故障强度 |
| **打字机** | 终端风格逐字打印 | 文字内容、文字颜色、背景色、打字速度 |
| **柱状图** | 动态数据图表动画 | 标题、柱子颜色、背景色、文字颜色 |

### 模板规范

每个模板需遵循以下结构：

```typescript
// 1. 配置导出
export const templateDefaults = {
  text: 'Hello World',
  color: '#ffffff',
  backgroundColor: '#0f172a',
};

// 2. Props 类型
export interface TemplateProps {
  text?: string;
  color?: string;
  backgroundColor?: string;
}

// 3. 组件导出
export function Template({
  text = templateDefaults.text,
  ...
}: TemplateProps) {
  const frame = useCurrentFrame();
  const { fps } = useVideoConfig();

  // 动画逻辑
  return (
    <AbsoluteFill style={{ backgroundColor }}>
      {/* 内容 */}
    </AbsoluteFill>
  );
}
```

---

## 三、AI 生成模式

### 设计理念

**"描述效果，生成代码"**

用户无需了解 Remotion API，只需用自然语言描述想要的视觉效果，AI 自动生成可运行的 React 组件代码。

### System Prompt 设计

AI 生成的代码需遵循以下约束：

1. **无外部依赖**：只能使用 React + Remotion 核心 API
2. **Constants-first**：可配置参数放在文件顶部
3. **默认导出**：组件必须是 `export default function`
4. **内联样式**：不使用 CSS 文件

### 支持的 Remotion API

| API | 用途 |
|-----|------|
| `useCurrentFrame()` | 获取当前帧号 |
| `useVideoConfig()` | 获取视频配置 (fps, width, height, durationInFrames) |
| `interpolate()` | 线性插值动画 |
| `spring()` | 弹簧物理动画 |
| `Sequence` | 时序控制 |
| `AbsoluteFill` | 绝对定位容器 |

### 示例 Prompts

| 示例 | 预期效果 |
|------|----------|
| "创建一个 Matrix 风格的绿色代码雨效果" | 字符从上往下飘落 |
| "创建一个 Glitch 故障风格的文字效果" | 抖动 + 颜色偏移 |
| "创建一个呼吸灯效果的圆形光环" | 脉冲 + 颜色渐变 |
| "创建一个文字逐个字母弹跳出现的动画" | 弹簧物理效果 |
| "创建一个从中心向外爆炸的彩色粒子效果" | 粒子扩散 |
| "创建一个圆形进度条动画，从 0% 到 100%" | SVG 圆弧 + 数字 |

### 错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| Babel 编译失败 | 显示错误信息，提供"重试编译"按钮 |
| 组件运行时错误 | 显示占位符，不崩溃页面 |
| LLM 超时 | 显示超时提示，允许重新生成 |
| 不支持的依赖 | 提示用户修改描述 |

---

## 四、技术实现

### 文件结构

```
prd-admin/src/pages/lab-remotion/
├── RemotionLabTab.tsx              # 主页面（模式切换）
├── components/
│   ├── AiGeneratorPanel.tsx        # AI 生成面板
│   └── CodeEditor.tsx              # Monaco 代码编辑器
├── templates/
│   ├── index.ts                    # 模板导出
│   ├── TextReveal.tsx              # 文字揭示
│   ├── LogoAnimation.tsx           # Logo 动画
│   ├── ParticleWave.tsx            # 粒子波浪
│   ├── MatrixRain.tsx              # Matrix 代码雨
│   ├── GlitchText.tsx              # 故障文字
│   ├── Typewriter.tsx              # 打字机效果
│   └── BarChart.tsx                # 柱状图动画
└── lib/
    ├── babel-standalone.d.ts       # 类型声明
    ├── dynamicCompiler.ts          # 动态编译器
    └── remotionPrompt.ts           # LLM System Prompt
```

### 依赖项

| 包名 | 版本 | 用途 |
|------|------|------|
| `remotion` | ^4.0 | 核心框架 |
| `@remotion/player` | ^4.0 | 浏览器预览播放器 |
| `@babel/standalone` | ^7.29 | 浏览器内 JSX 编译 |
| `@monaco-editor/react` | ^4.7 | 代码编辑器 |

### 视频配置

```typescript
const VIDEO_CONFIG = {
  fps: 30,              // 帧率
  durationInFrames: 90, // 总帧数 (3秒)
  width: 1280,          // 宽度
  height: 720,          // 高度
};
```

---

## 五、访问路径

| 路由 | 页面 | 权限 |
|------|------|------|
| `/lab?tab=remotion` | 视频实验室 | `lab.read` |

---

## 六、已知局限

| 局限 | 说明 | 未来可能方案 |
|------|------|--------------|
| 无外部依赖 | 不支持 Three.js、Lottie 等 | 预置常用库到作用域 |
| 仅限预览 | 不支持导出 MP4 | 后端集成 FFmpeg |
| LLM 质量不稳定 | 有时生成错误代码 | 优化 System Prompt |
| ~~无代码编辑器~~ | ~~无法手动修改生成代码~~ | ✅ 已集成 Monaco Editor |

---

## 七、待办清单

### 已完成 ✅

- [x] 集成 Remotion Player
- [x] 创建预设模板（文字揭示、Logo 动画、粒子波浪）
- [x] 实现参数化控制面板
- [x] 集成 Babel standalone 动态编译
- [x] 创建 AI 生成面板
- [x] 实现 Remotion System Prompt
- [x] 添加示例 Prompts
- [x] 错误处理和重试机制
- [x] 添加 Matrix 代码雨模板
- [x] 添加 Glitch 故障文字模板
- [x] 添加打字机效果模板
- [x] 添加柱状图动画模板
- [x] 集成 Monaco Editor 代码编辑器
- [x] 代码高亮显示
- [x] 代码复制功能
- [x] 可编辑代码并重新运行

### 未来增强 📋

- [ ] **AI 增强**
  - [ ] 优化 System Prompt 提高生成质量
  - [ ] 添加代码修复能力
  - [ ] 支持多轮对话调整效果

- [ ] **更多模板**
  - [ ] 环形进度条
  - [ ] 倒计时器
  - [ ] 文字翻转效果
  - [ ] 图片轮播

- [ ] **导出功能** (需后端支持)
  - [ ] 导出 MP4 视频
  - [ ] 导出 GIF 动图
  - [ ] 导出代码模板

- [ ] **高级特性**
  - [ ] 时间轴编辑
  - [ ] 多场景切换
  - [ ] 音频同步
  - [ ] 自定义视频尺寸和帧率

---

## 八、用户故事

### 故事 1：使用预设模板快速创建 Matrix 代码雨效果

**角色**：内容创作者小王
**场景**：需要为短视频片头制作一个黑客帝国风格的代码雨效果

#### 操作步骤

```
步骤 1: 进入视频实验室
────────────────────────
路径: 侧边栏 → 实验室 → 视频实验室 Tab

┌─────────────────────────────────────────────────────────┐
│  实验室                                                 │
├─────────┬─────────┬─────────┬─────────────────────────┤
│ 试验车间 │ 大模型  │ 桌面    │ 视频实验室 ← 点击这里    │
└─────────┴─────────┴─────────┴─────────────────────────┘
```

```
步骤 2: 选择预设模板模式
────────────────────────
确认顶部模式切换器显示"预设模板"（默认）

┌─────────────────────────────────────────────────────────┐
│  [预设模板]  [AI 生成]                                   │
│      ↑                                                   │
│    当前选中                                              │
└─────────────────────────────────────────────────────────┘
```

```
步骤 3: 选择 Matrix 代码雨模板
──────────────────────────────
在左侧模板列表中点击"Matrix 代码雨"

┌────────────────────┬────────────────────────────────────┐
│ 选择模板           │                                    │
│ ┌────────────────┐ │                                    │
│ │ 文字揭示       │ │        ┌─────────────────────┐     │
│ │ Logo 动画      │ │        │                     │     │
│ │ 粒子波浪       │ │        │   ア カ サ          │     │
│ │ ▶ Matrix 代码雨│ │        │     ナ   マ         │     │
│ │ 故障文字       │ │        │   ワ   ヤ   ハ      │     │
│ │ 打字机         │ │        │                     │     │
│ │ 柱状图         │ │        │   [Remotion Player] │     │
│ └────────────────┘ │        └─────────────────────┘     │
│                    │                                    │
│ 参数配置           │                                    │
│ ┌────────────────┐ │                                    │
│ │ 字符颜色: #00ff00│ │                                  │
│ │ 背景色: #000000 │ │                                   │
│ │ 列数: 30        │ │                                   │
│ │ 速度: 1.5       │ │                                   │
│ └────────────────┘ │                                    │
└────────────────────┴────────────────────────────────────┘
```

```
步骤 4: 调整参数
────────────────
修改参数值，右侧预览实时更新

参数调整示例：
  字符颜色: #00ff00 → #00ffff (改为青色)
  列数: 30 → 50 (更密集)
  速度: 1.5 → 2.0 (更快)

预览自动刷新，无需点击任何按钮
```

```
步骤 5: 播放预览
────────────────
点击 Player 底部的播放按钮观看完整动画

┌─────────────────────────────────────────┐
│                                         │
│         [动画内容区域]                   │
│                                         │
├─────────────────────────────────────────┤
│  ▶ ──────●────────── 00:01 / 00:03     │
│     播放进度条                          │
└─────────────────────────────────────────┘
```

#### 预期结果

- 看到日文片假名字符从屏幕顶部向下飘落
- 字符呈现指定的颜色（默认绿色）
- 动画循环播放 3 秒

---

### 故事 2：使用 AI 生成模式创建自定义动画

**角色**：设计师小李
**场景**：想要一个独特的呼吸灯效果，但不想写代码

#### 操作步骤

```
步骤 1: 切换到 AI 生成模式
─────────────────────────
点击顶部的"AI 生成"按钮

┌─────────────────────────────────────────────────────────┐
│  [预设模板]  [AI 生成] ← 点击切换                        │
└─────────────────────────────────────────────────────────┘
```

```
步骤 2: 选择示例或输入描述
─────────────────────────
方式 A: 点击示例卡片快速开始
方式 B: 在输入框中输入自定义描述

┌─────────────────────────────────────────────────────────┐
│ 示例:                                                   │
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │
│ │ Matrix 代码雨 │ │ Glitch 故障 │ │ 呼吸灯效果   │     │
│ └──────────────┘ └──────────────┘ └──────────────┘     │
│                                                         │
│ 或输入自定义描述:                                        │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 创建一个霓虹灯风格的文字闪烁效果，文字是"NEON"      │ │
│ └─────────────────────────────────────────────────────┘ │
│                                      [生成动画]         │
└─────────────────────────────────────────────────────────┘
```

```
步骤 3: 等待 AI 生成
────────────────────
点击"生成动画"后，等待 LLM 流式返回代码

┌─────────────────────────────────────────────────────────┐
│ 生成中...                                               │
│                                                         │
│ export default function NeonText() {                    │
│   const frame = useCurrentFrame();                      │
│   const opacity = Math.sin(frame * 0.1) * 0.5 + 0.5;   │
│   ...                                                   │
│   █ ← 光标闪烁，代码逐行出现                            │
└─────────────────────────────────────────────────────────┘
```

```
步骤 4: 查看预览
────────────────
代码生成完成后，自动编译并在右侧显示预览

┌────────────────────────────┬────────────────────────────┐
│ 代码编辑器 (Monaco)        │ 预览                       │
│ ┌────────────────────────┐ │ ┌────────────────────────┐ │
│ │ // 可编辑代码          │ │ │                        │ │
│ │ export default function│ │ │      ✨ NEON ✨        │ │
│ │   ...                  │ │ │                        │ │
│ │ }                      │ │ │   [Remotion Player]   │ │
│ │                        │ │ │                        │ │
│ │ [复制] [运行]          │ │ └────────────────────────┘ │
│ └────────────────────────┘ │                            │
└────────────────────────────┴────────────────────────────┘
```

```
步骤 5: 手动调整代码（可选）
──────────────────────────
在 Monaco 编辑器中修改代码，点击"运行"按钮查看效果

修改示例：
  // 原代码
  const textColor = '#ff00ff';

  // 修改为
  const textColor = '#00ffff';  // 改为青色

点击 ▶ 运行按钮，预览实时更新
```

```
步骤 6: 复制代码
────────────────
点击"复制"按钮将代码复制到剪贴板，用于其他项目

┌────────────────────────────┐
│ ✓ 已复制到剪贴板           │
└────────────────────────────┘
```

#### 预期结果

- AI 生成可运行的 Remotion 代码
- 预览区展示生成的动画效果
- 可以手动修改代码并重新运行
- 可以复制代码用于其他项目

---

### 故事 3：处理 AI 生成错误

**角色**：开发者小张
**场景**：AI 生成的代码有语法错误

#### 操作步骤

```
步骤 1: AI 生成代码出错
──────────────────────
LLM 返回了有语法错误的代码

┌─────────────────────────────────────────────────────────┐
│ ❌ 编译错误                                             │
│                                                         │
│ SyntaxError: Unexpected token (line 15)                │
│                                                         │
│ [重试编译]                                              │
└─────────────────────────────────────────────────────────┘
```

```
步骤 2: 尝试重试编译
───────────────────
点击"重试编译"按钮，系统重新编译代码

如果仍然失败，可以：
  方式 A: 点击"重新生成"让 AI 重新生成
  方式 B: 在编辑器中手动修复错误后点击"运行"
```

```
步骤 3: 手动修复错误
───────────────────
在 Monaco 编辑器中定位并修复错误

┌────────────────────────────────────────┐
│ 15 |   return <div style={{           │ ← 错误行高亮
│ 16 |     background: 'red'            │
│ 17 |   }}>                            │ ← 少了逗号
│                                        │
│ 修复: 添加逗号                         │
│ 16 |     background: 'red',           │
└────────────────────────────────────────┘

点击 ▶ 运行，查看修复结果
```

#### 预期结果

- 错误信息清晰可见
- 可以重试或手动修复
- 修复后动画正常显示

---

## 九、相关资源

- [Remotion 官方文档](https://www.remotion.dev/docs/)
- [Remotion Player API](https://www.remotion.dev/docs/player)
- [Remotion Templates](https://www.remotion.dev/templates/)
- [Prompt to Motion Graphics](https://github.com/remotion-dev/template-prompt-to-motion-graphics)

---

## 变更记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-02-02 | v1.0 | 初始版本：预设模板 + AI 生成模式 |
| 2026-02-02 | v1.1 | 新增 4 个模板 (Matrix/Glitch/Typewriter/BarChart) + Monaco Editor 代码编辑器 |
| 2026-02-02 | v1.2 | 添加用户故事章节（预设模板流程、AI 生成流程、错误处理流程） |
