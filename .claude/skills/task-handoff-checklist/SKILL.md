---
name: task-handoff-checklist
description: 任务交接清单。AI 完成开发后，自动生成结构化交接报告，涵盖导航变更、文档沉淀、规则变化、测试计划、注意事项等维度，让验收者一目了然。触发词："交接"、"验收"、"干完了"、"handoff"、"checklist"、"/handoff"。
---

# Task Handoff Checklist — 任务交接清单

AI 完成开发任务后，自动扫描变更范围，生成一份结构化交接报告。让验收者不用追问就知道：改了哪里、测什么、沉淀了什么、有什么坑。

## 触发词

- "交接"、"交接清单"
- "验收"、"验收清单"
- "干完了"、"搞完了"、"做好了"
- "handoff"、"checklist"
- "/handoff"

## 核心理念

1. **零追问验收**：验收者拿到报告后，不需要再反复问"文档呢？测试呢？有什么要注意的？"
2. **强制全面扫描**：不是 AI 觉得重要才报，而是按清单逐项扫描，有就报，没有也要明确说"无"
3. **串联已有技能**：交接清单是入口，它会告诉你接下来该用哪些技能（smoke-test、human-verify 等）
4. **沉淀驱动**：每次交接都是一次知识沉淀的检查点

## 执行流程

### Phase 1: 扫描变更范围

```bash
# 1. 获取本次会话/分支的所有变更文件
git diff --name-only main...HEAD 2>/dev/null || git diff --name-only HEAD~10

# 2. 按目录分类
# prd-api/    → 后端变更
# prd-admin/  → 管理后台前端变更
# prd-desktop/ → 桌面端变更
# doc/        → 文档变更
# .claude/    → AI 技能/规则变更
# scripts/    → 脚本变更

# 3. 获取变更统计
git diff --stat main...HEAD 2>/dev/null || git diff --stat HEAD~10
```

### Phase 2: 逐项生成交接报告

按以下 **8 个维度** 逐项扫描并报告，每个维度必须给出明确结论，禁止跳过。

---

## 交接报告模板

```markdown
# 任务交接清单

> **任务描述**: {一句话概括本次任务}
> **变更范围**: {N} 个文件 | +{ins} / -{del} 行
> **涉及端**: {后端 / 管理后台 / 桌面端 / 文档}（列出所有涉及的端）

---

## 一、导航与入口变更 🧭

> 用户如何找到新功能/变更的功能？

| 维度 | 状态 | 详情 |
|------|------|------|
| 管理后台路由 | ✅ 新增 / 🔄 修改 / ➖ 无变化 | {具体路由路径} |
| 管理后台菜单 | ✅ 新增 / 🔄 修改 / ➖ 无变化 | {菜单位置和名称} |
| API 端点 | ✅ 新增 / 🔄 修改 / ➖ 无变化 | {端点列表} |
| 桌面端入口 | ✅ 新增 / 🔄 修改 / ➖ 无变化 | {入口位置} |

**操作路径**（新功能必填）:
1. {步骤 1: 从哪里进入}
2. {步骤 2: 点击什么}
3. {步骤 3: 看到什么}

---

## 二、文档沉淀 📝

> 文档是否跟上了代码变更？

| 检查项 | 状态 | 说明 |
|--------|------|------|
| SRS (2.srs.md) | ✅ 已更新 / ⚠️ 需要更新 / ➖ 无需更新 | {更新了什么 / 为什么需要更新} |
| PRD (3.prd.md) | ✅ 已更新 / ⚠️ 需要更新 / ➖ 无需更新 | {同上} |
| 数据字典 (rule.data-dictionary.md) | ✅ 已更新 / ⚠️ 需要更新 / ➖ 无需更新 | {新增/变更了哪些集合/字段} |
| 设计文档 (design.*.md) | ✅ 已创建 / ⚠️ 需要创建 / ➖ 无需创建 | {文档名称或理由} |
| CLAUDE.md Codebase Skill | ✅ 已更新 / ⚠️ 需要更新 / ➖ 无需更新 | {功能注册表/集合清单是否需要同步} |

**需要补充的文档清单**（如有）:
- [ ] {待补充文档 1}: {概述需要写什么}
- [ ] {待补充文档 2}: {概述需要写什么}

---

## 三、规则与约定 📏

> 本次变更是否产生了新的规则，或修改了现有规则？

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 新增 appKey | ✅ 是 / ➖ 否 | {appKey 名称，需同步 CLAUDE.md 和 rule.app-key-definition.md} |
| 新增 AppCallerCode | ✅ 是 / ➖ 否 | {Code 格式和用途} |
| 新增架构模式/约定 | ✅ 是 / ➖ 否 | {描述新模式，是否需要写成 rule.*.md} |
| 修改已有规则 | ✅ 是 / ➖ 否 | {哪条规则被修改，影响范围} |
| 新增 MongoDB 集合 | ✅ 是 / ➖ 否 | {集合名称，需同步数据字典} |
| 新增权限点 | ✅ 是 / ➖ 否 | {AdminPermissionCatalog 中的新权限} |

**需要沉淀的规则**（如有）:
- [ ] {规则内容}: 建议写入 {目标文件}

---

## 四、流程变更 🔄

> 现有流程是否被修改？影响谁？

| 检查项 | 状态 | 影响范围 |
|--------|------|----------|
| API 契约变更（Breaking Change） | ✅ 有 / ➖ 无 | {哪些端会受影响} |
| 数据模型变更 | ✅ 有 / ➖ 无 | {新增/删除/重命名了哪些字段} |
| 状态机变更 | ✅ 有 / ➖ 无 | {哪些状态转换被新增/修改/删除} |
| 前后端交互模式变更 | ✅ 有 / ➖ 无 | {例如：从轮询改为 SSE} |
| 权限/角色变更 | ✅ 有 / ➖ 无 | {哪些操作的权限要求变了} |
| 配置项变更 | ✅ 有 / ➖ 无 | {新增/修改了哪些环境变量或配置} |

**迁移/兼容注意事项**（如有 Breaking Change）:
- {迁移步骤或向后兼容处理说明}

---

## 五、测试计划 🧪

> 应该怎么测？测什么？顺序是什么？

### 5.1 测试矩阵

| 测试类型 | 是否需要 | 状态 | 说明 |
|----------|----------|------|------|
| 单元测试 | ✅ 需要 / ➖ 不需要 | ✅ 已完成 / ⚠️ 未完成 | {覆盖哪些类/方法，测试文件路径} |
| 冒烟测试 (API) | ✅ 需要 / ➖ 不需要 | ✅ 已完成 / ⚠️ 未完成 | {哪些端点需要测试} |
| 页面测试 (UI) | ✅ 需要 / ➖ 不需要 | ⚠️ 需人工测试 | {哪些页面需要验证} |
| 集成测试 | ✅ 需要 / ➖ 不需要 | ✅ 已完成 / ⚠️ 未完成 | {跨服务调用的测试} |
| 回归测试 | ✅ 需要 / ➖ 不需要 | ⚠️ 需人工测试 | {哪些现有功能可能受影响} |

### 5.2 推荐测试顺序

> 按依赖关系和风险程度排序，先测底层再测表层。

```
第 1 步: {测试类型} — {具体操作}
         ↓
第 2 步: {测试类型} — {具体操作}
         ↓
第 3 步: {测试类型} — {具体操作}
         ↓
第 4 步: {测试类型} — {具体操作}
```

### 5.3 页面测试步骤（如涉及 UI）

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | {打开页面 / 点击按钮 / 输入内容} | {看到什么 / 发生什么} |
| 2 | ... | ... |
| 3 | ... | ... |

### 5.4 技能串联建议

根据本次变更类型，推荐接下来使用的技能：

- [ ] **冒烟测试** → 说 "冒烟测试 {模块名}" 生成 curl 脚本
- [ ] **人工验证** → 说 "帮我检查" 进行多角度验证
- [ ] **修复 imports** → 说 "fix unused imports" 清理未使用的导入

---

## 六、注意事项与风险 ⚠️

> 有什么坑、边界情况、已知限制需要提醒？

### 6.1 已知限制

- {限制 1: 描述 + 影响 + 临时处理方案}
- {限制 2: ...}

### 6.2 潜在风险

- {风险 1: 发生条件 + 影响 + 规避方式}
- {风险 2: ...}

### 6.3 依赖项

- {外部依赖: 如第三方 API、特定环境变量、特定版本要求等}
- {内部依赖: 如其他模块的配合修改、数据库迁移等}

### 6.4 回滚方案

- {如果出问题，如何快速回滚？需要注意什么？}

---

## 七、代码质量自检 ✅

> 代码层面的自动检查结果

| 检查项 | 状态 |
|--------|------|
| 编译通过 (`dotnet build`) | ✅ / ❌ |
| 前端构建通过 (`pnpm run build`) | ✅ / ❌ / ➖ 无前端变更 |
| TypeScript 类型检查 (`pnpm tsc`) | ✅ / ❌ / ➖ 无前端变更 |
| Rust 检查 (`cargo check`) | ✅ / ❌ / ➖ 无桌面端变更 |
| 无未使用的导入/变量 | ✅ / ⚠️ 有待清理 |
| 遵循项目架构规则 | ✅ {逐项列出} |

**架构合规检查**:
- [ ] Controller 层身份隔离（appKey 硬编码，不由前端传递）
- [ ] LLM 调用通过 ILlmGateway（不直接调用底层客户端）
- [ ] 前端不维护业务映射（displayName 从后端获取）
- [ ] 服务器权威性设计（核心操作不受客户端断连影响）

---

## 八、后续事项 📋

> 还有什么没做完的、需要后续跟进的？

| 事项 | 优先级 | 说明 |
|------|--------|------|
| {后续事项 1} | P0/P1/P2 | {具体描述} |
| {后续事项 2} | P0/P1/P2 | {具体描述} |

---

**交接时间**: {当前日期时间}
**交接人**: AI Assistant
**验收人**: {用户}
```

---

## 各维度的扫描方法

### 维度一：导航与入口变更

```bash
# 检查管理后台路由变更
git diff main...HEAD -- "prd-admin/src/App.tsx" "prd-admin/src/pages/**" --name-only

# 检查 API 端点变更
git diff main...HEAD -- "prd-api/src/PrdAgent.Api/Controllers/**" --name-only

# 检查菜单变更
grep -rn "sidebar\|menu\|nav" prd-admin/src/ --include="*.tsx" | head -20

# 检查桌面端入口变更
git diff main...HEAD -- "prd-desktop/src/pages/**" "prd-desktop/src/components/**" --name-only
```

### 维度二：文档沉淀

```bash
# 检查本次是否有文档变更
git diff main...HEAD -- "doc/**" --name-only

# 检查是否有新的 MongoDB 集合（需要更新数据字典）
git diff main...HEAD -- "prd-api/src/PrdAgent.Infrastructure/Data/MongoDbContext.cs"

# 检查是否有新的 Controller（需要更新 SRS）
git diff main...HEAD -- "prd-api/src/PrdAgent.Api/Controllers/**" --name-only | grep -i "controller"

# 检查 CLAUDE.md 功能注册表是否需要更新
git diff main...HEAD -- "CLAUDE.md"
```

### 维度三：规则与约定

```bash
# 检查是否有新的 appKey
git diff main...HEAD | grep -i "appkey\|AppKey\|app-key"

# 检查是否有新的 AppCallerCode
git diff main...HEAD | grep -i "appcallercode\|AppCallerCode"

# 检查是否有新的权限定义
git diff main...HEAD | grep -i "AdminPermission\|PermissionCatalog"

# 检查是否有新的 MongoDB 集合定义
git diff main...HEAD | grep -i "GetCollection\|IMongoCollection"
```

### 维度四：流程变更

```bash
# 检查 DTO/Model 变更
git diff main...HEAD -- "prd-api/src/PrdAgent.Core/Models/**" --name-only

# 检查接口定义变更
git diff main...HEAD -- "prd-api/src/PrdAgent.Core/Interfaces/**" --name-only

# 检查前端 API 服务变更
git diff main...HEAD -- "prd-admin/src/services/**" --name-only
```

### 维度五：测试

```bash
# 检查是否有测试文件变更
git diff main...HEAD -- "**/*Test*" "**/*test*" "**/*spec*" --name-only

# 检查后端测试覆盖
find prd-api/ -name "*Tests.cs" -newer "$(git log -1 --format=%cd --date=iso)" 2>/dev/null

# 检查前端测试覆盖
find prd-admin/ -name "*.test.tsx" -o -name "*.test.ts" -o -name "*.spec.ts" 2>/dev/null
```

### 维度七：代码质量

```bash
# 后端编译检查
cd prd-api && dotnet build --no-restore 2>&1 | tail -5

# 前端类型检查
cd prd-admin && pnpm tsc --noEmit 2>&1 | tail -10

# 桌面端检查
cd prd-desktop/src-tauri && cargo check 2>&1 | tail -5
```

---

## 报告质量规则

### 必须遵循

1. **8 个维度全部覆盖**：即使某个维度全部是"无变化"，也要明确标出，不能跳过
2. **测试顺序必须给出**：不能只说"需要测试"，必须给出先后顺序和具体步骤
3. **页面测试步骤必须可操作**：写清"打开哪个页面 → 点击什么 → 期望看到什么"
4. **文档欠债必须列出**：如果本次没更新但应该更新的文档，明确列出待办
5. **风险必须诚实**：不能为了好看而隐藏已知问题，已知限制必须如实说明

### 禁止

1. **禁止空话**：不能写"测试一下就行"，必须写"用冒烟测试技能测试 XXX 模块的 YYY 端点"
2. **禁止遗漏破坏性变更**：任何 API 契约变更、字段重命名、行为改变必须在维度四明确标出
3. **禁止跳过代码质量检查**：编译、类型检查是最基本的，必须实际运行并报告结果
4. **禁止模糊的后续事项**：每个后续事项必须有优先级和可操作的描述

---

## 简化验收流程

交接清单的核心价值是把验收流程从"追问式"变成"核对式"：

```
【旧流程 — 追问式】
AI: "做完了"
你: "改了哪里？"
AI: "改了 XXX"
你: "文档呢？"
AI: "没更新"
你: "需要测试吗？"
AI: "可能需要"
你: "怎么测？"
AI: "..."
（反复 5-10 轮追问）

【新流程 — 核对式】
AI: "做完了，交接清单如下：[完整报告]"
你: 扫一遍 8 个维度 → 对不放心的维度深入
     → 说 "冒烟测试 XXX" 跑接口
     → 说 "帮我检查" 做多角度验证
     → 确认文档待办后安排补充
（1 轮核对 + 按需深入）
```

---

## 与其他技能的协作关系

```
任务完成
  │
  ▼
"交接" → 【交接清单技能】 → 生成完整报告
  │
  ├─ 维度五（测试）建议 → "冒烟测试 {模块}" → 【冒烟测试技能】
  │
  ├─ 维度七（质量）发现问题 → "fix unused imports" → 【修复导入技能】
  │
  ├─ 深入验证需求 → "帮我检查" → 【人工验证技能】
  │
  └─ 周末收尾 → "生成周报" → 【周报技能】
```

---

## 实际示例

### 示例：完成"新增缺陷管理 Agent"后的交接清单

```markdown
# 任务交接清单

> **任务描述**: 新增缺陷管理 Agent，支持缺陷模板管理和缺陷提交
> **变更范围**: 42 个文件 | +3,200 / -120 行
> **涉及端**: 后端 / 管理后台

---

## 一、导航与入口变更 🧭

| 维度 | 状态 | 详情 |
|------|------|------|
| 管理后台路由 | ✅ 新增 | `/defect-agent/templates`, `/defect-agent/reports` |
| 管理后台菜单 | ✅ 新增 | 侧边栏 → "缺陷管理" 下新增"模板管理"和"缺陷列表" |
| API 端点 | ✅ 新增 | `POST/GET/PUT/DELETE /api/defect-agent/templates`, `POST /api/defect-agent/reports` |
| 桌面端入口 | ➖ 无变化 | 本次不涉及桌面端 |

**操作路径**:
1. 登录管理后台 → 侧边栏点击"缺陷管理"
2. 点击"模板管理" → 可以创建/编辑缺陷模板
3. 点击"缺陷列表" → 可以查看已提交的缺陷报告

---

## 二、文档沉淀 📝

| 检查项 | 状态 | 说明 |
|--------|------|------|
| SRS | ⚠️ 需要更新 | 需新增缺陷管理 API 契约（端点、DTO、错误码） |
| PRD | ⚠️ 需要更新 | 需新增缺陷管理功能描述和用户场景 |
| 数据字典 | ⚠️ 需要更新 | 新增 defect_templates、defect_reports、defect_messages 三个集合 |
| 设计文档 | ✅ 已创建 | doc/20.defect-agent.md, doc/21.defect-agent-product.md |
| CLAUDE.md | ⚠️ 需要更新 | 功能注册表需添加"缺陷管理 Agent"条目，集合清单需添加 3 个新集合 |

**需要补充的文档清单**:
- [ ] 2.srs.md: 新增缺陷管理 API 接口规格
- [ ] 3.prd.md: 新增缺陷管理功能描述
- [ ] rule.data-dictionary.md: 新增 3 个集合的字段定义
- [ ] CLAUDE.md: 更新功能注册表和集合清单

---

## 三、规则与约定 📏

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 新增 appKey | ✅ 是 | `defect-agent`，已在 Controller 硬编码 |
| 新增 AppCallerCode | ✅ 是 | `defect-agent.analyze::intent` 用于意图识别 |
| 新增架构模式 | ➖ 否 | 复用现有 Run/Worker 模式 |
| 修改已有规则 | ➖ 否 | |
| 新增 MongoDB 集合 | ✅ 是 | defect_templates, defect_reports, defect_messages |
| 新增权限点 | ✅ 是 | DefectAgent.Templates.Manage, DefectAgent.Reports.View |

---

## 四、流程变更 🔄

| 检查项 | 状态 | 影响范围 |
|--------|------|----------|
| API 契约变更 | ➖ 无 | 全部是新增端点，不影响现有 API |
| 数据模型变更 | ➖ 无 | 新增模型，不修改现有模型 |
| 状态机变更 | ➖ 无 | |
| 前后端交互变更 | ➖ 无 | |
| 权限变更 | ✅ 有 | 管理员默认拥有新增权限，其他角色需手动分配 |
| 配置项变更 | ➖ 无 | |

---

## 五、测试计划 🧪

### 5.1 测试矩阵

| 测试类型 | 是否需要 | 状态 | 说明 |
|----------|----------|------|------|
| 单元测试 | ✅ 需要 | ✅ 已完成 | DefectAgentTests (25 tests)，覆盖模板 CRUD 和报告提交 |
| 冒烟测试 | ✅ 需要 | ⚠️ 未完成 | 需测试模板 CRUD + 缺陷提交 + 消息追加 |
| 页面测试 | ✅ 需要 | ⚠️ 需人工 | 模板管理页 + 缺陷列表页 |
| 回归测试 | ➖ 不需要 | | 新功能，不影响现有功能 |

### 5.2 推荐测试顺序

第 1 步: 单元测试 — `cd prd-api && dotnet test --filter DefectAgent`
         ↓
第 2 步: 冒烟测试 — 说 "冒烟测试 defect-agent" 生成 curl 脚本
         ↓
第 3 步: 页面测试 — 按下方步骤手动验证 UI
         ↓
第 4 步: 权限测试 — 用非管理员账号验证权限控制

### 5.3 页面测试步骤

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 打开管理后台 → 缺陷管理 → 模板管理 | 看到模板列表页，空状态提示"暂无模板" |
| 2 | 点击"创建模板" → 填写名称和字段 → 保存 | 模板创建成功，列表中出现新模板 |
| 3 | 点击模板行 → 编辑 → 保存 | 修改成功，列表数据更新 |
| 4 | 打开缺陷列表 → 新建缺陷 → 选择模板 → 提交 | 缺陷创建成功，列表中出现新缺陷 |

---

## 六、注意事项与风险 ⚠️

### 6.1 已知限制
- 缺陷消息暂不支持图片附件，计划在 v2 迭代中加入
- 模板字段仅支持文本和单选类型，复杂字段类型待后续扩展

### 6.2 潜在风险
- 无

### 6.3 依赖项
- 需要 MongoDB 集合自动创建（首次写入时自动创建，无需手动建表）
- 意图识别依赖 LLM Gateway 可用

---

## 七、代码质量自检 ✅

| 检查项 | 状态 |
|--------|------|
| 编译通过 | ✅ |
| 前端构建通过 | ✅ |
| TypeScript 类型检查 | ✅ |
| 无未使用的导入 | ✅ |
| 遵循架构规则 | ✅ |

**架构合规检查**:
- [x] Controller 硬编码 AppKey = "defect-agent"
- [x] LLM 调用通过 ILlmGateway
- [x] 前端 displayName 从后端获取
- [x] 服务器权威性设计（缺陷分析不受客户端断连影响）

---

## 八、后续事项 📋

| 事项 | 优先级 | 说明 |
|------|--------|------|
| 更新 SRS/PRD 文档 | P1 | 新增缺陷管理 API 规格和功能描述 |
| 更新数据字典 | P1 | 新增 3 个集合的字段定义 |
| 更新 CLAUDE.md | P1 | 同步功能注册表和集合清单 |
| 缺陷消息支持图片 | P2 | 待 v2 迭代 |

---

**交接时间**: 2026-02-27 14:30
**交接人**: AI Assistant
**验收人**: 待确认
```

---

## 注意事项

1. **时机**：在代码编写完成、编译通过后立即生成，不要等到用户追问
2. **诚实**：已知的限制和未完成的事项必须如实说明，不能为了"好看"而省略
3. **可操作**：每一条建议都必须是可以直接执行的（有命令、有步骤、有路径）
4. **不冗余**：如果某个维度确实没有变化，用"➖ 无变化"一行带过，不要废话
5. **串联技能**：主动推荐后续应该使用的技能，把验收流程串起来
